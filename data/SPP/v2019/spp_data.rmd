
## 2. Data Prep

```{r preamble data, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "setup.R"))
source(here::here("R", "spatial.R"))
```

### 2.1 Datasets with Sources
<br/>

**Species Presence, Observations and Red List Assessments**  
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/baltic_species/baltic_species.shp -->

To obtain data in shapefile format: downloaded, unzipped, opened (observations_final.gdb, observation_points layer) in QGIS, exported to shapefile

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Observations data ESRI Geodatabase (ZIP)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 9 March by Chester")
```

*These data are obtained from the HELCOM species database, compiled from original data sources: Shark SMHI, Species Observations System (Artportalen), MVM, and Entomological Collections (NHRS) from GBIF.*

<br>

**Red list (IUCN) information, about Species and their Assessment at HELCOM**  
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/species_with_redlist_category/species_with_redlist_category.csv -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Red list information data CSV")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 12 March by Ellie")
```

**Species ID, with taxanomic information for each species in HELCOM database**
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/species_with_redlist_category/species_with_redlist_category.csv --> TO EDIT!

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "species id HELCOM csv")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 4 April by Chester")
```

---

<br/>


### 2.2 Processing raw data into an easier format

#### 2.2.1 Set directory of raw data

Notes: Commands labelled "Edit 1" to be removed at final polish, added now due to lack of access to Gunvor

```{r load raw data, message = FALSE, echo = TRUE, warning = FALSE, results = "hide"}
## root location of the raw data
# dir_B <- "C:/Users/chest/Downloads"  # Edit 1 Tablet
dir_B <- "C:/Users/Chester Gan/Desktop" # Edit 1 Laptop
dir_rawdata <- file.path(dir_B)      # Edit 1
#dir_rawdata <- file.path(dir_B, "Goals", "BD")
```

#### 2.2.2 Adding regional data into dataset

**Remove spatial 'depth' dimension, and assign BHI Region IDs**

```{r remove z spatial dimension and assign BHI region ids}
## read in raw data
## need to rename columns, as names were shortened when exported to shapefile...
spp_raw <- sf::st_read(file.path(dir_rawdata, "raw_species_observations")) %>%
   dplyr::rename(
    scientific_name = scientific, 
    accepted_name = accepted_n, 
    species_group = species_gr, 
    sampling_group = sampling_g,
    red_list_assessments = red_list_a,
    year_collected = year_colle
  ) %>% 
  st_drop_geometry()

# dir_B <- "C:/Users/chest/OneDrive/Documents/Thesis/Github/Shapefiles"  # Edit 1 Tablet
dir_B <- "C:/Users/Chester Gan/OneDrive/Documents/Thesis/Github/Shapefiles" # Edit 1 Laptop

buffer_sf <- st_read(
  file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"), 
  "BHI_shapefile_25km_buffer"
)

rgns <- join_rgns_info(
  spp_raw %>% select(OBJECTID, decimal_la, decimal_lo),
  latlon_vars = c("decimal_la", "decimal_lo"),
  return_spatial = FALSE,
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
  buffer_shp = buffer_sf
)

spp_w_rgns <- left_join(
    rename(rgns, OBJECTID = objectid), 
    spp_raw,
    by = c("OBJECTID", "decimal_la", "decimal_lo")
)

write_csv(spp_w_rgns, file.path(dir_rawdata, "species_obs_w_rgns.csv"))
```
#### 2.2.3 Save to BHI Database

```{r save species data}
#if(!file.exists(file.path(dir_rawdata, "baltic_species"))){
 # dir.create(file.path(dir_rawdata, "baltic_species"))
#}
#sf::st_write(spp_w_rgns, file.path(dir_rawdata, "baltic_species", "baltic_species.shp"))
```

<br/>

### 2.3 Checking Raw Data

```{r read in data}

# Observations Data

raw_obs_checklist <- data.table::fread(file.path(dir_rawdata, "species_obs_w_rgns.csv"), stringsAsFactors = FALSE)

# Redlist Data

redlist <- read.csv(file.path("C:/Users/Chester Gan/Downloads", "species_with_redlist_category.csv"), sep= ";", stringsAsFactors = FALSE) %>%
  dplyr::rename(scientific_name = species_scientific_name) %>%
  select(-id) # Remove redundant id column

# Species list (all taxa)

helcom_list_all_taxa <- read.csv(file.path("C:/Users/Chester Gan/Downloads", "species.csv"), sep= ";", stringsAsFactors = FALSE)

```


#### 2.3.1 Taxa Represented 

```{r Check Taxa}

# Check representation of taxa

raw_obs_checklist %>%
  select(species_group) %>%
  distinct()  # Benthic Invertebrates, Fish and Lamprey, Macrophytes, Zooplankton, Bacteria, Phytoplankton, Mammals and Birds

# Check number of species within each taxa

raw_obs_checklist %>%
  group_by(species_group) %>%
  count()

ggplot(raw_obs_checklist, aes(x=species_group))+
   geom_bar(stat="count")+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Number of species in raw checklist")

## Number of unique latin names 
raw_obs_checklist %>% select(scientific_name)%>%distinct()%>%nrow() #2958 (Including Bacteria and Plankton)

```


#### 2.3.2 BHI ID and Basins

```{r create list BHI ID and Basins}

# Matching BHI ID to subbasins

basin_ID_namelist <- raw_obs_checklist %>%
  select(BHI_ID, Subbasin) %>%
  na.omit() %>%
  distinct() %>%
  arrange(.,BHI_ID)

# To see how many distinct basins represented

basins_distinct <- raw_obs_checklist %>% 
  select(Subbasin) %>% 
  na.omit() %>%
  distinct()

nrow(basins_distinct)  #17 basins -> Correct number

```

<br/>

### 2.4 Initial Data Organization

#### 2.4.1 Removing Unnecessary Columns, Bacteria and Plankton, rows without basin location data as well as all observations before 2016

```{r remove bacteria plankton <2016}

full_obs_checklist_2016 <- raw_obs_checklist %>%
  select(
    species_id,
    scientific_name,
    taxonomica,
    accepted_name,
    synonyms,
    species_group,
    year_collected,
    red_list_assessments,
    rgn_nam,
    Subbasin,
    BHI_ID
  ) %>%
  filter(!species_group %in% c("Bacteria", "Phytoplankton", "Zooplankton")) %>%
  filter(!is.na(Subbasin)) %>%
  mutate(list_type = "checklist")


# Checking filter

full_obs_checklist_2016 %>%
  group_by(species_group) %>%
  count()

sum(is.na(full_obs_checklist_2016$rgn_nam)) #0 -> NA entries have been filtered out and there are no NAs in rgn_nam

# Number of unique species names

full_obs_checklist_2016 %>% select(scientific_name)%>%distinct()%>%nrow() #2443

```

#### 2.4.2 Separating Insects from Other Taxa

Due to similar concerns as those raised in BHI 1.0, insect species in the current dataset needed to be summarized to family level before being scored. For convenience, insect species were first separated to be wrangled separately from other taxa.

Two approaches were considered in order to check current dataset for insect species. Ultimately, approach 2 (with HELCOM species data) was considered more robust and selected for use. 

```{r separate insects}

# Insect Check

# Approach 1: Use invert data set in 2015 to check for common insect species with current dataset

invert_insect_2015 <- read.csv(file.path("C:/Users/Chester Gan/OneDrive/Documents/Thesis/Github/baltic2015/prep/SPP/data_checklist_redlist", "invert_dist_checklist_alltaxalevels.csv"), sep= ";", stringsAsFactors = FALSE) %>%  # TO EDIT WITH BHI Filepath
  select(class, latin_name) %>%
  filter(class == "Insecta") %>%
  dplyr::rename(scientific_name = latin_name) %>%
  mutate(list_type = "2015")


insect_check <- intersect(unique(full_obs_checklist_2016$scientific_name), unique(invert_insect_2015$scientific_name))

length(insect_check)  # 213 unique insect species, need to summarise insects to family level

# Approach 2: Use HELCOM species id list to identify insect species with current dataset 

helcom_insect_list <- helcom_list_all_taxa %>%
  select(scientific_name, id, class, family) %>%
  dplyr::rename(species_id = id) %>%
  filter(class == "Insecta")

helcom_insect_check <- intersect(unique(full_obs_checklist_2016$scientific_name), unique(helcom_insect_list$scientific_name))

length(helcom_insect_check) #236 unique insect species, need to summarise to family level

# Separating Insect data from other taxa (Using info from Approach 2)

obs_checklist_insect <- full_obs_checklist_2016 %>%
  filter(scientific_name %in% helcom_insect_check) %>%
   select(
    species_id, 
    scientific_name,
    taxonomica, 
    accepted_name, 
    synonyms, 
    species_group,
    Subbasin,
    list_type)

obs_checklist_no_insect <- full_obs_checklist_2016 %>%
  filter(!scientific_name %in% helcom_insect_check) %>%
   select(
    species_id, 
    scientific_name,
    taxonomica, 
    accepted_name, 
    synonyms, 
    species_group,
    Subbasin,
    list_type)

```

<br/>

### 2.5 Data Prep for all other taxa (except Insecta) 

#### 2.5.1 Instituting threshold for presence

Observation data needs to be given a threshold for species to be considered present. This is to avoid any rare occurrences of an individual being mistaken for species establishment. Based on the solution proposed in BHI 1.0, species will only be considered present when there at least 10 observations in each BHI region.

Only species that are present are being scored as current data set only consists of observations and it will be too inaccurate to assume lack of observations = absence of species. Check BHI issues for full account of this problem.

```{r presence threshold no_insect species data}

# Summarize number of observations per species per Subbasin region

species_obs_count_no_insect <- obs_checklist_no_insect %>%
  group_by(species_id, scientific_name, Subbasin) %>%
  summarise(count = n()) 

# Filter those with >= 10 observations and add presence column

species_obs_present_no_insect <- species_obs_count_no_insect %>%
  filter(count >= 10) %>%
  mutate(presence = "1") %>%
  select(-count) # remove count column to prep for list joining

# Join with main observation list to show presence/absence

species_checklist_no_insect <- obs_checklist_no_insect %>%
  distinct() %>% # To collapse all obs to 1 per species per Subbasin region
  left_join(.,species_obs_present_no_insect) %>%
  filter(presence == "1") %>%
  arrange(.,scientific_name) %>%
  select(-presence) # remove presence column as only presence data being considered in BHI 1.0

# Number of unique present species (excluding insects)

species_checklist_no_insect %>% select(scientific_name) %>% distinct() %>% nrow() #1312

```

#### 2.5.2 Read in Redlist and get Data Attributes

```{r redlist info}

# Number of species in redlist

redlist %>% select(scientific_name) %>% distinct() %>% nrow()  #2771

# Plot number of species in redlist per taxa group

helcom_speciesgroup <- helcom_list_all_taxa %>% 
  select(scientific_name, species_group)

redlist <- left_join(redlist, helcom_speciesgroup) %>%
  arrange(.,species_group)


ggplot(redlist, aes(x=species_group))+
   geom_bar(stat="count")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Number of species in the redlist")

# Create list of species with duplicate assessments and duplicate entries in redlist

duplicate_redlist <- redlist %>% 
  select(scientific_name, red_list_category) %>% 
  distinct() %>% 
  select(scientific_name) %>% 
  arrange(., scientific_name) %>% 
  filter(duplicated(.)== TRUE)

duplicate_entry_redlist <- redlist %>% 
  select(scientific_name) %>% 
  arrange(., scientific_name) %>% 
  filter(duplicated(.)== TRUE)

# Check assessment years

redlist %>% select(assessment_year_red_list) %>% distinct()  #2007 and 2013

redlist %>% select(scientific_name, assessment_year_red_list) %>% distinct() %>% select(scientific_name) %>% filter(duplicated(.)==TRUE) # 171 species that have assessments in both 2007 and 2013

# Add list_type column

redlist <- redlist %>%
  mutate(list_type = "redlist")

```

#### 2.5.3 Getting Common Species List between Checklist and Redlist

Need to first join and retain all species in order to check for possible spelling mismatches. After correcting possible spelling errors, retain only species that are in both lists.

##### 2.5.3.1 Full species list with all species retained

```{r full species list no insect}

full_species_no_insect <- full_join(species_checklist_no_insect, redlist, by = c("species_id","scientific_name", "species_group"))

dim(full_species_no_insect) # 6479 rows

```

##### 2.5.3.2 Checking checklist species that are not on redlist

Initially, this check was made in order to maximise the number of species that can be analyzed by ensuring no species were excluded due to spelling errors that was incompatible with the redlist. However, the number of species that were not assessed in the redlist was too many to look through. Further, as both the checklist and redlist were compiled by HELCOM, it is unlikely that the databases were unsynchronised. A check was made in the following section of code to ensure this.

```{r species checklist not redlist no insect}

# Species list on checklist and not redlist

full_species_no_insect %>% select(-Subbasin) %>% distinct() %>% filter(is.na(list_type.y)) # 338 species
full_species_no_insect %>% filter(is.na(list_type.y)) %>% select(species_group) %>% distinct() # Inverts, Macrophytes, Birds and Mammals

# Check that species_id and scientific name distinct sets for redlist and obs can full join without duplicates of species id

raw_check <- raw_obs_checklist %>%
  select(species_id, scientific_name) %>%
  distinct() #2958, same as earlier check on unique species

raw_check %>% select(species_id) %>% filter(duplicated(.)==TRUE) # 0 rows so no duplicate species IDs

redlist_check <- redlist %>%
  select(species_id, scientific_name) %>%
  distinct()

redlist_check %>% select(species_id) %>% filter(duplicated(.)==TRUE) # 0 rows so no duplicate species IDs

species_check <- full_join(raw_check, redlist_check) %>%
  distinct()

species_check %>% select(species_id) %>% filter(duplicated(.)==TRUE) # 32 duplicates but all show no real difference?! Ask Ellie

```

##### 2.5.3.3 Checking redlist species that are not on checklist

```{r species redlist not checklist no insect}

# Species list on redlist and not checklist

full_species_no_insect %>% select(-Subbasin) %>% distinct() %>% filter(is.na(list_type.x)) %>% nrow() # 1974 species
full_species_no_insect %>% filter(is.na(list_type.x)) %>% select(species_group) %>% distinct() # Inverts, Fish, Macrophytes, Birds and Mammals

```

##### 2.5.3.4 Shared Species List

Duplicate assessments were found for 5 species in the shared species list. Upon inspection, duplicate assessments were found to be based off on wintering and breeding statuses. To resolve this, decision was made to take the threat assessment of breeding birds for each species.

Duplicate entries with same assessment across different assessment years was also found for 1 species. This was resolved by deleting the older assessment. This section needs to be fixed with new approach using entire obs database.

```{r shared species no insect}

# Species list that is on both checklists

shared_species_no_insect = full_species_no_insect %>%
                  filter(!is.na(list_type.x) & !is.na(list_type.y))

# Check number of species

shared_species_no_insect %>% select(scientific_name) %>% distinct() # 974 species

# Check if there are duplicate assessments (species with more than one threat level assessment)

intersect(unique(shared_species_no_insect$scientific_name), unique(duplicate_redlist$scientific_name)) # 11 species Aythya fuligula, Aythya marila, Melanitta fusca, Mergus serrator, Somateria mollissima

shared_species_no_insect %>% select(-Subbasin) %>% distinct() %>% filter(scientific_name == "Aythya fuligula" | scientific_name== "Aythya marila" | scientific_name=="Melanitta fusca" | scientific_name=="Mergus serrator" | scientific_name == "Somateria mollissima") # Shows that the duplicate assessment are on 5 bird species that are based off wintering and breeding categories

# Substitute threat assessment of breeding birds for each species with duplicate assessments

shared_species_no_insect <- shared_species_no_insect %>%
                 mutate(red_list_category = ifelse(scientific_name == "Aythya fuligula", "NT - Near Threatened",
                                            ifelse(scientific_name == "Aythya marila", "VU - Vulnerable",
                                            ifelse(scientific_name == "Melanitta fusca" , "VU - Vulnerable",
                                            ifelse(scientific_name == "Mergus serrator", "LC - Least Concern",
                                            ifelse(scientific_name == "Somateria mollissima", "VU - Vulnerable", red_list_category)))))) %>%
                 select(-remarks) %>%
                 distinct()

# Recheck for duplicate assessments

shared_species_no_insect %>% select(scientific_name, red_list_category) %>% distinct() %>% nrow() # 295, same as no. of species

# Check for duplicate entries

duplicate_entry_check <- intersect(unique(shared_species_no_insect$scientific_name), unique(duplicate_entry_redlist$scientific_name)) 

shared_species_no_insect %>% filter(scientific_name %in% duplicate_entry_check) # Found that Platichthys flesus had same assessment category but two entries as done over both 2007 and 2013

# Remove 2007 assessment of Platichtys flesus

shared_species_no_insect <- shared_species_no_insect %>%
  filter(!(scientific_name == "Platichthys flesus" & assessment_year_red_list == "2007"))

```

<br/>

### 2.6 Data Prep for Insecta

Insects are more complicated due to uncertainty of taxonomical classification. Hence, observations need to be summarized to the family level before instituting a presence threshold of at least 10 observations. The highest threat status then needs to be applied for entire family. Rare species will be excluded from the analysis. Highest threat level should be taken from the entire redlist rather than just the species that appear in the observations list.

#### 2.6.1 Redlist Data Prep: Summarise Insects to Family Level and Use Highest Threat Status for Family

```{r redlist insects summarise family level}

# Obtain insect subset of redlist

redlist_insect_species_assessment <- redlist %>%
  filter(scientific_name %in% unique(helcom_insect_list$scientific_name)) # 365 unique species

# Check for duplicate entries

intersect(unique(redlist_insect_species_assessment$scientific_name), unique(duplicate_entry_redlist$scientific_name)) #Cladotanytarsus mancus

redlist_insect_species_assessment %>% filter(scientific_name == "Cladotanytarsus mancus") # Difference in remarks column, rectify in next step

# Add family to each species using helcom_insect_list

redlist_insect_species_assessment <- left_join(redlist_insect_species_assessment, select(helcom_insect_list, -class), by = c("scientific_name", "species_id")) %>%
  select(-remarks) %>%
  distinct() # Removed duplicate

# Assign highest threat level for family to each species

redlist %>% select(red_list_category) %>% distinct() # To check all categories

redlist_rank <- data.frame(red_list_category =  c("NE - Not Evaluated", "NA - Not Applicable", "DD - Data Deficient",  "RA - Rare", "TM - Threatened Migrant", "LC - Least Concern", "NT - Near Threatened", "VU - Vulnerable", "EN - Endangered", "CR - Critically Endangered", "RE - Regionally Extinct"), num_rank = c(1,2,3,4,5,6,7,8,9,10,11)) # Ranks 1-5 will be excluded but included here in ranking to be able to differentiate

redlist_insect_family_assessment <- redlist_insect_species_assessment %>% 
  left_join(redlist_rank) %>%
  group_by(family) %>%
  mutate(maxrank = max(num_rank, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(rename(redlist_rank, family_category = red_list_category, maxrank = num_rank), by = "maxrank") %>%
  select(family, 
         family_category, 
         assessment_year_red_list, 
         species_group, 
         list_type) %>%
  distinct() %>%
  rename(red_list_category = family_category)

```
 
#### 2.6.2 Summarize Observations Database to Family Level and Institute Presence Threshold

```{r insects observations summarise family presence threshold}

# Add family information to insects observations checklist

obs_checklist_insect_family <- left_join(obs_checklist_insect, select(helcom_insect_list, -class))

# Summarize number of observations per family per Subbasin region

family_obs_count_insect <- obs_checklist_insect_family %>%
  group_by(family, Subbasin) %>%
  summarise(count = n()) 

# Filter those with >= 10 observations and add presence column

family_obs_present_insect <- family_obs_count_insect %>%
  filter(count >= 10) %>%
  mutate(presence = "1") %>%
  select(-count) # remove count column to prep for list joining

# Join with main observation list to show presence/absence

family_checklist_insect <- obs_checklist_insect_family %>%
  select(family,
         species_group,
         Subbasin,
         list_type) %>% # remove species data
  distinct() %>% # collapse all obs to 1 per family per Subbasin region
  left_join(.,family_obs_present_insect) %>%
  filter(presence == "1") %>%
  arrange(.,family) %>%
  select(-presence) # remove presence column as only presence data being considered in BHI 1.0

# Number of unique families (only insects)

family_checklist_insect %>% select(family) %>% distinct() %>% nrow() #24

```

#### 2.6.3 Getting Shared Insect Family List between Checklist and Redlist

```{r}

shared_family_insect <- left_join(family_checklist_insect, redlist_insect_family_assessment, by = c("family", "species_group")) %>%
  filter(!is.na(list_type.x) & !is.na(list_type.y)) %>%
  rename(scientific_name = family)
  

dim(shared_family_insect) # 97 rows

```

<br/>

### 2.7 Combined Shared List And Initial Plots

```{r shared list plot by threat cat}

# Combining shared_species and shared_family

shared_list <- bind_rows(shared_species_no_insect,
                         shared_family_insect) %>%
  select(scientific_name,
         species_group,
         Subbasin,
         red_list_category,
         assessment_year_red_list) # Removed species-specific rows

dim(shared_list) # 3624 entries

# Plot by threat category

shared_list_threat_n = shared_list %>%
                       count(species_group,red_list_category)

ggplot(shared_list_threat_n, aes(x=species_group, y=n, fill=red_list_category)) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, hjust=.5, vjust=.5, face="plain"), axis.text.y = element_text(colour="grey20", size=6)) +
  ggtitle("Count of species in each IUCN category")

```

### 2.8 Export shared_list object

For use in ICO status calculation, does not contain red_list_category numeric. To check with Ellie if numeric score is needed and for exact file locations.

```{r export for use in ICO calculation}

# Write to two locations - SPP folder and ICO folder

write.csv(shared_list, file.path(dir_spp,'checklist_redlist_data_for_status.csv'),row.names=FALSE)  

write.csv(shared_list, file.path(dir_prep,'ICO/data_database/checklist_redlist_data_for_status.csv'),row.names=FALSE)

```

<br/>

### 2.9 Data Analysis

#### 2.9.1 Select Data for Analysis and Plot Excluded and Included Data

```{r exclude threat categories without score}

# Check threat categories in shared_list

shared_list %>% select(red_list_category) %>% distinct() # NE, NA and DD to be removed

# Save excluded species in separate object

shared_list_excluded <- shared_list %>%
  filter(red_list_category %in% c("DD - Data Deficient", "NE - Not Evaluated", "NA - Not Applicable"))

dim(shared_list_excluded) # 414 entries

# Plot excluded data

shared_list_excluded_n = shared_list_excluded %>%
                       count(species_group, red_list_category)

ggplot(shared_list_excluded_n, aes(x=species_group, y=n, fill=red_list_category))+
  geom_bar(stat="identity")+
  ggtitle("Count of excluded species ")

# New shared_list excluding DD, NA and NE threat categories

shared_list_included <- shared_list %>%
  filter(!red_list_category %in% c("DD - Data Deficient", "NE - Not Evaluated", "NA - Not Applicable"))

dim(shared_list_included) # 3210 (correct as = 3624 - 414)

# Plot included data (without DD, NA and NE) by species_group and red_list_category

shared_list_included_n = shared_list_included %>%
                       count(species_group, red_list_category)

ggplot(shared_list_included_n, aes(x=species_group, y=n, fill=red_list_category))+
  geom_bar(stat="identity")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of species in each IUCN category")

# Plot included data along with basin

shared_list_included_n_loc = shared_list_included %>%
                             count(Subbasin,species_group,red_list_category)%>%
                             ungroup()

ggplot(shared_list_included_n_loc, aes(x=species_group, y=n, fill=red_list_category))+
  geom_bar(stat="identity")+
  facet_wrap(~Subbasin, scales="free_y")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of species in each IUCN category")

```

#### 2.9.2 Plots by species_group and Subbasin

```{r plots species_group Subbasin}

## Plot species_group excluding threat category

shared_list_included_n_loc_no_category = shared_list_included %>%
                                         count(Subbasin, species_group) %>% 
                                         ungroup()

ggplot(shared_list_included_n_loc_no_category, aes(x=species_group, y=n))+
  geom_bar(stat="identity")+
  facet_wrap(~Subbasin)+
  #facet_wrap(~basin, scales="free_y")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of species by taxa group in each basin")

# Plot distribution for each species_group separately by subbasin & threat category

# Benthnic Invertebrates

## color to highlight Gulf of Finland

col_gof = rep(c(rep("black",9),"red",rep("black",7)),4)

ggplot(filter(shared_list_included_n_loc, species_group=="Benthic Invertebrates"))+
    # geom_point(aes(Subbasin, n), size=2.5, colour=col_gof)+
  facet_wrap(~red_list_category, scales="free_y")+
  ylab("Count of species")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of Benthic Invertebrate species in each IUCN category by Subbasin")

## limit the number of Subbasins

data_filtered_plot = shared_list_included_n_loc %>% filter(species_group=="Benthic Invertebrates")%>% filter(Subbasin %in% c("Bothnian Bay", "Bothnian Sea","Aland Sea","The Quark","Gulf of Finland"))

ggplot(data_filtered_plot)+
    geom_point(aes(Subbasin,n), size=2.5)+
  facet_wrap(~red_list_category, scales="free_y")+
  ylab("Count of species")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of Benthic Invertebrate species in each IUCN category Northern Subbasins")

# Birds

ggplot(filter(shared_list_included_n_loc, species_group=="Birds"))+
    geom_point(aes(Subbasin,n))+
  facet_wrap(~red_list_category, scales="free_y")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of Bird species in each IUCN category by Subbasin")

# Macrophytes

ggplot(filter(shared_list_included_n_loc, species_group=="Macrophytes"))+
    geom_point(aes(Subbasin,n))+
  facet_wrap(~red_list_category, scales="free_y")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of Macrophytes species in each IUCN category by Subbasin")

# Fish and Lampreys

ggplot(filter(shared_list_included_n_loc, species_group=="Fish and Lamprey"))+
    geom_point(aes(Subbasin,n))+
  facet_wrap(~red_list_category, scales="free_y")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of Fish and Lamprey species in each IUCN category by Subbasin")

# Mammals

ggplot(filter(shared_list_included_n_loc, species_group=="Mammals"))+
    geom_point(aes(Subbasin,n))+
  facet_wrap(~red_list_category, scales="free_y")+
   theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Count of Mammal species in each IUCN category by Subbasin")

```

#### 2.9.3 Assign BHI Vulnerability Score to Threat Categories

This step highlights a current issue with using just presence data. Regionally extinct and extinct species cannot be detected as they are not present.

```{r BHI score threat category}

# Create vulnerability lookup table

redlist %>% select(red_list_category) %>% distinct() # check all categories 

vuln_lookup <- shared_list_included %>%
  select(red_list_category) %>%
  distinct() %>%
  mutate(red_list_category_numeric = ifelse(red_list_category == 'EX - Extinct', 1,
                                     ifelse(red_list_category == 'RE - Regionally Extinct', 1,
                                     ifelse(red_list_category == 'CR - Critically Endangered', 0.8,
                                     ifelse(red_list_category == 'EN - Endangered', 0.6,
                                     ifelse(red_list_category == 'VU - Vulnerable', 0.4,
                                     ifelse(red_list_category == 'NT - Near Threatened', 0.2,
                                     ifelse(red_list_category == 'LC - Least Concern', 0, NA)))))))) # added all appropriate categories in case

vuln_lookup # Only LC, NT, VU, EN and CR

# Add vulnerability score to shared_list_included

shared_list_vuln <- left_join(shared_list_included, vuln_lookup)

dim(shared_list_vuln) # same no of rows, 1 extra column so correct

```

#### 2.9.4 Status Calculation by Subbasin with All Species Weighted Equally (Approach 1)

Data is portrayed on the HOLAS basin scale. Biodiversity status will be calculated by subbasin and then applied to BHI regions. Unlike BHI 1.0, current iteration considers birds as well as they have been designated locations.
*Note, this will mean that the data layer sent to layers and what is registered in layers.csv is very different than what is done if use the spatial data layers from HELCOM where status is directly calculated for BHI regions and this is done formally in functions.r*  

In Approach 1, a single calculation is made including all species. This result will be compared to Approach 2 where a calculation is made for each taxa group before taking the geometric mean (See Section 2.9.5). The comparison between the two approaches can be found in Section 2.9.6.

##### 2.9.4.1 Calculate status

```{r status calculation approach 1}

# Sum threat weights for each subbasin

sum_wi_basin <- shared_list_vuln %>%
                select(Subbasin,red_list_category_numeric) %>%
                dplyr::rename(weights = red_list_category_numeric) %>%
                group_by(Subbasin) %>%
                summarise(sum_wi =sum(weights)) %>%
                ungroup()

dim(sum_wi_basin) # 17 2

# Count number of species in each BHI region

sum_spp_basin <- shared_list_vuln %>%
                 select(Subbasin, scientific_name) %>%
                 dplyr::count(Subbasin)

dim(sum_spp_basin) # 17 2

# Check if species count code worked

shared_list_vuln %>% filter(Subbasin == "Aland Sea") %>% nrow() ## 43 rows

head(sum_spp_basin) # Aland Sea has 43 also

# Calculate status per Subbasin

spp_status_basin <- full_join(sum_wi_basin,sum_spp_basin, by="Subbasin") %>%
                    mutate(wi_spp = sum_wi/n,
                    status = 1 - wi_spp)

```

##### 2.9.4.2 Scale lower end to zero if 75% extinct

Currently, dataset only includes presence data so no way to tell percentage of extinct species. Code was left in to be adapted for future BHI iterations when data can differentiate between unsuitable species and species that become regionally extinct. If no subbasins have 75% extinct species, there should be no change.

```{r scale for 75 percent extinct for Subbasin}

# Filter regionally extinct species

spp_ex_basin <- shared_list_vuln %>%
                # Add code here to only consider species that are supposed to be present (suitable for habitat)
                dplyr::rename(weights = red_list_category_numeric) %>%
                filter(weights == 1) # Filters out regionally extinct species (supposed to be present but absent)
spp_ex_basin

# Identify regionally extinct species

spp_ex_basin %>% select(scientific_name) %>% distinct() 

# Number of extinct species per basin

spp_ex_basin_n <- spp_ex_basin %>%
                  select(Subbasin,scientific_name) %>%
                  dplyr::count(Subbasin) %>%
                  dplyr::rename(n_extinct = n)

# Join to spp_status_basin

spp_status_basin <- spp_status_basin %>%
                    full_join(.,spp_ex_basin_n, by="Subbasin") %>%
                    mutate(n_extinct = ifelse(is.na(n_extinct),0,n_extinct))

# calculate % extinct in each subbasin and assign status score of 0 if >75%

spp_status_basin <- spp_status_basin %>%
                    mutate(prop_extinct = n_extinct / n,
                           status = ifelse(prop_extinct >= 0.75, 0, status))

```

##### 2.9.4.3 Plot status by basin

```{r plot basin status}

# Plot status

ggplot(spp_status_basin) +
  geom_point(aes(Subbasin, round(status*100)), size=3) +
  ylim(0,100) +
  ylab("Status") + 
  xlab("Subbasin") +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6)) +
  ggtitle("SPP status by Subbasin")

# Size points based on number of species in a region

ggplot(spp_status_basin)+
  geom_point(aes(Subbasin, round(status*100), size=n)) +
  ylim(0,100) +
  ylab("Status") + 
  xlab("Subbasin") +
  scale_size(breaks =c(1200,1400,1600,1800), labels=c("1200","1400","1600","1800"))+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("SPP status by Subbasin, n= species richness")

```

#### 2.9.5 Status Calculation by Subbasin With Species Group and Regional Geometric Mean (Approach 2)

Status of subbasins was obtained by first calculating statuses according to species groups and taking the geometric mean for each basin. As with Approach 1, birds were not excluded.

##### 2.9.5.1 Calculate status by species group and plot

```{r species group status calculation}

# Sum threat weights for each subbasin by species_group
  
sum_wi_basin_species_group <- shared_list_vuln %>%
              select(Subbasin, species_group, red_list_category_numeric) %>%
              dplyr::rename(weights = red_list_category_numeric) %>%
              group_by(Subbasin, species_group) %>%
              summarise(sum_wi =sum(weights)) %>%
              ungroup()

dim(sum_wi_basin_species_group) # 52  3

# Count number of species in each subbasin by species group

sum_spp_basin_species_group <- shared_list_vuln %>%
                select(Subbasin, species_group, scientific_name) %>%
                dplyr::count(Subbasin, species_group)

dim(sum_spp_basin_species_group) # 52 3

# Calculate status of species_group for each subbasin

spp_status_basin_species_group <- full_join(sum_wi_basin_species_group,
                                        sum_spp_basin_species_group, by=c("Subbasin","species_group")) %>%
             mutate(wi_spp_taxa = sum_wi/n,
                    status_taxa = 1 - wi_spp_taxa)

# Plot status by species_group (before scaling lower end)

ggplot(spp_status_basin_species_group)+
  geom_point(aes(species_group,status_taxa,size=n)) +
  facet_wrap(~Subbasin) +
  ylim(0,1.5) +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("Species_group Status by Subbasin, n = species richness")

```

##### 2.9.5.2 For each species group - Scale lower end to zero if 75% extinct

Currently, dataset only includes presence data so no way to tell percentage of extinct species. Code was left in to be adapted for future BHI iterations when data can differentiate between unsuitable species and species that become regionally extinct. If no subbasins have 75% extinct species, there should be no change.

```{r scale for each species group if 75 percent extinct for subbasin}

# Filter regionally extinct species according to species_group

spp_ex_basin_species_group <- shared_list_vuln %>%
              # Add code here to only consider species that are supposed to be present (suitable for habitat)
              dplyr::rename(weights = red_list_category_numeric) %>%
              group_by(species_group) %>% 
              filter(weights == 1) %>%  # Check with Ellie what grouping before filtering does
              ungroup()

spp_ex_basin_species_group

# Identify regionally extinct species

spp_ex_basin_species_group %>% select(scientific_name) %>% distinct()


# Calculate number of extinct species per species group per subbasin

spp_ex_basin_n_species_group <- spp_ex_basin_species_group %>%
                  select(Subbasin, species_group,scientific_name)%>%
                  dplyr::count(Subbasin,species_group)%>%
                  dplyr::rename(n_extinct = n)


# Join to spp_status_basin_species_group

spp_status_basin_species_group <- spp_status_basin_species_group %>%
                   full_join(., spp_ex_basin_n_species_group, by=c("Subbasin", "species_group")) %>%
                   mutate(n_extinct = ifelse(is.na(n_extinct),0,n_extinct))

# calculate % extinct in each subbasin and assign status score of 0 if >75%

spp_status_basin_species_group <- spp_status_basin_species_group  %>%
                  mutate(prop_extinct = n_extinct / n,
                         status_taxa = ifelse(prop_extinct>=0.75, 0, status_taxa))

```

##### 2.9.5.3 Plot Final Status by Species_group

```{r plot species_group status}

ggplot(spp_status_basin_species_group) +
  geom_point(aes(species_group,status_taxa,size=n)) +
  facet_wrap(~Subbasin) +
  ylim(0,1.5) +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6)) +
  ggtitle("Species group Status by Basin, n= species richness")

```

##### 2.9.5.4 Calculate Geometric Mean of Status for Subbasin

```{r geometric mean status subbasin}

spp_status_basin_geo <- spp_status_basin_species_group %>%
                        select(Subbasin, status_taxa) %>%
                        group_by(Subbasin) %>%
                        summarise(status_basin =exp(mean(log(status_taxa)))) %>%
                        ungroup()
```

##### 2.9.5.5 Plot Geometric Mean for Subbasin Status

```{r plot subbasin status from geometric mean}

ggplot(spp_status_basin_geo)+
  geom_point(aes(Subbasin, status_basin),size=2)+
  ylim(0,1)+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("SPP subbasin status from geometric mean of species group")

```

#### 2.9.6 Compare Alternative Approaches to Subbasin level SPP status calculation

```{r comparsion of subbasin level spp status}

spp_status_basin <- spp_status_basin %>%
                    select(Subbasin,status) %>%
                    mutate(status_type = "all species")

spp_status_basin_geo <- spp_status_basin_geo %>%
                        dplyr::rename(status=status_basin) %>%
                        mutate(status_type = "species_group geometric mean")

basin_status_compare <- bind_rows(spp_status_basin, spp_status_basin_geo)


ggplot(basin_status_compare) +
  geom_point(aes(Subbasin, status, colour=status_type,shape=status_type),size=2) +
  ylim(0,1) +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6)) +
  ggtitle("SPP Subbasin status Method Comparison")

```
