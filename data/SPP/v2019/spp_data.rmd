
```{r spp preamble data, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "setup.R"))
source(here::here("R", "spatial.R"))
```

### 2.1 Datasets with Sources {-}
<br/>

#### 2.1.1 Species Presence, Observations and Red List Assessments {-}

To obtain data in shapefile format: downloaded, unzipped, opened (observations_final.gdb, observation_points layer) in QGIS, exported to shapefile. *These data are obtained from the HELCOM species database, compiled from original data sources: Shark SMHI, Species Observations System (Artportalen), MVM, and Entomological Collections (NHRS) from GBIF.*

<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/baltic_species/baltic_species.shp -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Observations data ESRI Geodatabase (ZIP)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 9 March by Chester")
```

<br>

#### 2.1.2 Red list (IUCN) information, about Species and their Assessment at HELCOM {-}

<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/species_with_redlist_category/species_with_redlist_category.csv -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Red list information data CSV")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 12 March by Ellie")
```

#### 2.1.3 Species ID, with taxanomic information for each species in HELCOM database {-}

<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/species_taxa.csv -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Species data CSV")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 4 April by Chester")
```

---

<br/>


### 2.2 Adding Region Information to Dataset {-}

```{r spp load raw data, echo = TRUE, message = FALSE, warning = FALSE, results = "hide"}
## root location of the raw data
# dir_B <- "C:/Users/Chester Gan/Desktop"
dir_rawdata <- file.path(dir_B, "Goals", "BD")
```


**Remove spatial 'depth' dimension, and assign BHI Region IDs**

Data points in the raw species observation dataset have latitude/longitude information. We join BHI region and Subbassin information based on the given latitude/longitude. The code chunk below alsoo renames some columns.

```{r remove z spatial dimension and assign BHI region ids, warning = FALSE, message = FALSE}
## create dataset with regions joined
## if already created don't need to recreate... take a long time...
if(!file.exists(file.path(dir_rawdata, "species_obs_w_rgns.csv"))){
  
  ## read in raw data
  ## need to rename columns, as names were shortened when exported to shapefile...
  if(!file.exists(file.path(dir_rawdata, "raw_species_observations.csv"))){
    spp_raw <- sf::st_read(file.path(dir_rawdata, "raw_species_observations")) %>%
      dplyr::rename(
        scientific_name = scientific, 
        accepted_name = accepted_n, 
        species_group = species_gr, 
        sampling_group = sampling_g,
        red_list_assessments = red_list_a,
        year_collected = year_colle
      ) %>% 
      st_drop_geometry()
  } else {
    spp_raw <- data.table::fread(file.path(dir_rawdata, "raw_species_observations.csv"))
  }
  
  buffer_sf <- st_read(
    file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"), 
    "BHI_shapefile_25km_buffer"
  )
  
  ## join just spatial info and IDs with BHI IDs, the rejoin 
  ## (smaller dataframes are more manageable!)
  rgns <- join_rgns_info(
    spp_raw %>% select(OBJECTID, decimal_la, decimal_lo),
    latlon_vars = c("decimal_la", "decimal_lo"),
    return_spatial = FALSE,
    rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
    buffer_shp = buffer_sf
  )
  spp_w_rgns <- left_join(
    rename(rgns, OBJECTID = objectid), 
    spp_raw,
    by = c("OBJECTID", "decimal_la", "decimal_lo")
  )
  
  write_csv(spp_w_rgns, file.path(dir_rawdata, "species_obs_w_rgns.csv"))
}
```

<br/>

### 2.3 Checking Raw Data {-}

```{r read in all raw spp datasets}
## Observations Data
raw_obs_checklist <- data.table::fread(
  file.path(dir_rawdata, "species_obs_w_rgns.csv"), 
  stringsAsFactors = FALSE
)

## Redlist Data
redlistloc <- file.path(
  dir_rawdata, 
  "species_with_redlist_category", 
  "species_with_redlist_category.csv"
)
redlist <- read.csv(redlistloc, sep = ";", stringsAsFactors = FALSE) %>%
  dplyr::rename(scientific_name = species_scientific_name) %>%
  select(-id) # Remove redundant id column

## Species list (all taxa)
helcom_list_all_taxa <- read.csv(
  file.path(dir_rawdata, "species_taxa.csv"), 
  stringsAsFactors = FALSE
)
```


#### 2.3.1 Taxa Represented {-}

Check taxa included, and numbers of distinct species included in each taxa and subbasin, over time.

```{r Check Taxa, results = "show", fig.width = 12, fig.height = 5}
## Check representation of taxa
taxa <- raw_obs_checklist %>%
  select(species_group) %>%
  distinct()
## taxa include: Benthic Invertebrates, Fish and Lamprey, Macrophytes, 
## Zooplankton, Bacteria, Phytoplankton, Mammals and Birds

## Check number of species within each taxa
numtaxaspp <- raw_obs_checklist %>%
  group_by(species_group) %>%
  count()

## Note: some records are for periods of longer than a year, 
## i.e. observations collected over multiple years
# hist(mutate(raw_obs_checklist, nyears = end_year_c - start_year)$nyears, nclass = 80)
# summary(mutate(raw_obs_checklist, nyears = end_year_c - start_year)$nyears)

raw_obs_checklist %>% 
  filter(!is.na(year_collected)) %>% 
  filter(year_collected > 1920) %>%
  filter(!species_group %in% c("Bacteria", "Phytoplankton", "Zooplankton")) %>%
  filter(!is.na(Subbasin)) %>% 
  distinct(year_collected, species_group, scientific_name) %>%
  # distinct(year_collected, species_group, scientific_name, Subbasin) %>%
  ggplot(aes(x = year_collected)) +
  geom_histogram(
    alpha = 0.8, size = 0.1, color = "grey90",
    binwidth = 1
  ) +
  theme(axis.text = element_text(size = 13)) +
  scale_x_continuous(breaks = seq(1920, 2020, 10)) +
  facet_wrap(~species_group, scales = "free_y", nrow = 5) +
  # facet_grid(rows = vars(species_group), cols = vars(Subbasin), scales = "free_y") +
  labs(x = NULL, y = "Count", title = "Number of Species in Raw Checklist") +
  theme(strip.text = element_text(size = 12))


## Number of unique latin names 
numnames <- raw_obs_checklist %>% 
  select(scientific_name) %>% 
  distinct() %>%
  nrow() # 2958 (Including Bacteria and Plankton)
```


#### 2.3.2 BHI ID and Basins {-}

```{r create dataframe with BHI ID and Basins}
## Matching BHI ID to subbasins
rgns_complete <- read_csv(file.path(dir_prep, "supplement", "lookup_tabs", "rgns_complete.csv"))

## To see how many distinct basins represented
unique(raw_obs_checklist$Subbasin) # 17 basins -> Correct number
```


#### 2.3.3 Read in Redlist and get Data Attributes

```{r check redlist data, results = "hide"}
## before wrangling check redlist and helcom taxa list for:
## trailing spaces and irregular characters
nrow(filter(redlist, str_detect(scientific_name, "\\s+$|<")))
nrow(filter(helcom_list_all_taxa, str_detect(scientific_name, "\\s+$|<")))
for(df in c("redlist", "helcom_list_all_taxa", "raw_obs_checklist")){
  assign(
    df,
    get(df) %>% 
      mutate(scientific_name = str_replace_all(scientific_name, "<a0>", " ")) %>% 
      mutate(scientific_name = str_replace_all(scientific_name, "<eb>", "e")) %>% 
      mutate(scientific_name = str_replace_all(scientific_name, "ë", "e")) %>% 
      mutate(scientific_name = str_replace_all(scientific_name, "<ef>", "i")) %>% 
      mutate(scientific_name = str_replace_all(scientific_name, "ï", "i")) %>% 
      mutate(scientific_name = str_remove_all(scientific_name, "\\s+$"))
  )
}
filter(redlist, str_detect(scientific_name, "�"))
filter(helcom_list_all_taxa, str_detect(scientific_name, "�"))
## still need to fix weird characters in a few redlist species names
## Isoëtes echinospora, Anser fabalis fabalis, Cepphus grylle grylle and arcticus, 
## Isoëtes lacustris, Phyllophora pseudoceranoïdes, Pisidium casertanum f. ponderosum
redlist <- redlist %>% 
  mutate(scientific_name = str_replace(
    scientific_name, 
    pattern = "Iso.*tes echinospora", 
    replacement = "Isoetes echinospora")
  ) %>% 
  mutate(scientific_name = str_replace(
    scientific_name, 
    pattern = "Anser.*fabalis.*fabalis", 
    replacement = "Anser fabalis fabalis")
  ) %>% 
  mutate(scientific_name = str_replace(
    scientific_name, 
    pattern = "Cepphus.*grylle.*grylle", 
    replacement = "Cepphus grylle grylle")
  ) %>%
  mutate(scientific_name = str_replace(
    scientific_name, 
    pattern = "Cepphus.*grylle.*arcticus", 
    replacement = "Cepphus grylle arcticus")
  ) %>%
  mutate(scientific_name = str_replace(
    scientific_name, 
    pattern = "Iso.*tes lacustris", 
    replacement = "Isoetes lacustris")
  ) %>%
  mutate(scientific_name = str_replace(
    scientific_name, 
    pattern = "Phyllophora pseudocerano.*des", 
    replacement = "Phyllophora pseudoceranoides")
  ) %>% 
  mutate(scientific_name = str_replace(
    scientific_name, 
    pattern = "Pisidium.*casertanum.*f\\..*ponderosum", 
    replacement = "Pisidium casertanum f. ponderosum")
  )

## Number of species in redlist
length(unique(redlist$scientific_name)) # 2771

## Plot number of species in redlist per taxa group
redlist <- helcom_list_all_taxa %>% 
  select(scientific_name, species_group) %>% 
  right_join(redlist, by = "scientific_name") %>% 
  arrange(species_group)

ggplot(redlist, aes(x = species_group)) +
  geom_bar(stat = "count") +
  theme(
    axis.text = element_text(colour = "grey20"),
    axis.text.x = element_text(size = 8, angle = 90, hjust = 1, vjust = 0.5, face = "plain"),
    axis.text.y = element_text(size = 6)
  ) +
  labs(title = "Number of species in the redlist", x = "\nSpecies Group", y = "Count")


## Create list of species with duplicate assessments and duplicate entries in redlist
duplicate_entry_redlist <- redlist %>% 
  group_by(scientific_name) %>%
  mutate(count = n()) %>%
  filter(count > 1)

duplicate_redlist <- duplicate_entry_redlist %>%
  select(scientific_name) %>% 
  distinct()

## Check redlist assessment years
sort(unique(redlist$assessment_year_red_list))  # 2007 and 2013

## only 171 of 2771 species on redlist have assessments in both 2007 and 2013
redlist %>% 
  select(scientific_name, assessment_year_red_list) %>% 
  distinct() %>% 
  select(scientific_name) %>% 
  filter(duplicated(.)) 

## Add list_type column
redlist <- mutate(redlist, list_type = "redlist")
```

<br/>

### 2.4 Initial Data Organization {-}

#### 2.4.1 Subsetting Observations Data - Remove Unnecessary Rows and Columns {-}

Removing Unnecessary Columns, Bacteria and Plankton taxa, rows without basin location data.

```{r remove spp observations bacteria and plankton, results = "hide"}
## some observations have start and end years but no 'year collected'
## e.g. if collected over multiple years:
obs_no_year_collected <- raw_obs_checklist %>% 
  filter(is.na(year_collected)) %>% 
  mutate(chk = end_year_c - start_year)
# nrow(obs_no_year_collected)
# nrow(filter(obs_no_year_collected, chk > 0))
# sort(unique(filter(obs_no_year_collected, chk > 20)$start_year))
# plot(filter(obs_no_year_collected, chk > 0)$start_year, filter(obs_no_year_collected, chk > 0)$chk, cex = 0.4)

## will assign start_year as 'year' for our use, 
## because for observations before 2000's we don't need to know exact year of collection
obs_no_year_collected <- obs_no_year_collected %>% 
  select(-chk) %>%  
  mutate(year = start_year)

full_obs_checklist <- raw_obs_checklist %>% 
  filter(!is.na(year_collected)) %>% 
  mutate(year = year_collected) %>% 
  bind_rows(obs_no_year_collected) %>% 
  select(
    species_id,
    scientific_name, 
    accepted_name, 
    synonyms,
    taxonomica, 
    species_group,
    year_collected, 
    year,
    red_list_assessments,
    rgn_nam, 
    Subbasin, 
    BHI_ID
  ) %>%
  filter(!species_group %in% c("Bacteria", "Phytoplankton", "Zooplankton")) %>%
  filter(!is.na(Subbasin)) %>%
  mutate(list_type = "checklist")

## Checking filter
full_obs_checklist %>%
  group_by(species_group) %>%
  summarize(num_observations = n(), distinct_species = n_distinct(scientific_name))

sum(is.na(full_obs_checklist$rgn_nam)) # all NA entries have been filtered out so there are no NAs in rgn_nam

## Number of unique species names, 2443
length(unique(full_obs_checklist$scientific_name))
```
<br>

#### 2.4.2 Some metrics on Species Observations by Subbasin {-}

How can we use this data to construct realistic expectations about presence?

If historically a species was recorded (beyond trace numbers) in a subbasin, we expect it should be there today (considering that shifting habitat due to e.g. climate, is due to anthropogenic pressures). The inverse is not necessarily true though i.e. if it  was not recorded in the subbasin historically, we cannot say whether species should or shouldn't be there, since sampling isn't exhaustive and in the past was even less so. Thus, with this data and approach, a given subbasin may lack species which should potentially be accounted for there. 

For full confidence in species included in each region, we would need additional information e.g. species habitat maps and/or lists constructed by experts.

```{r presence of species in different subbasins, results = "show", fig.width = 9, fig.height = 6}
fullobs_stats_checklist <- full_obs_checklist %>% 
  group_by(scientific_name, Subbasin) %>% 
  mutate(
    count_ten_plus = n() >= 10,
    min_spp_yr = min(year), 
    max_spp_yr = max(year),
    num_spp_yrs = n_distinct(year)
  )
## filtering by 10+ obs. reduces num. distinct species to about half of what is in full_obs_checklist 
fullobs_stats_checklist %>%
  filter(count_ten_plus) %>%
  group_by(species_group) %>%
  summarize(num_observations = n(), distinct_species = n_distinct(scientific_name))

plotdf <- rbind(
  fullobs_stats_checklist %>% 
    filter(count_ten_plus) %>% 
    mutate(plotcateg = "historically recorded"),
  fullobs_stats_checklist %>% 
    filter(max_spp_yr >= 2010, count_ten_plus) %>% 
    mutate(plotcateg = "recorded this decade"),
  fullobs_stats_checklist %>% 
    filter(min_spp_yr >= 2010, count_ten_plus) %>% 
    mutate(plotcateg = "only recorded this decade"),
  fullobs_stats_checklist %>% 
    filter(max_spp_yr < 2010, count_ten_plus) %>% 
    mutate(plotcateg = "not recorded this decade")
) %>% distinct(plotcateg, scientific_name, Subbasin, species_group)

plotdf$plotcateg <- factor(
  plotdf$plotcateg, 
  levels = c(
    "only recorded this decade", 
    "not recorded this decade", 
    "recorded this decade", 
    "historically recorded"
  )
)
ggplot(plotdf) +
  geom_bar(
    aes(plotcateg), 
    alpha = 0.8, size = 0.3, fill = "grey90", color = "grey60",
    show.legend = FALSE,
    position = position_dodge()
  ) +
  coord_flip() +
  facet_grid(rows = vars(Subbasin), cols = vars(species_group), scales = "free") +
  labs(x = NULL, y = "\nDistinct Species Count") +
  theme(strip.text.y = element_text(size = 8, angle = 0))

# fullobs_stats_checklist %>%
#   group_by(year, scientific_name, Subbasin) %>%
#   summarize(count = n()) %>%
#   ggplot() +
#   geom_area(
#     aes(year, count, fill = scientific_name),
#     show.legend = FALSE,
#     alpha = 0.7,
#     size = 0.2,
#     position = "stack"
#   ) +
#   facet_wrap(~Subbasin, scales = "free") +
#   labs(x = NULL, y = NULL)
```


#### 2.4.3 Separating Insects from Other Taxa {-}

Due to similar concerns as those raised in BHI 1.0 (lower confidence in proper identification at species level), insect species in the current dataset needed to be summarized to family level before being scored. For convenience, insect species were first separated to be wrangled separately from other taxa.

Two approaches were considered in order to check current dataset for insect species. Ultimately, the approach using HELCOM species data was considered more robust and selected for use. 

```{r separate insects from other spp observations}
## Approach 2: Use HELCOM species id list to identify insect species with current dataset ----
helcom_insect_list <- helcom_list_all_taxa %>%
  select(scientific_name, id, class, family) %>%
  dplyr::rename(species_id = id) %>%
  filter(class == "Insecta")
  ## have Tanypus punctipennis with species IDs 1395 and 3976...

obs_checklist_insect <- fullobs_stats_checklist %>% 
  filter(species_group == "Benthic Invertebrates") %>% 
  mutate(names = paste(scientific_name, accepted_name, synonyms, sep = ";"))

## any cases where insect names are in synonyms or accepted name cols of obs dataframe?
## would assume no since from the same data managers, but might as well check...
insects <- unique(helcom_insect_list$scientific_name)
on_insect_list <- purrr::map(
  obs_checklist_insect$names,
  ~ ifelse(any(str_detect(., insects)), str_extract(., insects)[!is.na(str_extract(., insects))], "")
) %>% unlist()

## hopefully all insects in the obs dataframe are on the helcom_insect_list...
obs_checklist_insect <- cbind(obs_checklist_insect, on_insect_list = on_insect_list) %>% 
  filter(str_length(on_insect_list) > 0)

## 2 cases found, resulting in 67 more rows in final obs_checklist_insect: 
## Einfeldia carbonaria (on insect list) as Benthalia carbonaria (in full obs dataframe)
## Cladopelma viridula (on insect list) as Cladopelma viridulum (in full obs dataframe)
obs_checklist_insect %>% 
  filter(scientific_name != on_insect_list) %>% 
  distinct(scientific_name, accepted_name, synonyms, species_id, on_insect_list)

## 236 unique insect species, need to summarise to family level
length(unique(on_insect_list))


## Separating Insect data from other taxa (Using info from Approach 2) ----
keepvars <- c(
  "species_id", "scientific_name", "accepted_name", "synonyms", "on_insect_list",
  "year", "year_collected",
  "taxonomica", "species_group", 
  "count_ten_plus",
  "Subbasin", "list_type"
)

## Insect species observations,
## save so don't have to redo intensive name comparisons...
obs_checklist_insect <- obs_checklist_insect[, keepvars]
write_csv(obs_checklist_insect, file.path(dir_prep, "data", "SPP", "v2019", "intermediate", "obs_insect.csv"))

## Non-insect species observations
## save so don't have to redo intensive name comparisons...
obs_checklist_no_insect <- fullobs_stats_checklist %>%
  filter(!scientific_name %in% unique(obs_checklist_insect$scientific_name))
write_csv(obs_checklist_no_insect, file.path(dir_prep, "data", "SPP", "v2019", "intermediate", "obs_no_insect.csv"))
```

<br/>

### 2.5 Data Prep for Insecta {-}

Insects are more complicated due to uncertainty of taxonomical classification. Hence, observations need to be summarized to the family level before instituting a presence threshold of at least 10 observations. The highest threat status needs to be applied for entire family. Rare species will be excluded from the analysis. Highest threat level should be taken from the entire redlist rather than just the species that appear in the observations list.

#### 2.5.1 Redlist Data Prep: Summarise Insects to Family Level and Use Highest Threat Status for Family {-}

```{r checking redlist vs observations species ids and scientific names}
## Check that species_id and scientific name uniquely identify entires in redlist and obs
## (so can full join without duplicates of species id)

obs_check <- full_obs_checklist %>%
  select(species_id, scientific_name) %>%
  distinct() # 2443, same as earlier check on unique full_obs_checklist species names
obs_check %>% 
  select(species_id) %>% 
  filter(duplicated(.)) 
## 0 rows so no duplicate species IDs in observations data

redlist_check <- redlist %>%
  select(species_id, scientific_name) %>%
  distinct()
redlist_check %>% 
  select(species_id) %>% 
  filter(duplicated(.)) 
## 0 rows so no duplicate species IDs in redlist


## another check that there are no duplicates when joining
full_join(obs_check, redlist_check) %>% 
  distinct() %>% 
  group_by(species_id) %>% 
  filter(n() == 2) %>% 
  arrange(species_id)
```


```{r redlist insects summarise family level}
## Obtain insect subset of redlist
redlist_insect_species_assessment <- redlist %>%
  filter(scientific_name %in% unique(helcom_insect_list$scientific_name)) 
distinct(redlist_insect_species_assessment, scientific_name) # 365 unique species

## Check for duplicate entries
## one duplicate found: Cladotanytarsus mancus
intersect(
  unique(redlist_insect_species_assessment$scientific_name), 
  unique(duplicate_entry_redlist$scientific_name)
)
## Difference in remarks column, rectify in next step
redlist_insect_species_assessment %>% 
  filter(scientific_name == "Cladotanytarsus mancus")

## Add family to each species using helcom_insect_list
redlist_insect_species_assessment <- redlist_insect_species_assessment %>% 
  left_join(select(helcom_insect_list, -class), by = c("scientific_name", "species_id")) %>%
  select(-remarks) %>%
  distinct() # Removed duplicate

## Assign highest threat level for family to each species

unique(redlist$red_list_category) # To check all categories

redlist_rank <- data.frame(
  red_list_category =  c(
    "NE - Not Evaluated", 
    "NA - Not Applicable", 
    "DD - Data Deficient",  
    "RA - Rare", 
    "TM - Threatened Migrant", 
    "LC - Least Concern", 
    "NT - Near Threatened", 
    "VU - Vulnerable", 
    "EN - Endangered", 
    "CR - Critically Endangered", 
    "RE - Regionally Extinct"
  ), 
  num_rank = 1:11
) # Ranks 1-5 will be excluded but included here in ranking to be able to differentiate
redlist_rank <- mutate(redlist_rank, red_list_category = as.character(red_list_category))

redlist_insect_family_assessment <- redlist_insect_species_assessment %>% 
  left_join(redlist_rank, by = "red_list_category") %>%
  group_by(family) %>%
  mutate(maxrank = max(num_rank, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(
    rename(redlist_rank, family_category = red_list_category, maxrank = num_rank), 
    by = "maxrank"
  ) %>%
  select(
    family, 
    family_category, 
    assessment_year_red_list, 
    species_group, 
    list_type
  ) %>%
  distinct() %>%
  rename(red_list_category = family_category)
```


#### 2.5.2 Summarize to Family Level {-}

```{r insects observations summarise family}
## Add family information to insects observations checklist
obs_checklist_insect_family <- left_join(obs_checklist_insect, select(helcom_insect_list, -class)) %>%
  ## Summarize number of observations per family per Subbasin region
  group_by(family, Subbasin) %>%
  mutate(
    count_ten_plus = n() >= 10, 
    min_spp_yr = min(year), 
    max_spp_yr = max(year),
    num_spp_yrs = n_distinct(year_collected)
  ) 
```

<br/>

### 2.6 Data Prep for Insecta at Family level and all other Taxa at Species Level {-}

#### 2.6.1 Instituting threshold for Inclusion {-}

The biodiversity goal scores will consist of the average of all species historically observed in a Subbasin weighted by numeric values corresponding to their most recent IUCN assessment category. All species with reasonable number of historic observations in a given subbasin will be included in that subbasin's score, so the scores do not become positively (i.e. better than realistic) biased due to unrepresentative inclusion of only the more abundant and less threatened, but therefore more frequently observed, species.

Observation data are given a threshold for species to be considered present. This is to avoid any very rare occurrences of an individual being mistaken for species establishment. Based on the solution proposed in BHI 1.0, species will only be considered present when there at least 10 observations in the region.

Limitations in this approach: As IUCN assessments of species are not frequently conducted, these goal score may tend to lag by some years in representation of the true state of biodiversity. To make any useful interpretation from observation _frequencies_ of species, some quantification of _sampling effort_ corresponding to those frequencies would be needed. Would also be good to have spatial data on environmental conditions (background/pseudo‐absence data)... <!-- https://doi.org/10.1111/j.2041-210X.2011.00172.x -->

```{r presence threshold for inclusion, fig.width = 9.5, fig.height = 3}

for(obs_checklist in c("obs_checklist_no_insect", "obs_checklist_insect_family")){
  
  if(obs_checklist == "obs_checklist_no_insect"){
    summaryvars = c("species_id", "scientific_name", "Subbasin")
  } else {summaryvars = c("family", "Subbasin")}

  obs_decade_count <- get(obs_checklist) %>% 
    filter(year >= 2010) %>% 
    group_by(!!!syms(summaryvars)) %>%
    summarise(count = n()) %>% 
    mutate(presence = ifelse(count >= 10, TRUE, NA)) %>%
    select(-count) # remove count column to prep for list joining
  
  
  ## Number of observations per species per Subbasin region summarized in sections 2.4.2 
  ## or number observations per family for insects, summarized in section 2.5.2
  
  ## Established species identified as those with ten or more total obs. across all years of data
  ## Currently present species identified as those with ten or more observations in the current decade
  ## Filter those with 10 or more observations total and add decade 'presence' column
  obs_present <- get(obs_checklist) %>%
    filter(count_ten_plus) %>%
    group_by(Subbasin, scientific_name) %>% 
    mutate(
      ## add cols: 
      ## historically recorded, recorded this decade, not recorded before this decade, no record from current decade
      # rec_this_dec = max_spp_yr >= 2010,
      # no_rec_before_this_dec = min_spp_yr >= 2010,
      # no_rec_this_dec = max_spp_yr < 2010
      
      ## or maybe 15 years time period is better?
      hist_rec = TRUE,
      rec_this_dec = max_spp_yr >= 2005,
      no_rec_before_this_dec = min_spp_yr >= 2005,
      no_rec_this_dec = max_spp_yr < 2005
    ) %>% 
    ungroup() %>% 
    left_join(obs_decade_count, by = summaryvars) %>% 
    mutate(presence = ifelse(is.na(presence), FALSE, presence))
  
  # distinct(obs_present, scientific_name, Subbasin, no_rec_this_dec) %>%
  #   group_by(Subbasin, no_rec_this_dec) %>%
  #   summarize(spp_norec_thisdec = n()) %>%
  #   tidyr::pivot_wider(names_from = no_rec_this_dec, values_from = spp_norec_thisdec)
  
  
  
  ## collapse all obs to one per species (or family for insects) per Subbasin region
  assign(
    str_remove(obs_checklist, "^obs_"), 
    obs_present %>% 
      select(!!!syms(c(summaryvars, "list_type", "species_group", "no_rec_this_dec"))) %>% 
      distinct() %>% 
      ungroup()
  )
}

## Number of unique families (only insects)
length(unique(checklist_insect_family$family)) # 24

## Number of unique present species (excluding insects)
length(unique(checklist_no_insect$scientific_name)) # 1313
# ggplot(checklist_no_insect) +
#   geom_histogram(aes(species_group), stat = "count") +
#   facet_wrap(~Subbasin, scales = "free") +
#   coord_flip() +
#   labs(x = NULL, y = NULL)
```


#### 2.6.2 Getting Species or Insect Families overlap between Checklist and Redlist {-}


**Intersections of Species Checklists and Redlist Assessment Lists**

```{r species or insect families on both checklists derived from observations and redlist assessment lists}
missing_spp <- data.frame(checklist_not_redlist = as.numeric(), redlist_not_checklist = as.numeric)

for(chklst in c("checklist_no_insect", "checklist_insect_family")){
  
  if(chklst == "checklist_insect_family"){
    join_redlist <- redlist_insect_family_assessment
    joinvars = c("family", "species_group")
  } else {
    join_redlist <- redlist
    joinvars = c("species_id", "scientific_name", "species_group")
  }
  ## maybe instead of full join should use approach like used for separating insect and non-insect? 
  ## using synonyms/accepted names and string-matching...
  shared <- full_join(get(chklst), join_redlist, by = joinvars) %>% ungroup()
  assign(str_replace(chklst, "^checklist", "shared"), shared)
  
  missing_spp <- rbind(missing_spp, data.frame(
    checklist_not_redlist = nrow(distinct(filter(shared, !is.na(list_type.x) & is.na(list_type.y)), !!!syms(joinvars))),
    redlist_not_checklist = nrow(distinct(filter(shared, is.na(list_type.x) & !is.na(list_type.y)), !!!syms(joinvars)))
  ))
}
## non-insects df has 317 obs spp not on redlist and 1775 on redlist not in observations
## insects df has 1 obs spp not on redlist and 34 on redlist not in observations...
# missing_spp
# dim(shared_insect_family)
# dim(shared_no_insect)


## for insects just going to keep where lists overlap
shared_insect_family <- shared_insect_family %>%
  filter(!is.na(list_type.x) & !is.na(list_type.y)) %>% 
  rename(scientific_name = family)
```

<br>

**Non-Insect Checks: Species on Checklist not Redlist and Vice Versa**

Need to first join and retain all species in order to check for possible spelling mismatches. After correcting possible spelling errors, retain only species that are in both lists.

Initially, a check of checklist species not on redlist was made in order to maximise the number of species that can be analyzed by ensuring no species were excluded due to spelling errors that was incompatible with the redlist. However, the number of species that were not assessed in the redlist was too many to look through... Further, as both the checklist and redlist were compiled by HELCOM, it is unlikely that the databases were unsynchronised.

<br>


**Finalizing Non-Insect Shared Species List**

Duplicate assessments were found for 5 species in the shared species list. Upon inspection, duplicate assessments were found to be based off on wintering and breeding statuses. To resolve this, decision was made to take the threat assessment of breeding birds for each species.

Duplicate entries with same assessment across different assessment years was also found for 1 species. This was resolved by deleting the older assessment. This section needs to be fixed with new approach using entire obs database.


```{r shared species no insect}

## Species list that is on both checklists (observations/presence and redlist)
shared_no_insect <- filter(shared_no_insect, !is.na(list_type.x) & !is.na(list_type.y))

## Check number of species
length(unique(shared_no_insect$scientific_name)) # 993 species

## Check where there are duplicate assessments (species with more than one threat level assessment)

spp_duplicate_assess <- intersect(
  unique(shared_no_insect$scientific_name), 
  unique(duplicate_redlist$scientific_name)
) # 27 species 

shared_lst_duplicates <- shared_no_insect %>% 
  filter(scientific_name %in% spp_duplicate_assess) %>% 
  distinct(scientific_name, assessment_year_red_list, red_list_category, remarks)


## Some duplicates are from bird species that are based off wintering and breeding categories:
chk_birds <- unique(filter(shared_lst_duplicates, str_detect(remarks, "bird"))$scientific_name)
chk_birds <- shared_no_insect %>% 
  select(-Subbasin) %>% 
  distinct() %>% 
  filter(scientific_name %in% chk_birds, str_detect(remarks, "Breeding birds"))

## Substitute threat assessment of breeding birds for each species with duplicate assessments
shared_no_insect <- shared_no_insect %>%
  rowwise() %>% 
  mutate(
    red_list_category = case_when(
      any(scientific_name %in% filter(chk_birds, str_detect(red_list_category, "NT"))$scientific_name) ~ "NT - Near Threatened",
      any(scientific_name %in% filter(chk_birds, str_detect(red_list_category, "VU"))$scientific_name) ~ "VU - Vulnerable",
      any(scientific_name %in% filter(chk_birds, str_detect(red_list_category, "LC"))$scientific_name) ~ "LC - Least Concern",
      !scientific_name %in% chk_birds ~ red_list_category
    )
  ) %>% 
  ## also removes remarks that indicate subspecies... so deal with that first
  mutate(scientific_name = ifelse(
    scientific_name == "Phocoena phocoena",
    sprintf("%s (%s)", scientific_name, remarks),
    scientific_name
  )) %>% 
  ## why two assessment categories for same year (LE and NE)?
  filter(!(scientific_name == "Malacoceros fuliginosus" & red_list_category == "NE - Not Evaluated")) %>% 
  select(-remarks) %>%
  distinct()

## Recheck that duplicate scientific names are for different (years') assessments
shared_no_insect %>% 
  select(scientific_name, red_list_category, assessment_year_red_list) %>% 
  distinct() %>% 
  ungroup %>% 
  group_by(scientific_name) %>% 
  filter(n() > 1)
```

<br/>

### 2.7 Combined Shared List And Initial Plots {-}

```{r shared list plot by iucn threat category, fig.width = 9, fig.height = 4}
## Combining shared_no_insect species and shared_insect_family dataframes
shared_list <- shared_no_insect %>% 
  bind_rows(shared_insect_family) %>%
  select(
    scientific_name,
    species_group,
    Subbasin,
    red_list_category,
    no_rec_this_dec,
    assessment_year_red_list
  ) %>% # Removed species-specific rows
  ungroup()

dim(shared_list) # 3483 entries

## Plot by threat category
shared_list %>% 
  filter(assessment_year_red_list == 2013) %>% 
  distinct(scientific_name, species_group, red_list_category) %>% 
  ggplot() +
  geom_bar(
    aes(x = red_list_category),
    stat = "count", 
    position = position_dodge(), 
    show.legend = FALSE
  ) +
  theme(
    axis.text = element_text(colour = "grey20", size = 8),
    axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5)
  ) +
  coord_flip() +
  facet_grid(rows = vars(species_group), scales = "free") +
  labs(
    title = "Count of species in each IUCN category", 
    x = NULL, y = NULL
  )
```


For use in ICO status calculation, does not contain red_list_category numeric.

```{r export for use in ICO calculation}
## Write to two locations - SPP folder and ICO folder

write.csv(shared_list, file.path(dir_spp,'checklist_redlist_data_for_status.csv'), row.names = FALSE)  

write.csv(shared_list, file.path(dir_prep,'ICO/data_database/checklist_redlist_data_for_status.csv'), row.names = FALSE)

```

<br/>

### 2.8 Data Analysis {-}

#### 2.8.1 Select Data for Analysis and Plot Excluded and Included Data {-}

```{r exclude threat categories without score, results = "show"}
## Check threat categories in shared_list
## NE, NA and DD to be removed
unique(shared_list$red_list_category)

## Save excluded species in separate object
exclude_categories <- c("DD - Data Deficient", "NE - Not Evaluated", "NA - Not Applicable")
spp_excluded <- filter(shared_list, red_list_category %in% exclude_categories)
dim(spp_excluded) # 410 entries

## Plot excluded data
spp_excluded %>%
  distinct(species_group, scientific_name, red_list_category) %>% 
  ggplot(aes(x = species_group, fill = red_list_category)) +
  geom_bar(stat = "count") +
  labs(title = "Count of excluded species", x = NULL, y = NULL, fill = "Redlist Category")

## New shared_list excluding DD, NA and NE threat categories
spp_included <- filter(shared_list, !red_list_category %in% exclude_categories)
dim(spp_included) # 3073 (correct as = 3483-410)

## Plot included data (num. distinct species, without DD, NA and NE categories) 
## by species_group and red_list_category
spp_included %>%
  distinct(species_group, scientific_name, red_list_category) %>% 
  ggplot(aes(x = species_group, fill = red_list_category)) +
  geom_bar(stat = "count") +
  theme(axis.text.x = element_text(colour = "grey20", size = 8, angle = 90, hjust = 1, vjust  = 0.5)) +
  labs(title = "Count of species in each IUCN category", x = NULL, y = NULL, fill = "Redlist Category")
```


#### 2.8.2 Plots by species_group and Subbasin {-}

```{r plots species_group Subbasin}
## Plot included data by subbasin, with threat category
spp_included %>%
  distinct(species_group, scientific_name, Subbasin, red_list_category) %>% 
  ggplot(aes(x = species_group, fill = red_list_category)) +
  geom_bar(stat = "count") +
  facet_wrap(~Subbasin, scales = "free_y") +
  theme(axis.text.x = element_text(colour = "grey20", size = 8, angle = 90, hjust = 1, vjust  = 0.5)) +
  labs(
    title = "Count of species in each taxa group coded by IUCN category", 
    x = NULL, y = NULL, 
    fill = "Redlist Category"
  )

## Plot distribution for each species_group separately by subbasin & threat category
## (with color palette to highlight Gulf of Finland)
plotbasins <- c("Bothnian Bay", "Bothnian Sea","Aland Sea","The Quark","Gulf of Finland")
spp_included %>%
  distinct(species_group, scientific_name, Subbasin, red_list_category) %>% 
  ## limiting the number of Subbasins included in the plot...
  # filter(Subbasin %in% plotbasins) %>% 
  count(species_group, Subbasin, red_list_category, name = "n_species") %>% 
  mutate(plotcol = ifelse(Subbasin ==  "Gulf of Finland", TRUE, FALSE)) %>% 
  ggplot() +
  geom_col(aes(Subbasin, n_species, fill = plotcol), show.legend = FALSE) +
  scale_fill_manual(values = c("grey", "salmon")) + 
  facet_grid(
    cols = vars(red_list_category), 
    rows = vars(species_group), 
    scales = "free"
  ) +
  coord_flip() +
  labs(
    y = "\nCount of Species", x = NULL, 
    title = "\nCount of Species in each IUCN category by Subbasin"
  ) +
  theme(
    axis.text.y = element_text(colour = "grey20", size = 7),
    axis.text.x = element_text(colour = "red", size = 8, face = "bold")
  )
```

#### 2.8.3 Assign BHI Vulnerability Score to Threat Categories {-}

This step highlights a current issue with using just observations data: it is likely many regionally extinct, extinct, or critically endangered species are not accounted for, as they so rare (or non-existent) as to go undetected and thus not present in the observations dataset... 

```{r BHI score numeric threat category}
## Create vulnerability lookup table
vuln_lookup <- redlist %>% 
  select(red_list_category) %>% 
  distinct() %>% # all categories 
  mutate(
    red_list_category_numeric = case_when(
      red_list_category == "EX - Extinct" ~ 1,
      red_list_category == "RE - Regionally Extinct" ~ 1,
      red_list_category == "CR - Critically Endangered" ~ 0.8,
      red_list_category == "EN - Endangered" ~ 0.6,
      red_list_category == "VU - Vulnerable" ~ 0.4,
      red_list_category == "NT - Near Threatened" ~ 0.2,
      red_list_category == "LC - Least Concern" ~ 0 
    )
  )

## Only LC, NT, VU, EN and CR in spp_included
unique(spp_included$red_list_category)

## Add vulnerability score to spp_included
spp_vuln <- left_join(spp_included, vuln_lookup, by = "red_list_category")
dim(spp_vuln) # same no of rows, 1 extra column so correct
```

<br>

### 2.9 Status Calculation {-}

In Approach 1, a single calculation is made including all species. This result will be compared to Approach 2 (see Section 2.9.2) where a calculation is made for each taxa group before taking the geometric mean. The comparison between the two approaches can be found in Section 2.9.3.


#### 2.9.1 Status Approach 1: by Subbasin with All Species Weighted Equally {-}

Data is portrayed on the HOLAS subbasin scale. Biodiversity status will be calculated by these subbasin and then applied to BHI regions. Unlike BHI 1.0, the current iteration considers birds as well, since they have been given designated locations in this analysis. 
<!-- Note, this will mean that the data layer sent to the layers folder is very different than what is done if using the spatial data layers from HELCOM where status is directly calculated for BHI regions and this is done formally in functions.R -->


```{r status calculation approach 1}
## check num species in each subbasin...
spp_vuln %>% 
  group_by(scientific_name) %>% 
  filter(assessment_year_red_list == max(assessment_year_red_list)) %>% 
  group_by(Subbasin) %>% 
  summarise(num_spp_basin = n_distinct(scientific_name))

sum_and_nspp_wi_basin <- spp_vuln %>%
  ## take only values from most recent redlist assessment
  group_by(scientific_name) %>% 
  filter(assessment_year_red_list == max(assessment_year_red_list)) %>% 
  ## Sum threat weights for each subbasin, normalizing by number distinct spp in subbasin
  group_by(Subbasin) %>% 
  rename(weights = red_list_category_numeric) %>%
  summarise(wi_spp = sum(weights)/n_distinct(scientific_name)) %>%
  ungroup()

## Calculate status per Subbasin
spp_status_basin <- mutate(sum_and_nspp_wi_basin, status = 1 - wi_spp)
```


**Scale lower end so zero represents 75% extinct** 

Currently, dataset only includes observations (presence) data so there's no way to tell percentage of extinct species... Code was left in to be adapted for future BHI iterations when data can differentiate between unsuitable species and species that become regionally extinct.

```{r scale for 75 percent extinct for Subbasin}
## Filter, keeping regionally extinct species

spp_ex_basin <- spp_vuln %>%
                ## Add code here to only consider species that are supposed to be present (suitable for habitat)
                dplyr::rename(weights = red_list_category_numeric) %>%
                filter(weights == 1) # Filters out regionally extinct species (supposed to be present but absent)
spp_ex_basin

## Identify regionally extinct species

spp_ex_basin %>% select(scientific_name) %>% distinct() 

# Number of extinct species per basin

spp_ex_basin_n <- spp_ex_basin %>%
                  select(Subbasin,scientific_name) %>%
                  dplyr::count(Subbasin) %>%
                  dplyr::rename(n_extinct = n)

# Join to spp_status_basin

spp_status_basin <- spp_status_basin %>%
                    full_join(.,spp_ex_basin_n, by="Subbasin") %>%
                    mutate(n_extinct = ifelse(is.na(n_extinct),0,n_extinct))

# calculate % extinct in each subbasin and assign status score of 0 if >75%

spp_status_basin <- spp_status_basin %>%
                    mutate(prop_extinct = n_extinct / n,
                           status = ifelse(prop_extinct >= 0.75, 0, status))

```


**Plot status by basin**

```{r plot basin status}

# Plot status

ggplot(spp_status_basin) +
  geom_point(aes(Subbasin, round(status*100)), size=3) +
  ylim(0,100) +
  ylab("Status") + 
  xlab("Subbasin") +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6)) +
  ggtitle("SPP status by Subbasin")

# Size points based on number of species in a region

ggplot(spp_status_basin)+
  geom_point(aes(Subbasin, round(status*100), size=n)) +
  ylim(0,100) +
  ylab("Status") + 
  xlab("Subbasin") +
  scale_size(breaks =c(1200,1400,1600,1800), labels=c("1200","1400","1600","1800"))+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("SPP status by Subbasin, n= species richness")

```

<br>

#### 2.9.2 Status Approach 2: by Subbasin With Species Group and Regional Geometric Mean {-}

Status of subbasins was obtained by first calculating statuses according to species groups and taking the geometric mean for each basin. As with Approach 1, birds were not excluded.

```{r species group status calculation approach 2}

# Sum threat weights for each subbasin by species_group
  
sum_wi_basin_species_group <- shared_list_vuln %>%
              select(Subbasin, species_group, red_list_category_numeric) %>%
              dplyr::rename(weights = red_list_category_numeric) %>%
              group_by(Subbasin, species_group) %>%
              summarise(sum_wi =sum(weights)) %>%
              ungroup()

dim(sum_wi_basin_species_group) # 52  3

# Count number of species in each subbasin by species group

sum_spp_basin_species_group <- shared_list_vuln %>%
                select(Subbasin, species_group, scientific_name) %>%
                dplyr::count(Subbasin, species_group)

dim(sum_spp_basin_species_group) # 52 3

# Calculate status of species_group for each subbasin

spp_status_basin_species_group <- full_join(sum_wi_basin_species_group,
                                        sum_spp_basin_species_group, by=c("Subbasin","species_group")) %>%
             mutate(wi_spp_taxa = sum_wi/n,
                    status_taxa = 1 - wi_spp_taxa)

# Plot status by species_group (before scaling lower end)

ggplot(spp_status_basin_species_group)+
  geom_point(aes(species_group,status_taxa,size=n)) +
  facet_wrap(~Subbasin) +
  ylim(0,1.5) +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("Species_group Status by Subbasin, n = species richness")

```


**For each species group - Scale lower end to zero if 75% extinct**

Currently, dataset only includes presence data so no way to tell percentage of extinct species. Code was left in to be adapted for future BHI iterations when data can differentiate between unsuitable species and species that become regionally extinct. If no subbasins have 75% extinct species, there should be no change.

```{r scale for each species group if 75 percent extinct for subbasin}

# Filter regionally extinct species according to species_group

spp_ex_basin_species_group <- shared_list_vuln %>%
              # Add code here to only consider species that are supposed to be present (suitable for habitat)
              dplyr::rename(weights = red_list_category_numeric) %>%
              group_by(species_group) %>% 
              filter(weights == 1) %>%  # Check with Ellie what grouping before filtering does
              ungroup()

spp_ex_basin_species_group

# Identify regionally extinct species

spp_ex_basin_species_group %>% select(scientific_name) %>% distinct()


# Calculate number of extinct species per species group per subbasin

spp_ex_basin_n_species_group <- spp_ex_basin_species_group %>%
                  select(Subbasin, species_group,scientific_name)%>%
                  dplyr::count(Subbasin,species_group)%>%
                  dplyr::rename(n_extinct = n)


# Join to spp_status_basin_species_group

spp_status_basin_species_group <- spp_status_basin_species_group %>%
                   full_join(., spp_ex_basin_n_species_group, by=c("Subbasin", "species_group")) %>%
                   mutate(n_extinct = ifelse(is.na(n_extinct),0,n_extinct))

# calculate % extinct in each subbasin and assign status score of 0 if >75%

spp_status_basin_species_group <- spp_status_basin_species_group  %>%
                  mutate(prop_extinct = n_extinct / n,
                         status_taxa = ifelse(prop_extinct>=0.75, 0, status_taxa))

```


**Plot Final Status by Species_group**

```{r plot species_group status}

ggplot(spp_status_basin_species_group) +
  geom_point(aes(species_group,status_taxa,size=n)) +
  facet_wrap(~Subbasin) +
  ylim(0,1.5) +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6)) +
  ggtitle("Species group Status by Basin, n= species richness")

```


**Calculate Geometric Mean of Status for Subbasin**

```{r geometric mean status subbasin}

spp_status_basin_geo <- spp_status_basin_species_group %>%
                        select(Subbasin, status_taxa) %>%
                        group_by(Subbasin) %>%
                        summarise(status_basin =exp(mean(log(status_taxa)))) %>%
                        ungroup()
```


**Plot Geometric Mean for Subbasin Status**

```{r plot subbasin status from geometric mean}

ggplot(spp_status_basin_geo)+
  geom_point(aes(Subbasin, status_basin),size=2)+
  ylim(0,1)+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6))+
  ggtitle("SPP subbasin status from geometric mean of species group")

```

<br>

#### 2.9.3 Compare Alternative Approaches to Subbasin level SPP status calculation {-}

```{r comparsion of subbasin level spp status}

spp_status_basin <- spp_status_basin %>%
                    select(Subbasin,status) %>%
                    mutate(status_type = "all species")

spp_status_basin_geo <- spp_status_basin_geo %>%
                        dplyr::rename(status=status_basin) %>%
                        mutate(status_type = "species_group geometric mean")

basin_status_compare <- bind_rows(spp_status_basin, spp_status_basin_geo)


ggplot(basin_status_compare) +
  geom_point(aes(Subbasin, status, colour=status_type,shape=status_type),size=2) +
  ylim(0,1) +
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y =  element_text(colour="grey20",size=6)) +
  ggtitle("SPP Subbasin status Method Comparison")

```
