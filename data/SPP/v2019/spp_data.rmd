
## 2. Data Prep

```{r preamble data, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "setup.R"))
source(here::here("R", "spatial.R"))
```

### 2.1 Datasets with Sources
<br/>

**Species Presence, Observations and Red List Assessments**  
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/baltic_species/baltic_species.shp -->

To obtain data in shapefile format: downloaded, unzipped, opened (observations_final.gdb, observation_points layer) in QGIS, exported to shapefile

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Observations data ESRI Geodatabase (ZIP)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 9 March by Chester")
```

*These data are obtained from the HELCOM species database, compiled from original data sources: Shark SMHI, Species Observations System (Artportalen), MVM, and Entomological Collections (NHRS) from GBIF.*

<br>

**Red list (IUCN) information, about Species and their Assessment at HELCOM**  
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/species_with_redlist_category/species_with_redlist_category.csv -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Red list information data CSV")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 12 March by Ellie")
```

---

<br/>


### 2.2 Processing raw data into an easier format

#### 2.2.1 Set directory of raw data

Notes: Commands labelled "Edit 1" to be removed at final polish, added now due to lack of access to Gunvor

```{r load raw data, message = FALSE, echo = TRUE, warning = FALSE, results = "hide"}
## root location of the raw data
# dir_B <- "C:/Users/chest/Downloads"  # Edit 1 Tablet
dir_B <- "C:/Users/Chester Gan/Desktop" # Edit 1 Laptop
dir_rawdata <- file.path(dir_B)      # Edit 1
#dir_rawdata <- file.path(dir_B, "Goals", "BD")
```

#### 2.2.2 Adding regional data into dataset

**Remove spatial 'depth' dimension, and assign BHI Region IDs**

```{r remove z spatial dimension and assign BHI region ids}
## read in raw data
## need to rename columns, as names were shortened when exported to shapefile...
spp_raw <- sf::st_read(file.path(dir_rawdata, "raw_species_observations")) %>% 
   dplyr::rename(
    scientific_name = scientific, 
    accepted_name = accepted_n, 
    species_group = species_gr, 
    sampling_group = sampling_g,
    red_list_assessments = red_list_a,
    year_collected = year_colle
  )

# dir_B <- "C:/Users/chest/OneDrive/Documents/Thesis/Github/Shapefiles"  # Edit 1 Tablet
dir_B <- "C:/Users/Chester Gan/OneDrive/Documents/Thesis/Github/Shapefiles" # Edit 1 Laptop

buffer_sf <- st_read(
  file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"), 
  "BHI_shapefile_25km_buffer"
)
spp_w_rgns <- join_rgns_info(
  sf::st_zm(spp_raw),
  latlon_vars = c("decimal_la", "decimal_lo"),
  return_spatial = TRUE,
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
  buffer_shp = buffer_sf
)
```
#### 2.2.3 Save to BHI Database

```{r save species data}
if(!file.exists(file.path(dir_rawdata, "baltic_species"))){
  dir.create(file.path(dir_rawdata, "baltic_species"))
}
sf::st_write(spp_w_rgns, file.path(dir_rawdata, "baltic_species", "baltic_species.shp"))
```

### 2.3 Checking Data Attributes

```{r Dropping geometry column}

raw_obs_checklist <- sf::st_drop_geometry(spp_w_rgns)

```


#### 2.3.1 Taxa Represented 

```{r Check Taxa}

# Check representation of taxa

raw_obs_checklist %>%
  select(species_group) %>%
  distinct()  # Benthic Invertebrates, Fish and Lamprey, Macrophytes, Zooplankton, Bacteria, Phytoplankton, Mammals and Birds

# Check number of species within each taxa

raw_obs_checklist %>%
  group_by(species_group) %>%
  count()

ggplot(raw_obs_checklist, aes(x=species_group))+
   geom_bar(stat="count")+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Number of species in raw checklist")

## Number of unique latin names 
raw_obs_checklist %>% select(scientific_name)%>%distinct()%>%nrow() #2551 (Including Bacteria and Plankton)

```


#### 2.3.2 BHI ID and Basins

```{r create list BHI ID and Basins}

# Matching BHI ID to subbasins

basin_ID_namelist <- raw_obs_checklist %>%
  select(BHI_ID, Subbasin) %>%
  distinct() %>%
  arrange(.,BHI_ID)

# To see how many distinct basins represented

basins_distinct <- raw_obs_checklist %>% 
  select(Subbasin) %>% 
  distinct()

nrow(basins_distinct)  #18 basins -> One more than HOLAS basin number

# To check discrepancy in number of basins

HOLAS_Basins <- read.csv(file.path("C:/Users/Chester Gan/OneDrive/Documents/Thesis/Github/baltic2015/prep/SPP","distribution_locations.csv"), sep = ";", stringsAsFactors = FALSE) %>%
  select(basin) %>%
  distinct() %>%
  dplyr::rename(Subbasin = basin)

setdiff(basins_distinct, HOLAS_Basins)  # Discrepancy = spelling error in Bothian Sea

# Correct Spelling Error

raw_obs_checklist <- raw_obs_checklist %>% 
  mutate(Subbasin = as.character(Subbasin)) %>%
  mutate(Subbasin = ifelse(Subbasin == "Bothian Sea", "Bothnian Sea", Subbasin))

raw_obs_checklist %>% select(Subbasin) %>% distinct() %>% nrow()  #17 = Correct number

```

### 2.4 Organizing Data to Match 2015 Format

#### 2.4.1 Removing Unnecessary COlumns, Bacteria and Plankton Rows as well as observations before 2016

```{r remove bacteria plankton}
full_obs_checklist_2016 <- raw_obs_checklist %>%
  filter(year_collected >= 2016) %>%
  select(
    species_id,
    scientific_name,
    taxonomica,
    accepted_name,
    synonyms,
    species_group,
    year_collected,
    red_list_assessments,
    rgn_nam,
    Subbasin,
    BHI_ID
  ) %>%
  filter(!species_group %in% c("Bacteria", "Phytoplankton", "Zooplankton")) %>%
  mutate(list_type = "checklist")

# Checking filter

full_obs_checklist_2016 %>%
  group_by(species_group) %>%
  count()

# Number of unique species names

full_obs_checklist_2016 %>% select(scientific_name)%>%distinct()%>%nrow() #833

```

#### 2.4.2 Check to see if there are insects in dataset

```{r insect check}
# Use invert data set in 2015 to check for common insect species with current dataset

invert_insect_2015 <- read.csv(file.path("C:/Users/Chester Gan/OneDrive/Documents/Thesis/Github/baltic2015/prep/SPP/data_checklist_redlist", "invert_dist_checklist_alltaxalevels.csv"), sep= ";", stringsAsFactors = FALSE) %>%  # TO EDIT WITH BHI Filepath
  select(class, latin_name) %>%
  filter(class == "Insecta") %>%
  dplyr::rename(scientific_name = latin_name) %>%
  mutate(list_type = "2015")


insect_check <- intersect(unique(full_obs_checklist_2016$scientific_name), unique(invert_insect_2015$scientific_name))

length(insect_check)  #99 unique insect species, need to summarise insects to family level

# Use HELCOM species id list to identify insect species with current dataset (Approach 2)

helcom_insect_list <- read.csv(file.path("C:/Users/Chester Gan/Downloads", "species id HELCOM.csv"), stringsAsFactors = FALSE) %>%
  select(scientific_name, id, class) %>%
  filter(class == "Insecta")

helcom_insect_check <- intersect(unique(full_obs_checklist_2016$scientific_name), unique(helcom_insect_list$scientific_name))

length(helcom_insect_check) #105 unique insect species, need to summarise to family level

```

#### 2.4.3 Reorganise into Presence/Absence

**Reorganize into Presence/Absence data by BHI Region and Species**

Species only considered present when there at least 10 observations in each BHI region.

```{r presence absence species data}

# For species information to add to final presence/absence list

species_obs_info <- full_obs_checklist_2016 %>% 
  select(
    species_id, 
    scientific_name,
    taxonomica, 
    accepted_name, 
    synonyms, 
    species_group, 
    list_type
  ) %>% 
  distinct()

# Summarize number of observations per species per BHI region

species_obs_count <- full_obs_checklist_2016 %>%
  group_by(species_id, scientific_name, BHI_ID) %>%
  summarise(count = n()) 

# Filter those with >= 10 observations and add presence column

species_obs_present <- species_obs_count %>%
  filter(count >= 10) %>%
  mutate(presence = "1") %>%
  select(-count) # remove count column to prep for list joining

# Join with main observation list and make into Presence/Absence Data

full_presence_checklist <- full_obs_checklist_2016 %>%
  select(-year_collected, -red_list_assessments) %>% 
  distinct() %>% # To collapse all obs to 1 per species per BHI region
  left_join(.,species_obs_present) %>%
  arrange(.,BHI_ID) %>%
  mutate(presence = ifelse(is.na(presence), 0, presence)) %>%
  tidyr::pivot_wider(id_cols = species_id, names_from = BHI_ID, values_from = presence) %>%
  left_join(species_obs_info, by = "species_id")
  
# Replacing NAs with 0

full_presence_checklist[ , 2:40 ][is.na(full_presence_checklist[, 2:40 ])] <- 0  # Replacing NAs with 0


# ELLIE's OLD CODE, JUST FOR SAFETY

full_presence_checklist <- full_obs_checklist_2016 %>% 
  mutate(red_list_assessments = as.numeric(red_list_assessments)) %>% 
  group_by(BHI_ID, species_id) %>% 
  summarize(redlist_mean = mean(red_list_assessments, na.rm = TRUE)) %>% 
  ungroup() %>%
  tidyr::pivot_wider(id_cols = species_id, names_from = BHI_ID, values_from = redlist_mean) %>% 
  left_join(species_obs_info, by = "species_id") %>% 
  distinct()

```


#### 2.4.4 Read in Redlist and get Data Attributes

```{r redlist info}


```




<br/>

### 2.3 Initial Data Exploration


```{r}



```


#### 2.3.1 Compare versus Previous Years Data

#### 2.3.2 Timeseries Plots

```{r CODE CHUNK WITH FIGURE OR GRAPH, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5, fig.height = 4.5}
```

#### 2.3.3 Map


