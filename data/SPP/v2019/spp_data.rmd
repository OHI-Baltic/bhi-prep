
## 2. Data Prep

```{r preamble data, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "setup.R"))
source(here::here("R", "spatial.R"))
```

### 2.1 Datasets with Sources
<br/>

**Species Presence, Observations and Red List Assessments**  
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/baltic_species/baltic_species.shp -->

To obtain data in shapefile format: downloaded, unzipped, opened (observations_final.gdb, observation_points layer) in QGIS, exported to shapefile

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Observations data ESRI Geodatabase (ZIP)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 9 March by Chester")
```

*These data are obtained from the HELCOM species database, compiled from original data sources: Shark SMHI, Species Observations System (Artportalen), MVM, and Entomological Collections (NHRS) from GBIF.*

<br>

**Red list (IUCN) information, about Species and their Assessment at HELCOM**  
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/species_with_redlist_category/species_with_redlist_category.csv -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "Red list information data CSV")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 12 March by Ellie")
```

**Species ID, with taxanomic information for each species in HELCOM database**
<!-- dataset save location BHI_share/BHI 2.0/Goals/BD/species_with_redlist_category/species_with_redlist_category.csv --> TO EDIT!

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Tab:", "Download"), 
  c("Dataset:", "species id HELCOM csv")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM Biodiversity Database](http://maps.helcom.fi/website/Biodiversity/) <br/> Downloaded 4 April by Chester")
```

---

<br/>


### 2.2 Processing raw data into an easier format

#### 2.2.1 Set directory of raw data

Notes: Commands labelled "Edit 1" to be removed at final polish, added now due to lack of access to Gunvor

```{r load raw data, message = FALSE, echo = TRUE, warning = FALSE, results = "hide"}
## root location of the raw data
# dir_B <- "C:/Users/chest/Downloads"  # Edit 1 Tablet
dir_B <- "C:/Users/Chester Gan/Desktop" # Edit 1 Laptop
dir_rawdata <- file.path(dir_B)      # Edit 1
#dir_rawdata <- file.path(dir_B, "Goals", "BD")
```

#### 2.2.2 Adding regional data into dataset

**Remove spatial 'depth' dimension, and assign BHI Region IDs**

```{r remove z spatial dimension and assign BHI region ids}
## read in raw data
## need to rename columns, as names were shortened when exported to shapefile...
spp_raw <- sf::st_read(file.path(dir_rawdata, "raw_species_observations")) %>%
   dplyr::rename(
    scientific_name = scientific, 
    accepted_name = accepted_n, 
    species_group = species_gr, 
    sampling_group = sampling_g,
    red_list_assessments = red_list_a,
    year_collected = year_colle
  ) %>% 
  st_drop_geometry()

# dir_B <- "C:/Users/chest/OneDrive/Documents/Thesis/Github/Shapefiles"  # Edit 1 Tablet
dir_B <- "C:/Users/Chester Gan/OneDrive/Documents/Thesis/Github/Shapefiles" # Edit 1 Laptop

buffer_sf <- st_read(
  file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"), 
  "BHI_shapefile_25km_buffer"
)

rgns <- join_rgns_info(
  spp_raw %>% select(OBJECTID, decimal_la, decimal_lo),
  latlon_vars = c("decimal_la", "decimal_lo"),
  return_spatial = FALSE,
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
  buffer_shp = buffer_sf
)

spp_w_rgns <- left_join(
    rename(rgns, OBJECTID = objectid), 
    spp_raw,
    by = c("OBJECTID", "decimal_la", "decimal_lo")
)

write_csv(spp_w_rgns, file.path(dir_rawdata, "species_obs_w_rgns.csv"))
```
#### 2.2.3 Save to BHI Database

```{r save species data}
#if(!file.exists(file.path(dir_rawdata, "baltic_species"))){
 # dir.create(file.path(dir_rawdata, "baltic_species"))
#}
#sf::st_write(spp_w_rgns, file.path(dir_rawdata, "baltic_species", "baltic_species.shp"))
```

### 2.3 Checking Raw Data

```{r read in data}

raw_obs_checklist <- read.csv(file.path(dir_rawdata, "species_obs_w_rgns.csv"))

```


#### 2.3.1 Taxa Represented 

```{r Check Taxa}

# Check representation of taxa

raw_obs_checklist %>%
  select(species_group) %>%
  distinct()  # Benthic Invertebrates, Fish and Lamprey, Macrophytes, Zooplankton, Bacteria, Phytoplankton, Mammals and Birds

# Check number of species within each taxa

raw_obs_checklist %>%
  group_by(species_group) %>%
  count()

ggplot(raw_obs_checklist, aes(x=species_group))+
   geom_bar(stat="count")+
  theme(axis.text.x = element_text(colour="grey20",size=8,angle=90,hjust=.5,vjust=.5,face="plain"),axis.text.y = element_text(colour="grey20",size=6))+
  ggtitle("Number of species in raw checklist")

## Number of unique latin names 
raw_obs_checklist %>% select(scientific_name)%>%distinct()%>%nrow() #2958 (Including Bacteria and Plankton)

```


#### 2.3.2 BHI ID and Basins

```{r create list BHI ID and Basins}

# Matching BHI ID to subbasins

basin_ID_namelist <- raw_obs_checklist %>%
  select(BHI_ID, Subbasin) %>%
  na.omit() %>%
  distinct() %>%
  arrange(.,BHI_ID)

# To see how many distinct basins represented

basins_distinct <- raw_obs_checklist %>% 
  select(Subbasin) %>% 
  na.omit() %>%
  distinct()

nrow(basins_distinct)  #17 basins -> Correct number

```

### 2.4 Initial Data Organization

#### 2.4.1 Removing Unnecessary Columns, Bacteria and Plankton, rows without basin location data as well as all observations before 2016

```{r remove bacteria plankton <2016}

full_obs_checklist_2016 <- raw_obs_checklist %>%
  filter(year_collected >= 2016) %>%
  select(
    species_id,
    scientific_name,
    taxonomica,
    accepted_name,
    synonyms,
    species_group,
    year_collected,
    red_list_assessments,
    rgn_nam,
    Subbasin,
    BHI_ID
  ) %>%
  filter(!species_group %in% c("Bacteria", "Phytoplankton", "Zooplankton")) %>%
  filter(!is.na(Subbasin)) %>%
  mutate(list_type = "checklist")


# Checking filter

full_obs_checklist_2016 %>%
  group_by(species_group) %>%
  count()

sum(is.na(full_obs_checklist_2016$rgn_nam)) #0 -> NA entries have been filtered out and there are no NAs in rgn_nam

# Number of unique species names

full_obs_checklist_2016 %>% select(scientific_name)%>%distinct()%>%nrow() #833

```

#### 2.4.2 Separating Insects from Other Taxa

Due to similar concerns as those raised in BHI 1.0, insect species in the current dataset needed to be summarized to family level before being scored. For convenience, insect species were first separated to be wrangled separately from other taxa.

Two approaches were considered in order to check current dataset for insect species. Ultimately, approach 2 (with HELCOM species data) was considered more robust and selected for use. 

```{r separate insects}

# Insect Check

# Approach 1: Use invert data set in 2015 to check for common insect species with current dataset

invert_insect_2015 <- read.csv(file.path("C:/Users/Chester Gan/OneDrive/Documents/Thesis/Github/baltic2015/prep/SPP/data_checklist_redlist", "invert_dist_checklist_alltaxalevels.csv"), sep= ";", stringsAsFactors = FALSE) %>%  # TO EDIT WITH BHI Filepath
  select(class, latin_name) %>%
  filter(class == "Insecta") %>%
  dplyr::rename(scientific_name = latin_name) %>%
  mutate(list_type = "2015")


insect_check <- intersect(unique(full_obs_checklist_2016$scientific_name), unique(invert_insect_2015$scientific_name))

length(insect_check)  #99 unique insect species, need to summarise insects to family level

# Approach 2: Use HELCOM species id list to identify insect species with current dataset 

helcom_insect_list_all_taxa <- read.csv(file.path("C:/Users/Chester Gan/Downloads", "species.csv"), sep= ";", stringsAsFactors = FALSE)

helcom_insect_list <- helcom_insect_list_all_taxa %>%
  select(scientific_name, id, class) %>%
  filter(class == "Insecta")

helcom_insect_check <- intersect(unique(full_obs_checklist_2016$scientific_name), unique(helcom_insect_list$scientific_name))

length(helcom_insect_check) #105 unique insect species, need to summarise to family level

# Separating Insect data from other taxa (Using info from Approach 2)

obs_checklist_insect <- full_obs_checklist_2016 %>%
  filter(scientific_name %in% helcom_insect_check) %>%
   select(
    species_id, 
    scientific_name,
    taxonomica, 
    accepted_name, 
    synonyms, 
    species_group,
    Subbasin,
    list_type)

obs_checklist_no_insect <- full_obs_checklist_2016 %>%
  filter(!scientific_name %in% helcom_insect_check) %>%
   select(
    species_id, 
    scientific_name,
    taxonomica, 
    accepted_name, 
    synonyms, 
    species_group,
    Subbasin,
    list_type)

```

#### 2.5 Data Prep for all other taxa (except Insecta) 


#### 2.5.1 Instituting threshold for presence

Observation data needs to be given a threshold for species to be considered present. This is to avoid any rare occurrences of an individual being mistaken for species establishment. Based on the solution proposed in BHI 1.0, species will only be considered present when there at least 10 observations in each BHI region.

Only species that are present are being scored as current data set only consists of observations and it will be too inaccurate to assume lack of observations = absence of species. Check BHI issues for full account of this problem.

```{r presence threshold no_insect species data}

# Summarize number of observations per species per Subbasin region

species_obs_count_no_insect <- obs_checklist_no_insect %>%
  group_by(species_id, scientific_name, Subbasin) %>%
  summarise(count = n()) 

# Filter those with >= 10 observations and add presence column

species_obs_present_no_insect <- species_obs_count_no_insect %>%
  filter(count >= 10) %>%
  mutate(presence = "1") %>%
  select(-count) # remove count column to prep for list joining

# Join with main observation list to show presence/absence

species_checklist_no_insect <- obs_checklist_no_insect %>%
  distinct() %>% # To collapse all obs to 1 per species per Subbasin region
  left_join(.,species_obs_present_no_insect) %>%
  filter(presence == "1") %>%
  arrange(.,scientific_name) %>%
  select(-presence) # remove presence column as only presence data being considered in BHI 1.0

```


#### 2.5.2 Read in Redlist and get Data Attributes

```{r redlist info}

redlist <- read.csv(file.path("C:/Users/Chester Gan/Downloads", "species_with_redlist_category.csv"), sep= ";", stringsAsFactors = FALSE) %>%
  dplyr::rename(scientific_name = species_scientific_name) %>%
  select(-id) # Remove redundant id column

# Number of species in redlist

redlist %>% select(scientific_name) %>% distinct() %>% nrow()  #2771

# Check assessment years

redlist %>% select(assessment_year_red_list) %>% distinct()  #2007 and 2013

# Add list_type column

redlist <- redlist %>%
  mutate(list_type = "redlist")

## Question: Redlist no taxa data, do we still need a taxa plot as per BHI 1,0?


```

#### 2.5.3 Getting Common Species List between Checklist and Redlist

Need to first join and retain all species in order to check for possible spelling mismatches.


<br/>

### 2.3 Initial Data Exploration


```{r}



```


#### 2.3.1 Compare versus Previous Years Data

#### 2.3.2 Timeseries Plots

```{r CODE CHUNK WITH FIGURE OR GRAPH, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5, fig.height = 4.5}
```

#### 2.3.3 Map


