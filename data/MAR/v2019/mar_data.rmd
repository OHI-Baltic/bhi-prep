## 2. Data

**Rainbow trout production (Denmark, Sweden and Finland) and Finfish (Denmark, Germany, Sweden and Finland)**

```{r Preamble, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "setup.R"))
library(readr)
library(sf)
library(R.utils)
```

### 2.1 Datasets with Sources
<br/>

**Rainbow trouts mariculture**  

- **Sweden**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_se -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("PDF:", "Vattenbruk 2018"), 
  c("Location data:", "Page 7, table A")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Jorbruksverket database](https://www.scb.se/hitta-statistik/statistik-efter-amne/jord-och-skogsbruk-fiske/vattenbruk/vattenbruk/) <br/> [Jorbruksverket](https://www.scb.se/contentassets/cef2fb103630496bb532e76c98f747e6/jo1201_2018a01_sm_jo60sm1901.pdf) Downloaded 2019-10-09 by Andrea De Cervo")
```

<br/>

- **Denmark**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_dk -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Faste tabeller med akvakulturststistik:", "Produktion af hovedarter fordelt på region"), 
  c("Rows:", "Regnbueørred, Saltvand")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Ministry of Environment and Food of Denmark database](https://fiskeristyrelsen.dk/fiskeristatistik/akvakulturstatistik/) <br/> Downloaded 2019-10-11 by Andrea De Cervo")
```

<br/>

- **Finland**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_fi -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Luke statistics database:", "Food fish production by species"), 
  c("Production:", "Quantity (1 000 kg)"),
  c("Area:", "Sea"),
  c("Fish:", "Rainbow trout"),
  c("Year:", "All")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Natural Resources Institute database](http://statdb.luke.fi/PXWeb/pxweb/en/LUKE/LUKE__06%20Kala%20ja%20riista__02%20Rakenne%20ja%20tuotanto__10%20Vesiviljely/?tablelist=true&rxid=ef8a2896-d6cb-4660-a8aa-fee93bd4212f) <br/> Downloaded 2019-10-10 by Andrea De Cervo")
```

<br/>

- **Germany**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_de -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Location:", "Kiel Bay")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Email from plant manager](tassilo@jaeger-kleinicke.de) <br/> Received 2019-10-30")
```

<br/>

**Finfish Mariculture**  
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/Finfish_mariculture -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("HELCOM Map and Data service:", "Pressures and human activities"), 
  c("Human activities:", "Finfish mariculture")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM database](http://maps.helcom.fi/website/mapservice/?datasetID=3cfa469a-6a78-4913-b82f-57fd0e7f4dc0) <br/> (http://metadata.helcom.fi/geonetwork/srv/eng/catalog.search#/metadata/3cfa469a-6a78-4913-b82f-57fd0e7f4dc0) <br/> Downloaded 2019-10-09 by Andrea De Cervo")
```

<br/>

**All Baltic countries**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/FAO_fishstat -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("FAO FishStatJ:", "Global aquaculture production"), 
  c("Quantity:", "1950-2017")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [FAO FishStatJ](http://www.fao.org/fishery/statistics/software/fishstatj/en#downlApp) <br/> Downloaded 2019-10-16 by Andrea De Cervo")
```

<br/>

#### Reference Point: maximum nutrient discharge (N/P)

In 2016 HELCOM Contracting Parties adopted Recommendation 37/3 on ["Sustainable aquaculture in the Baltic Sea Region"](http://www.helcom.fi/Recommendations/Rec%2037-3.pdf). 

However, the only parameter that can be used as reference point for Mariculture subgoal in the Baltic Sea (that can be also found on Finfish Mariculture data provided by HELCOM) is the [maximum nutrient discharge for P and N](http://www.helcom.fi/Recommendations/Rec%2025-4.pdf), where existing and new marine fish farms should not exceed the annual average of: 
- 7g of P (tot-P) 
- 50g of N (tot-N) 
per 1kg fish (living weight) produced.
(The nutrient limit values (P and N) are calculated on the basis that living fish contains 0,4% of phosphorus and 2,75% of nitrogen.)

This recommendation was adopted in 2004, but since there are not updated nutrient limit values, this will be the parameter used as reference point.

Only data provided by HELCOM on finfish mariculture include nutrient discharge. 
However, nutrient inputs from fish farms in Denmark were calculated on the basis of production data, and some numbers that were missing on nutrient input in Sweden were calculated by SCB, Statistics Sweden based on average input/ amount produced fish.
Therefore, estimates for all other datasets will be made.

### 2.2 Centralization & Normalization

```{r load raw data, message = FALSE, warning = FALSE, echo = TRUE}
## root location of the raw data
dir_rawdata <- file.path(dir_B, "Goals", "FP", "MAR") # list.files(dir_rawdata)

## rainbow trout data
rbt_de_raw <- read_delim(file.path(dir_rawdata, "rbt_de", "rbt_de.csv"), delim = ";")
rbt_dk_raw <- read_delim(file.path(dir_rawdata, "rbt_dk", "rbt_dk.csv"), delim = ";")
rbt_dk2005raw <- read_delim(file.path(dir_rawdata, "rbt_dk", "rbt_dk_2005.csv"), delim = ";")
rbt_fi_raw <- read_delim(file.path(dir_rawdata, "rbt_fi", "rbt_fi.csv"), delim = ";")
rbt_se_raw <- read_delim(file.path(dir_rawdata, "rbt_se", "rbt_se.csv"), delim = ";")

## FAO rainbow trout data
fao_rbt_raw <- read_delim(file.path(dir_rawdata, "FAO_fishstat", "FAO_fishstat.csv"), delim = ";")

# countrycodes for FAO dataset
countrycode <- data.frame(
  area = c("Germany", "Denmark", "Estonia", "Finland","Sweden"),
  country = c("DE", "DK", "ES", "FI", "SE")
)

## HELCOM Finfish mariculture data
# this is spatial data so we need to remove the geometry column
# also need to convert many columns from factor to numeric
finfish_mariculture_raw <- sf::st_read(file.path(dir_rawdata, "Finfish_mariculture", "Finfish_mariculture.shp"))
st_geometry(finfish_mariculture_raw) <- NULL
finfish_mariculture_raw[, 8:28] <- sapply(finfish_mariculture_raw[, 8:28], as.numeric)
finfish_mariculture_raw[, 1:7] <- sapply(finfish_mariculture_raw[, 1:7], as.character)

## match areas with bhi regions
## create lookup tab
bhiregions <- bind_rows(
  ## germany
  c(country = "DE", area = "Kiel Bay", rgn = 8),
  ## denmark
  c(country = "DK", area = "Arhus_cty", rgn = 3),
  c(country = "DK", area = "Vejle_cty", rgn = 3),
  c(country = "DK", area = "Fyns_cty", rgn = 3),
  c(country = "DK", area = "Sønderjylland_cty", rgn = 3),
  c(country = "DK", area = "Nordjyllands_cty", rgn = 2),
  c(country = "DK", area = "Frederiksborg_cty", rgn = list(2, 6)),
  c(country = "DK", area = "Roskilde_cty", rgn = 12),
  c(country = "DK", area = "Storstrøms_cty", rgn = list(3, 7, 9, 12)),
  c(country = "DK", area = "Vestsjællands_cty", rgn = list(2, 3)),
  c(country = "DK", area = "Hovedstaden", rgn = list(2, 12, 15)),
  c(country = "DK", area = "Sjælland", rgn = list(2, 3, 7, 9, 12)),
  c(country = "DK", area = "Syddanmark", rgn = 3),
  c(country = "DK", area = "Midtjylland", rgn = list(2, 3)),
  c(country = "DK", area = "Belts Danish coastal waters", rgn = 3),
  c(country = "DK", area = "Bornholm Basin", rgn = 15),
  c(country = "DK", area = "Arkona Basin", rgn = 12),
  ## sweden
  c(country = "SE", area = "Ne_coast", rgn = list(37, 39, 41)),
  c(country = "SE", area = "Other_coasts", rgn = list(29, 35, 37, 26, 14, 11, 5, 1)),
  c(country = "SE", area = "Kalmar lan", rgn = 26),
  c(country = "SE", area = "Gavleborgs lan", rgn = 37),
  c(country = "SE", area = "Vasternorrlands lan", rgn = 37),
  c(country = "SE", area = "Stockholm lan", rgn = list(35, 29)),
  c(country = "SE", area = "Vasterbottens lan", rgn = list(41, 39)),
  c(country = "SE", area = "Norrbottens lan", rgn = 41),
  c(country = "SE", area = "Aland Sea", rgn = 35),
  c(country = "SE", area = "Western Gotland Basin", rgn = 26),
  c(country = "SE", area = "Bornholm Basin", rgn = 14),
  c(country = "SE", area = "The Sound", rgn = 5),
  c(country = "SE", area = "Bothnian Sea", rgn = list(37, 41)),
  ## finland
  c(country = "FI", area = "Archipelago Sea", rgn = 36),
  c(country = "FI", area = "Bothnian Sea", rgn = 38),
  c(country = "FI", area = "Gulf of Finland", rgn = 32),
  c(country = "FI", area = "Bothnian Bay", rgn = 42),
  c(country = "FI", area = "The Quark", rgn = 40)
)
bhiregions[, 3:11] <- sapply(bhiregions[, 3:11], as.numeric)
bhiregions <- bhiregions %>% 
  tidyr::pivot_longer(cols = 3:11,  names_to = "num", values_to = "region_id") %>% 
  filter(!is.na(region_id)) %>% 
  select(country, area, region_id)
```

#### 2.2.0 Merge datasets and calculate maximum nutrient discharge (N/P) 

```{r merge rainbow trout rawdata, echo = TRUE}
rbt_raw <- rbind(
  
  ## rbt_de rainbow trout germany
  rbt_de_raw %>% 
    dplyr::rename(farm_species = production) %>% 
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species) %>%
    dplyr::mutate(
      produced_tonnes = as.numeric(produced_tonnes),
      country = "DE",
      p_kg = "",
      n_kg = "",
      ## join with max nutrient input value
      maxP_kg = 0.007*(as.numeric(produced_tonnes)*1000), 
      maxN_kg = 0.05*(as.numeric(produced_tonnes)*1000),
      source = "national",
      area = capitalize(area),
      area = str_replace(area,"Kiel_bay","Kiel Bay")
    ) %>% 
    select(year, country, area, farm_species, produced_tonnes, p_kg, maxP_kg, n_kg, maxN_kg, source) %>% 
    arrange(country),
  
  ## rbt_dk2005 rainbow trout 2005 denmarks
  rbt_dk2005raw %>% 
    dplyr::select(-tot_wt_ton) %>% 
    dplyr::rename(
      farm_species = production,
      arhus_cty = cty1, 
      vejle_cty = cty2,
      fyns_cty = cty3,
      sønderjylland_cty = cty4,
      ribe_cty = cty5,
      ringkøbing_cty = cty6,
      viborg_cty = cty7,
      nordjyllands_cty = cty8,
      frederiksborg_cty = cty9,
      roskilde_cty = cty10,
      storstrøms_cty  = cty11,
      vestsjællands_cty = cty12
    ) %>% 
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species) %>% 
    # filter out the counties on the Atlantic coasts
    filter(
      !(area == "viborg_cty"),
      !(area == "ringkøbing_cty"),
      !(area == "ribe_cty")
    ) %>% 
    dplyr::mutate(
      country = "DK",
      p_kg = "",
      n_kg = "",
      maxP_kg = 0.007*(as.numeric(produced_tonnes)*1000), 
      maxN_kg = 0.05*(as.numeric(produced_tonnes)*1000),
      source = "national",
      area = capitalize(area)
    ) %>% 
    arrange(country),
  
  ## rbt_dk rainbow trout denmark
  rbt_dk_raw %>% 
    dplyr::rename(
      farm_species = production,
      denmark = tot_wt_ton,
      hovedstaden = "reg1", 
      sjælland = "reg2",
      syddanmark = "reg3",
      midtjylland = "reg4"
    ) %>% 
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species) %>% 
    dplyr::mutate(
      country = "DK",
      p_kg = "",
      n_kg = "",
      maxP_kg = 0.007*(as.numeric(produced_tonnes)*1000), 
      maxN_kg = 0.05*(as.numeric(produced_tonnes)*1000),
      source = "national",
      area = capitalize(area)
    ) %>% 
    arrange(country),
  
  ## rbt_fi rainbow trout finland
  rbt_fi_raw %>% 
    dplyr::rename(
      produced_tonnes = tot_wt_tonnes, 
      farm_species = production
    ) %>% 
    dplyr::mutate(
      country = "FI", area = "finland",
      p_kg = "",
      n_kg = "",
      maxP_kg = 0.007*(as.numeric(produced_tonnes)*1000), 
      maxN_kg = 0.05*(as.numeric(produced_tonnes)*1000),
      source = "national",
      area = capitalize(area)
    ) %>% 
    arrange(country),
  
  ## rbt_se rainbow trout sweden
  rbt_se_raw %>% 
    dplyr::rename(
      farm_species = production,
      sweden = tot_wt_mtonnes
    ) %>% 
    select(-ne_farm_no, -other_farm_no) %>%  # don't need these information 
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species) %>% 
    mutate(
      country = "SE",
      p_kg = "",
      n_kg = "",
      maxP_kg = 0.007*(as.numeric(produced_tonnes)*1000), 
      maxN_kg = 0.05*(as.numeric(produced_tonnes)*1000),
      source = "national",
      area = capitalize(area)
    ) %>% 
    arrange(country),
  
  ## fao_rbt fao data on rainbow trout
  fao_rbt_raw %>% 
    dplyr::rename(
      area = country,
      farm_species = species
    ) %>% 
    filter(
      str_detect(str_to_lower(farm_species), "rainbow trout"), 
      !(environment == "Marine" & area == "Denmark")
    ) %>% 
    select(-aqua_area, -Unit, -environment, -("1950":"1971")) %>%
    tidyr::gather(key = "year", value = "produced_tonnes", -area, -farm_species) %>% 
    ## remove characters from production
    mutate(
      ## WHAT DOES F STAND FOR? 
      ## ARE THESE STILL TONNES OR NUMBER OF FISH, OR IS IT A DATA/QUALITY FLAG?
      produced_tonnes = str_replace(produced_tonnes,"F", " "), 
      produced_tonnes = as.numeric(produced_tonnes),
      p_kg = NA,
      n_kg = NA,
      maxP_kg = 0.007*(as.numeric(produced_tonnes)*1000), 
      maxN_kg = 0.05*(as.numeric(produced_tonnes)*1000),
      source = "fao",
      area = capitalize(area)
    ) %>% 
    ## join with countrycode data
    left_join(countrycode, by = "area") %>% 
    arrange(country)
)

## reassign types and join bhi region_ids by area
## use lookup table defined in code chunk above
rbt_raw[, c(5:9)] <- sapply(rbt_raw[, c(5:9)], as.numeric) 
rbt_raw_wRgns <- rbt_raw %>% 
  left_join(bhiregions, by = c("country", "area")) %>% 
  arrange(country)
str(rbt_raw_wRgns)
```

```{r merge finfish rawdata, echo = TRUE}
## wrangling finfish data so can merge with other datasets
finfish_raw <- as_tibble(finfish_mariculture_raw) %>% 
  mutate(SUBBASIN = ifelse(is.na(SUBBASIN), COUNTY, SUBBASIN)) %>% 
  dplyr::rename(
    area = SUBBASIN,
    farm_species = PRODUCTION,
    country = COUNTRY
  ) %>% 
  ## remove the facilities on land
  ## these are entries with any of NA, on land, or On land as 'AREA'
  ## are we sure that 'NA' value for AREA means that it is on land? there are so many NAs, leaves only "SE" "DK" "FI" data...
  filter(is.na(AREA) |!str_detect(str_to_lower(AREA), "on land"),
         !(area == "Bay of Mecklenburg")) %>% 
  tibble::rowid_to_column("ID") %>% 
  ## replace NA value with general mariculture name 'finfish'
  mutate(
    area = str_replace(area,"Sland Sea","Aland Sea"),
    AREA = str_replace(AREA, ",", "."),
    farm_species = ifelse(
      is.na(farm_species), 
      "finfish",  ifelse(
        str_detect(farm_species, "Rainbow trout"),
        "Rainbow trout", farm_species
      )
    )
  ) %>% select(-AREA, -NAME, -COMMENTS)

## rename names within AREA without <?> symbols
arealookup <- data.frame(
  fix_area = c(
    "Kalmar lan",
    "Gavleborgs lan",
    "Vasternorrlands lan",
    "Vasternorrlands lan",
    "Stockholm lan",
    "Vasterbottens lan",
    "Norrbottens lan"
  ),
  area = unique(finfish_raw$area)[1:7]
)
arealookup[,] <- sapply(arealookup[,], as.character)

## gather production, phosphorus and nitrogen vars by year
spreadcols <- names(finfish_raw)[1:5]
gathercols <- names(finfish_raw)[6:26]

finfish_gather_yr <- as_tibble(finfish_raw) %>% 
  pivot_longer(cols = gathercols, names_to = "varyear", values_to = "value") %>% 
  mutate(
    year = str_extract(varyear, pattern = "[0-9]{4}"),
    var = str_extract(varyear, pattern = "[A-Z]+")
  ) %>% 
  filter(!is.na(year)) %>%  # filter out na years as these represent aggregated values, but keep NA values

  ## re-spread data by the three variables: production (PR), nitrogen (N), and phosphorus (P)
  tidyr::pivot_wider(id_cols = c(spreadcols, "year", "ID"), names_from = var, values_from = value) %>% 
  rename(
    produced_tonnes = PR,
    n_kg = N,
    p_kg = P
  ) %>% 
  mutate(
    maxP_kg = 0.007 * (produced_tonnes * 1000),
    maxN_kg = 0.05 * (produced_tonnes * 1000),
    source = "helcom",
    ID = as.factor(ID)
  ) %>% 
  ## keep only necessary columns
  select(year, country, area, farm_species, produced_tonnes, p_kg, maxP_kg, n_kg, maxN_kg, source, ID) %>% 
  ## join the renamed areas
  left_join(arealookup, by = "area") %>%
  mutate(area = ifelse(!is.na(fix_area), fix_area, area)) %>%
  rename(farm_ID = ID) %>% 
  select(-fix_area)

str(finfish_gather_yr)
```


```{r combine into a single harmonized dataset save, echo = TRUE}
# Make the columns no equal among datasets
finfish_wRgns <- finfish_gather_yr %>% 
  select(-farm_ID) %>% 
  left_join(bhiregions, by = c("country", "area")) %>% 
  arrange(country)

# Combine the datasets and add the ID column
combined_rawdata <- rbind(rbt_raw_wRgns, finfish_wRgns) %>% 
  tibble::rowid_to_column("farm_ID") 

combined_rawdata[, c(6:10)] <- sapply(combined_rawdata[, c(6:10)], as.numeric) 
str(combined_rawdata)

# readr::write_csv(combined_rawdata, here::here("data", "MAR", version_year, "mar_full_nmerged_dataset.csv"))
```

```{r investigate nutrient estimates with linear models}
## check relationships between production and nutrients
## quite linear, so probably ok to gapfill using this relationship...
plotdf <- filter(combined_rawdata, !is.na(p_kg) & !is.na(n_kg), produced_tonnes > 0)
plotly::ggplotly(
  ggplot(plotdf) + 
    geom_abline(
      slope = coef(p_mdl)[["produced_tonnes"]],
      intercept = coef(p_mdl)[["(Intercept)"]], 
      color = "grey"
    ) +
    geom_point(aes(x = produced_tonnes, y = p_kg), color = "blue", alpha = 0.75)
)
p_mdl <- lm(p_kg ~ produced_tonnes, data = plotdf) # summary(p_mdl)
n_mdl <- lm(n_kg ~ produced_tonnes, data = plotdf) # summary(n_mdl)
```

```{r gapfilling nutrient estimates}
## create dataset with nutrient ESTIMATES (kg) from COMBINED data
combined_gf <- combined_rawdata %>% 
  mutate(gapfill_nutrients = ifelse(is.na(p_kg) & is.na(n_kg), TRUE, FALSE)) %>% 
  ## estimates based on production
  ## where no production, doesn't make sense to gapfill...
  cbind(
    estim_p_kg = predict(p_mdl, combined_rawdata),
    estim_n_kg = predict(n_mdl, combined_rawdata)
  ) %>% 
  ## averaged values by region id
  # group_by(region_id) %>% 
  # mutate(
  #   avg_p_kg = mean(estim_p_kg, na.rm = TRUE),
  #   avg_n_kg = mean(estim_n_kg, na.rm = TRUE)
  # )
  

combined_raw3 <- combined_raw %>% 
  group_by(rgn_id) %>%
  summarize(new2av_p_kg = mean(value_p_kg, na.rm=TRUE),
            new2av_n_kg = mean(value_n_kg, na.rm = TRUE))

## join all datasets
nutrients1 <- combined_raw %>% 
  left_join(combined_raw1, by = "area") %>% 
  arrange(country) 

nutrients2 <- nutrients1 %>% 
  left_join(combined_raw2, by = "produced_tonnes") %>%
  arrange(country) 

nutrients3 <- nutrients2 %>% 
  left_join(combined_raw3, by = "rgn_id") %>%
  arrange(country) 

combined_raw_est <- as_tibble(nutrients3) %>% 
  mutate(newav_p_kg = ifelse(is.na(newav_p_kg), new2av_p_kg, newav_p_kg),
         newav_n_kg = ifelse(is.na(newav_n_kg), new2av_n_kg, newav_n_kg),
         av_p_kg = ifelse(is.na(av_p_kg), newav_p_kg, av_p_kg),
         av_n_kg = ifelse(is.na(av_n_kg), newav_n_kg, av_n_kg),
         value_p_kg = ifelse(is.na(value_p_kg), av_p_kg, value_p_kg),
         value_n_kg = ifelse(is.na(value_n_kg), av_n_kg, value_n_kg)
  ) %>% 
  mutate(new_p_kg = value_p_kg*(produced_tonnes*1000),
         new_n_kg = value_n_kg*(produced_tonnes*1000)
  ) %>% 
  mutate(p_kg = ifelse(is.na(p_kg), new_p_kg, p_kg),
         n_kg = ifelse(is.na(n_kg), new_n_kg, n_kg)
  ) %>% 
  select(-new2av_p_kg, -new2av_n_kg, -newav_p_kg, -newav_n_kg, -av_p_kg, -av_n_kg, -value_p_kg, -value_n_kg, -new_p_kg, -new_n_kg)
```

```{r}
## create dataset with nutrient ESTIMATES (kg) from HELCOM data

helcom <- finfish_raw3 %>% 
  mutate(value_p_kg = p_kg/(produced_tonnes*1000),
         value_n_kg = n_kg/(produced_tonnes*1000)
         ) 
## create average values by region_id
helcom1 <- helcom %>% 
  group_by(rgn_id) %>%
  summarize(av_p_kg = mean(value_p_kg, na.rm=TRUE),
            av_n_kg = mean(value_n_kg, na.rm = TRUE))

## create average values by production (for NA values) 
helcom2 <- helcom %>% 
  group_by(produced_tonnes) %>%
  summarize(newav_p_kg = mean(value_p_kg, na.rm=TRUE),
            newav_n_kg = mean(value_n_kg, na.rm = TRUE))

## join both the datasets
nutrients1 <- helcom %>% 
  left_join(helcom1, by = "rgn_id") %>% 
  arrange(country) 

nutrients2 <- nutrients1 %>% 
  left_join(helcom2, by = "produced_tonnes") %>%
  arrange(country) 

helcom3 <- as_tibble(nutrients2) %>% 
  mutate(av_p_kg = ifelse(is.na(av_p_kg), newav_p_kg, av_p_kg),
         av_n_kg = ifelse(is.na(av_n_kg), newav_n_kg, av_n_kg),
         value_p_kg = ifelse(is.na(value_p_kg), av_p_kg, value_p_kg),
         value_n_kg = ifelse(is.na(value_n_kg), av_n_kg, value_n_kg)
  ) %>% 
  mutate(new_p_kg = value_p_kg*(produced_tonnes*1000),
         new_n_kg = value_n_kg*(produced_tonnes*1000)
  ) %>% 
  mutate(p_kg = ifelse(is.na(p_kg), new_p_kg, p_kg),
         n_kg = ifelse(is.na(n_kg), new_n_kg, n_kg)
  ) %>% 
  select(-newav_p_kg, -newav_n_kg, -av_p_kg, -av_n_kg, -value_p_kg, -value_n_kg, -new_p_kg, -new_n_kg)

str(helcom3)
```


#### 2.2.1 Standardize Units: Match BHI Regions to different areas (counties, regions)

<!-- need to work on this -->
```{r map how the ICES and BHI regions overlap, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5}
source(file.path(here::here(), "R", "spatial.R"))
regions_shape() # loads spatial features objects

## ICES shapefile has crs EPSG:3035
## https://spatialreference.org/ref/epsg/etrs89-etrs-laea/
## transform to match BHI crs of EPSG:4326, and simplify

ices_transform <- rmapshaper::ms_simplify(input = ICES_rgns_shp) %>% 
  sf::st_as_sf() %>% 
  sf::st_transform(crs = 4326)
bhi_rgns_simple <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% 
  sf::st_as_sf() # also simplify BHI shp for plotting

map_bhi_ices <- ggplot2::ggplot() + 
  ## baltic countries borders
  geom_sf(
    data = rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
      st_crop(xmin = 0, xmax = 40, ymin = 53, ymax = 67),
    fill = "ivory", 
    size = 0.1
  ) +
  ## ICES areas
  geom_sf(
    data = ices_transform, 
    aes(fill = ICES_area), 
    color = NA,
    alpha = 0.5
  ) +
  scale_fill_manual(values = colorRampPalette(RColorBrewer::brewer.pal(9, "Set3"))(14)) +
  # scale_fill_manual(values = as.vector(pals::kelly(n = 14))) + # library(pals)
  # scale_fill_manual(values = colorRampPalette(beyonce_palette(127))(14)) + # library(beyonce)
  labs(fill = "ICES Subdivisions", x = NULL, y = NULL) +
  ## BHI regions with ID numbers
  geom_sf(data = bhi_rgns_simple, fill = NA, size = 0.15, color = "grey40") +
  scale_x_continuous(limit = c(5, 37)) +
  scale_y_continuous(limit = c(53.5, 66)) +
  theme(
    panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3"),
    legend.position = c(0.9, 0.6)
  )
map_bhi_ices + geom_sf_text(data = bhi_rgns_simple, aes(label = BHI_ID)) 
```


#### 2.2.2 Rename Fields/Variables

#### 2.2.3 Save to BHI Database

<br/>

### 2.3 Initial Data Exploration

```{r initial data exploration by national data first}
## Checking all variables before plotting them

## Germany
germany <- combined_rawdata %>% 
  filter(country == "DE",
         year %in% 1999:2019)
# str(germany)
ggplot2::ggplot(germany) +
  geom_col(aes(year, produced_tonnes, fill = area), position = position_dodge()) +
  labs(title = "German production (tons) 1999-2019")
```


```{r initial data exploration by national data first}
## Denmark
denmark <- combined_rawdata %>% 
  filter(country == "DK", 
         source == "national",
         !is.na(produced_tonnes))
ggplot2::ggplot(denmark) +
  geom_col(aes(year, produced_tonnes, fill = area), position = position_dodge()) +
  labs(title = "Danish production (tons) 2005-2017")
```


```{r initial data exploration by national data first}
## Finland
finland <- combined_rawdata %>% 
  filter(country == "FI", source == "national")
ggplot2::ggplot(finland) +
  geom_col(aes(year, produced_tonnes, fill = area), position = position_dodge()) +
  coord_flip() +
   theme(legend.position = "none") +
  labs(title = "Finnish production (tons) 1978-2018")
```


```{r initial data exploration by national data first}
## Sweden 
sweden <- combined_rawdata %>% 
  filter(country == "SE", source == "national")
ggplot2::ggplot(sweden) +
  geom_col(aes(year, produced_tonnes, fill = area), position = position_dodge()) +
  coord_flip() +
  labs(title = "Swedish production (tons) 2009-2018")
```


```{r initial data exploration by national data first}
## FAO data
fao <- combined_rawdata %>% 
  filter(source == "fao")
str(fao)
ggplot2::ggplot(fao) +
  geom_col(aes(year, produced_tonnes, fill = area), position = position_dodge(), width = 2) +
  labs(title = "FAO Brackish water production (tons) 1972-2017")
```


```{r initial data exploration by national data first}
## HELCOM data
helcom <- combined_rawdata %>% 
  filter(source == "helcom",
         !is.na(produced_tonnes),
         !(produced_tonnes == 0))
ggplot2::ggplot(helcom)+
  geom_col(aes(year,produced_tonnes, fill = area), position = position_dodge(), width = 1) +
  facet_grid(~country) +
  ggtitle("HELCOM Brackish water production (tons) 2011-2015")

helcom1 <- finfish_raw2 %>% 
  filter(source == "helcom",
         !(p_kg == 0),
         !(n_kg == 0))
ggplot2::ggplot(helcom1)+
  geom_col(aes(farm_ID,p_kg, fill = country), position = position_dodge(), width = 1) +
  facet_grid(~year) +
  ggtitle("HELCOM P discharge (kg) 2011-2015")

ggplot2::ggplot(helcom1)+
 geom_col(aes(farm_ID,maxP_kg, fill = country), position = position_dodge(), width = 1) +
  facet_grid(~country) +
  ggtitle("HELCOM max P discharge (kg) 2011-2015")

ggplot2::ggplot(helcom1)+
  geom_col(aes(year,n_kg, fill = area), position = position_dodge(), width = 1) +
  facet_grid(~country) +
  ggtitle("HELCOM max N discharge (kg) 2011-2015")

ggplot2::ggplot(helcom1)+
  geom_col(aes(year,maxN_kg, fill = area), position = position_dodge(), width = 1, alpha = 2) +
  facet_grid(~country) +
  ggtitle("HELCOM max N discharge (kg) 2011-2015")

```

<br/>

```{r}
## create datasets for the HELCOM nutrient plots
str(finfish_raw2)

helcom_nutrients <- finfish_raw2 %>% 
  mutate(countryarea = paste(country, area, sep = "_")) %>% 
  filter(
    !(p_kg == 0),
    !(n_kg == 0)
  ) %>% 
  dplyr::select(-farm_species) %>% 
  rename(P_KG = p_kg, N_KG = n_kg) %>% 
  tidyr::pivot_longer(cols = c("P_KG", "N_KG"), names_to = "Input", values_to = "Value")

helcom_nutrients_bounds <- finfish_raw2 %>% 
  mutate(countryarea = paste(country, area, sep = "_")) %>% 
  filter(!(p_kg == 0),
         !(n_kg == 0)
  ) %>% 
  dplyr::select(-farm_species, -p_kg, -n_kg) %>% 
  tidyr::pivot_longer(cols = c("maxP_kg", "maxN_kg"), names_to = "maxInput", values_to = "Value")

## plot format nutrient reference
nutrients_plot2 <- ggplot(data = helcom_nutrients) +
  geom_errorbar(
    data = helcom_nutrients_bounds, 
    aes(x = year, ymin = Value, ymax = Value, color = maxInput), 
    alpha = 0.2, 
    size = 0.5
  ) +
  geom_point(
    aes(x = year, y = Value, color = Input), 
    alpha = 0.5, size = 2.5, shape = 18) +
  facet_grid(cols = vars(country), rows = vars(Input)) +
  scale_color_brewer(palette = "Paired") +
  ggtitle("HELCOM Brackish water production (tons) 2011-2015")

nutrients_plot2



ggplot(filter(helcom_nutrients, Input == "P_KG")) + 
  geom_col(aes(x = year, y = Value, fill = farm_ID), position = position_dodge()) +
  geom_errorbar(
    aes(x = year, ymin = 0, ymax = maxP_kg),
    width = 0.15,
    alpha = 0.8,
    position = position_dodge(0.9)
  ) +
  facet_grid(cols = vars(country), rows = vars(Input)) +
  scale_color_brewer(palette = "Set2") +
  theme(legend.position = "none")
  

nutrients_plot3 <- ggplot(data = helcom_nutrients) +
  geom_col(aes(x = year, y = Value, fill = farm_ID), position = position_dodge()) +
  facet_grid(cols = vars(country), rows = vars(Input)) +
  scale_color_brewer(palette = "Set2") +
  theme(legend.position = "none") +
  
  geom_errorbar(
    data = helcom_nutrients_bounds, 
    aes(x = year, ymin = 0, ymax = Value, color = farm_ID), 
    position = position_dodge()
  ) +
  facet_grid(cols = vars(country), rows = vars(maxInput)) 

nutrients_plot3

## Combined raw data
str(combined_rawdata)
combined <- combined_rawdata %>% 
  filter(year %in% 2010:2019) 

ggplot2::ggplot(combined)+
  geom_col(aes(year,produced_tonnes, fill = area), position = position_dodge()) +
  facet_grid(~country) +
  coord_flip() +
  ggtitle("Total Brackish water production (tons) 2010-2019")
```


```{r}
## create datasets for the plots
plot_nutrients <- combined_rawdata %>% 
  filter(year %in% 2010:2019) %>% 
  mutate(countryarea = paste(country, area, sep = "_")) %>% 
  dplyr::select(-farm_species) %>% 
  rename(P_KG = p_kg, N_KG = n_kg) %>% 
  tidyr::pivot_longer(cols = c("P_KG", "N_KG"), names_to = "Input", values_to = "Value")

plot_nutrients_bounds <- combined_rawdata %>% 
  filter(year %in% 2010:2019) %>% 
  mutate(countryarea = paste(country, area, sep = "_")) %>% 
  dplyr::select(-farm_species, -p_kg, -n_kg) %>% 
  tidyr::pivot_longer(cols = c("maxP_kg", "maxN_kg"), names_to = "maxInput", values_to = "Value")

## plot format nutrient reference
nutrients_plot <- ggplot(data = plot_nutrients) +
  geom_errorbar(
    data = plot_nutrients_bounds, 
    aes(x = year, ymin = Value, ymax = Value, color = maxInput), 
    alpha = 0.2, 
    size = 0.5
  ) +
  geom_point(aes(x = year, y = Value, color = Input), alpha = 0.5, size = 4, shape = 18) +
  facet_grid(cols = vars(country), rows = vars(Input)) +
  scale_color_brewer(palette = "Paired") +
  theme(legend.position = "none")

nutrients_plot
```

<br/>

#### 2.3.1 Compare versus Previous Years Data

#### 2.3.2 Timeseries Plots

#### 2.3.3 Map

