## 2. Data

**Rainbow trout production (Denmark, Sweden and Finland) and Finfish (Denmark, Germany, Sweden and Finland)**

```{r Preamble, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "setup.R"))
library(readr)
library(sf)
library(R.utils)
```

### 2.1 Datasets with Sources
<br/>

**Rainbow trouts mariculture**  

- **Sweden**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_se -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("PDF:", "Vattenbruk 2018"), 
  c("Location data:", "Page 7, table A")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Jorbruksverket database](https://www.scb.se/hitta-statistik/statistik-efter-amne/jord-och-skogsbruk-fiske/vattenbruk/vattenbruk/) <br/> [Jorbruksverket](https://www.scb.se/contentassets/cef2fb103630496bb532e76c98f747e6/jo1201_2018a01_sm_jo60sm1901.pdf) Downloaded 2019-10-09 by Andrea De Cervo")
```

<br/>

- **Denmark**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_dk -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Faste tabeller med akvakulturststistik:", "Produktion af hovedarter fordelt på region"), 
  c("Rows:", "Regnbueørred, Saltvand")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Ministry of Environment and Food of Denmark database](https://fiskeristyrelsen.dk/fiskeristatistik/akvakulturstatistik/) <br/> Downloaded 2019-10-11 by Andrea De Cervo")
```

<br/>

- **Finland**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_fi -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Luke statistics database:", "Food fish production by species"), 
  c("Production:", "Quantity (1 000 kg)"),
  c("Area:", "Sea"),
  c("Fish:", "Rainbow trout"),
  c("Year:", "All")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Natural Resources Institute database](http://statdb.luke.fi/PXWeb/pxweb/en/LUKE/LUKE__06%20Kala%20ja%20riista__02%20Rakenne%20ja%20tuotanto__10%20Vesiviljely/?tablelist=true&rxid=ef8a2896-d6cb-4660-a8aa-fee93bd4212f) <br/> Downloaded 2019-10-10 by Andrea De Cervo")
```

<br/>

- **Germany**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/rbt_de -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Location:", "Kiel Bay")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Email from plant manager](tassilo@jaeger-kleinicke.de) <br/> Received 2019-10-30")
```

<br/>

**Finfish Mariculture**  
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/Finfish_mariculture -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("HELCOM Map and Data service:", "Pressures and human activities"), 
  c("Human activities:", "Finfish mariculture")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HELCOM database](http://maps.helcom.fi/website/mapservice/?datasetID=3cfa469a-6a78-4913-b82f-57fd0e7f4dc0) <br/> (http://metadata.helcom.fi/geonetwork/srv/eng/catalog.search#/metadata/3cfa469a-6a78-4913-b82f-57fd0e7f4dc0) <br/> Downloaded 2019-10-09 by Andrea De Cervo")
```

<br/>

**All Baltic countries**
<!-- dataset save location BHI_share/2.0/Goals/FP/Mariculture/FAO_fishstat -->

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("FAO FishStatJ:", "Global aquaculture production"), 
  c("Quantity:", "1950-2017")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [FAO FishStatJ](http://www.fao.org/fishery/statistics/software/fishstatj/en#downlApp) <br/> Downloaded 2019-10-16 by Andrea De Cervo")
```

<br/>

#### Reference Point: maximum nutrient discharge (N and P)

In 2016 HELCOM Contracting Parties adopted Recommendation 37/3 on ["Sustainable aquaculture in the Baltic Sea Region"](http://www.helcom.fi/Recommendations/Rec%2037-3.pdf). 

However, the only parameter that can be used as reference point for Mariculture subgoal in the Baltic Sea (that can be also found on Finfish Mariculture data provided by HELCOM) is the [maximum nutrient discharge for P and N](http://www.helcom.fi/Recommendations/Rec%2025-4.pdf), where existing and new marine fish farms should not exceed the annual average of: 
- 7g of P (tot-P) 
- 50g of N (tot-N) 
per 1kg fish (living weight) produced.
(The nutrient limit values (P and N) are calculated on the basis that living fish contains 0,4% of phosphorus and 2,75% of nitrogen.)

This recommendation was adopted in 2004, but since there are not updated nutrient limit values, this will be the parameter used as reference point.

Only data provided by HELCOM on finfish mariculture include nutrient discharge. 
However, nutrient inputs from fish farms in Denmark were calculated on the basis of production data, and some numbers that were missing on nutrient input in Sweden were calculated by SCB, Statistics Sweden based on average input/ amount produced fish.
Therefore, estimates for all other datasets will be made.


### 2.2 Centralization & Normalization

```{r load raw data, message = FALSE, warning = FALSE, echo = TRUE}
## root location of the raw data
dir_rawdata <- file.path(dir_B, "Goals", "FP", "MAR") # list.files(dir_rawdata)

## rainbow trout data
rbt_de_raw <- read_delim(file.path(dir_rawdata, "rbt_de", "rbt_de.csv"), delim = ";")
rbt_dk_raw <- read_delim(file.path(dir_rawdata, "rbt_dk", "rbt_dk.csv"), delim = ";")
rbt_dk2005raw <- read_delim(file.path(dir_rawdata, "rbt_dk", "rbt_dk_2005.csv"), delim = ";")
rbt_fi_raw <- read_delim(file.path(dir_rawdata, "rbt_fi", "rbt_fi.csv"), delim = ";")
rbt_se_raw <- read_delim(file.path(dir_rawdata, "rbt_se", "rbt_se.csv"), delim = ";")

## FAO rainbow trout data
fao_rbt_raw <- read_delim(file.path(dir_rawdata, "FAO_fishstat", "FAO_fishstat.csv"), delim = ";")

# countrycodes for FAO dataset
countrycode <- data.frame(
  area = c("Germany", "Denmark", "Estonia", "Finland","Sweden"),
  country = c("DE", "DK", "ES", "FI", "SE")
)

## HELCOM Finfish mariculture data
# this is spatial data so we need to remove the geometry column
# also need to convert many columns from factor to numeric
finfish_mariculture_raw <- sf::st_read(file.path(dir_rawdata, "Finfish_mariculture", "Finfish_mariculture.shp"))
st_geometry(finfish_mariculture_raw) <- NULL
finfish_mariculture_raw[, 1:28] <- sapply(finfish_mariculture_raw[, 1:28], as.character)
finfish_mariculture_raw[, 8:28] <- sapply(finfish_mariculture_raw[, 8:28], as.numeric)
```


Create lookup tab for matching areas with bhi regions.   
To avoid double-counting, need to distinguish national/subnational data.

```{r to match areas with bhi regions}
bhiregions <- bind_rows(
  ## germany
  c(country = "DE", lvl = "subnatl", area = "Kiel Bay", rgn = 8),
  ## denmark
  c(country = "DK", lvl = "subnatl", area = "Arhus_cty", rgn = 3),
  c(country = "DK", lvl = "subnatl", area = "Vejle_cty", rgn = 3),
  c(country = "DK", lvl = "subnatl", area = "Fyns_cty", rgn = 3),
  c(country = "DK", lvl = "subnatl", area = "Sønderjylland_cty", rgn = 3),
  c(country = "DK", lvl = "subnatl", area = "Nordjyllands_cty", rgn = 2),
  c(country = "DK", lvl = "subnatl", area = "Frederiksborg_cty", rgn = list(2, 6)),
  c(country = "DK", lvl = "subnatl", area = "Roskilde_cty", rgn = 12),
  c(country = "DK", lvl = "subnatl", area = "Storstrøms_cty", rgn = list(3, 7, 9, 12)),
  c(country = "DK", lvl = "subnatl", area = "Vestsjællands_cty", rgn = list(2, 3)),
  c(country = "DK", lvl = "subnatl", area = "Hovedstaden", rgn = list(2, 6, 12, 15)),
  c(country = "DK", lvl = "subnatl", area = "Sjælland", rgn = list(3, 7, 9, 12)),
  c(country = "DK", lvl = "subnatl", area = "Syddanmark", rgn = 3),
  c(country = "DK", lvl = "subnatl", area = "Midtjylland", rgn = list(2, 3)),
  c(country = "DK", lvl = "subnatl", area = "Belts Danish coastal waters", rgn = 3),
  c(country = "DK", lvl = "subnatl", area = "Bornholm Basin", rgn = 15),
  c(country = "DK", lvl = "subnatl", area = "Arkona Basin", rgn = 12),
  ## sweden
  c(country = "SE", lvl = "subnatl", area = "Kalmar lan", rgn = 26),
  c(country = "SE", lvl = "subnatl", area = "Gavleborgs lan", rgn = 37),
  c(country = "SE", lvl = "subnatl", area = "Vasternorrlands lan", rgn = 37),
  c(country = "SE", lvl = "subnatl", area = "Stockholm lan", rgn = list(35, 29)),
  c(country = "SE", lvl = "subnatl", area = "Vasterbottens lan", rgn = list(41, 39)),
  c(country = "SE", lvl = "subnatl", area = "Norrbottens lan", rgn = 41),
  c(country = "SE", lvl = "subnatl", area = "Aland Sea", rgn = 35),
  c(country = "SE", lvl = "subnatl", area = "Western Gotland Basin", rgn = 26),
  c(country = "SE", lvl = "subnatl", area = "Bornholm Basin", rgn = 14),
  c(country = "SE", lvl = "subnatl", area = "The Sound", rgn = 5),
  c(country = "SE", lvl = "subnatl", area = "Bothnian Sea", rgn = 37),
  c(country = "SE", lvl = "subnatl", area = "Bothnian Bay", rgn = 41),
  c(country = "SE", lvl = "subnatl", area = "Ne_coast", rgn = list(37, 39, 41)),
  c(country = "SE", lvl = "subnatl", area = "Other_coasts", rgn = list(29, 35, 26, 14, 11, 5, 1)), 
  ## finland
  c(country = "FI", lvl = "subnatl", area = "Archipelago Sea", rgn = 36),
  c(country = "FI", lvl = "subnatl", area = "Bothnian Sea", rgn = 38),
  c(country = "FI", lvl = "subnatl", area = "Gulf of Finland", rgn = 32),
  c(country = "FI", lvl = "subnatl", area = "Bothnian Bay", rgn = 42),
  c(country = "FI", lvl = "subnatl", area = "The Quark", rgn = 40),
  ## countries
  c(country = "DE", lvl = "natl", area = "Germany", rgn = list(16, 13, 10, 8, 4)),
  c(country = "DK", lvl = "natl", area = "Denmark", rgn = list(15, 12, 9, 7, 6, 3, 2)),
  c(country = "SE", lvl = "natl", area = "Sweden", rgn = list(41, 39, 37, 35, 29, 26, 20, 14, 11, 5, 1)),
  c(country = "FI", lvl = "natl", area = "Finland", rgn = list(42, 40, 38, 36, 32, 30)),
  c(country = "ES", lvl = "natl", area = "Estonia", rgn = list(34, 31, 28, 25)),
  c(country = "LA", lvl = "natl", area = "Latvia", rgn = list(27, 24)),
  c(country = "LI", lvl = "natl", area = "Lithuania", rgn = 23),
  c(country = "PO", lvl = "natl", area = "Poland", rgn = list(21, 18, 17)),
  c(country = "RU", lvl = "natl", area = "Russia", rgn = list(33, 22, 19))
)

bhiregions[, 4:15] <- sapply(bhiregions[, 4:15], as.numeric)
bhiregions <- bhiregions %>% 
  tidyr::pivot_longer(cols = 4:15, names_to = "num", values_to = "region_id") %>% 
  filter(!is.na(region_id)) %>% 
  dplyr::select(country, area, region_id, level = lvl)
```


```{r map showing datasets overlaps}
source(here::here("R", "spatial.R"))
regions_shape() # loads spatial features objects

bhi_rgns_simple <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% 
  sf::st_as_sf() %>% 
  dplyr::right_join(
    dplyr::select(bhiregions, area, BHI_ID = region_id), 
    by = c("BHI_ID")
  ) %>% 
  mutate(areacountry = paste(area, rgn_nam, sep = ", "))

cols <- c(RColorBrewer::brewer.pal(8, "Set2"), RColorBrewer::brewer.pal(9, "Set1"))

ggplot2::ggplot() + 
  geom_sf(
    data = rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
      st_crop(xmin = 0, xmax = 40, ymin = 53, ymax = 67),
    fill = "ivory", 
    size = 0.1
  ) +
  geom_sf(
    data = bhi_rgns_simple, 
    aes(fill = areacountry),
    colour = NA,
    show.legend = FALSE
  ) +
  facet_wrap(~area, ncol = 3) +
  scale_fill_manual(
    values = colorRampPalette(cols)(45)
  ) +
  scale_x_continuous(limit = c(5, 37)) +
  scale_y_continuous(limit = c(53.5, 66))
```

#### 2.2.1 Merge datasets

**National and FAO datasets**

```{r merge rainbow trout rawdata, echo = TRUE}
rbt_raw <- bind_rows(
  
  ## rbt_de rainbow trout germany
  rbt_de_raw %>% 
    dplyr::mutate(farm_species = str_to_sentence(production)) %>% 
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species, -production) %>%
    dplyr::mutate(
      produced_tonnes = as.numeric(produced_tonnes),
      country = "DE",
      p_kg = as.numeric(NA),
      n_kg = as.numeric(NA),
      area = capitalize(area),
      area = str_replace(area, "Kiel_bay", "Kiel Bay")
    ) %>% 
    select(year, country, area, farm_species, produced_tonnes, p_kg, n_kg) %>% 
    arrange(country),
  
  ## rbt_dk2005 rainbow trout 2005 denmarks
  rbt_dk2005raw %>% 
    dplyr::mutate(farm_species = str_to_sentence(production)) %>% 
    dplyr::select(-tot_wt_ton, -production) %>% 
    dplyr::rename(
      arhus_cty = cty1, 
      vejle_cty = cty2,
      fyns_cty = cty3,
      sønderjylland_cty = cty4,
      ribe_cty = cty5,
      ringkøbing_cty = cty6,
      viborg_cty = cty7,
      nordjyllands_cty = cty8,
      frederiksborg_cty = cty9,
      roskilde_cty = cty10,
      storstrøms_cty  = cty11,
      vestsjællands_cty = cty12
    ) %>% 
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species) %>% 
    # filter out the counties on the Atlantic coasts
    filter(
      !(area == "viborg_cty"),
      !(area == "ringkøbing_cty"),
      !(area == "ribe_cty")
    ) %>% 
    dplyr::mutate(
      country = "DK",
      p_kg = as.numeric(NA),
      n_kg = as.numeric(NA),
      area = capitalize(area)
    ) %>% 
    arrange(country),
  
  ## rbt_dk rainbow trout denmark
  ## https://www.was.org/easOnline/AbstractDetail.aspx?i=4377
  rbt_dk_raw %>% 
    dplyr::mutate(farm_species = str_to_sentence(production)) %>% 
    dplyr::select(-production) %>% 
    dplyr::rename(
      denmark = tot_wt_ton,
      hovedstaden = "reg1", 
      sjælland = "reg2",
      syddanmark = "reg3",
      midtjylland = "reg4"
    ) %>% 
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species) %>% 
    dplyr::mutate(
      country = "DK",
      p_kg = as.numeric(NA),
      n_kg = as.numeric(NA),
      area = capitalize(area)
    ) %>% 
    arrange(country),
  
  ## rbt_fi rainbow trout finland
  rbt_fi_raw %>% 
    dplyr::mutate(
      farm_species = str_to_sentence(production),
      produced_tonnes = tot_wt_tonnes,
      country = "FI", area = "finland",
      p_kg = as.numeric(NA),
      n_kg = as.numeric(NA),
      area = capitalize(area)
    ) %>% 
    dplyr::select(-production, -tot_wt_tonnes) %>% 
    arrange(country),
  
  ## rbt_se rainbow trout sweden
  rbt_se_raw %>% 
    dplyr::mutate(
      farm_species = str_to_sentence(production),
      sweden = tot_wt_mtonnes
    ) %>% 
    select(-ne_farm_no, -other_farm_no, -production, -tot_wt_mtonnes) %>%
    tidyr::gather(key = "area", value = "produced_tonnes", -year, -farm_species) %>% 
    mutate(
      country = "SE",
      p_kg = as.numeric(NA),
      n_kg = as.numeric(NA),
      area = capitalize(area)
    ) %>% 
    arrange(country)
  
) %>% mutate(source = "national")

rbt_raw <- bind_rows(
  rbt_raw, 
    ## fao_rbt fao data on rainbow trout
    fao_rbt_raw %>% 
      dplyr::mutate(
        area = country,
        farm_species = str_to_sentence(species)
      ) %>% 
      filter(
        ## aqua area atlantic NE, so maybe keep marine?
        # !(environment == "Marine" & area == "Denmark"), 
        str_detect(farm_species, "Rainbow trout")
      ) %>% 
      select(-aqua_area, -Unit, -environment, -("1950":"1971"), -country, -species) %>%
      tidyr::gather(key = "year", value = "produced_tonnes", -area, -farm_species) %>% 
    
      ## remove characters from production numeric values
      ## "F" stands FAO estimates from available sources of information
      mutate(
        year = as.numeric(year),
        produced_tonnes = str_replace(produced_tonnes, "F", " "), 
        produced_tonnes = as.numeric(produced_tonnes),
        p_kg = as.numeric(NA),
        n_kg = as.numeric(NA),
        area = capitalize(area)
      ) %>% 
      group_by(area, year) %>% 
      mutate(
        produced_tonnes = sum(produced_tonnes),
        p_kg = sum(p_kg),
        n_kg = sum(n_kg)
      ) %>% 
      distinct() %>% 
      filter(!is.na(produced_tonnes)) %>% 
      
      ## join with countrycode data
      left_join(countrycode, by = "area") %>% 
      mutate(source = "fao") %>% 
      select(year, country, area, farm_species, produced_tonnes, p_kg, n_kg, source) %>% 
      
      filter(area != "Finland") %>% # remove finland fao data-- exact duplicates of national data
      filter(!(year %in% 2006:2017 & area == "Denmark")) %>% # use Denmark national data instead here...
      filter(!(year %in% 2009:2018 & area == "Sweden")) # sweden natl data matches fao, but includes 2009-2018
  )

## reassign types and join bhi region_ids by area
## use lookup table defined in code chunk above
rbt_raw[, c(5:7)] <- sapply(rbt_raw[, c(5:7)], as.numeric) 
```


```{r merge finfish rawdata, echo = TRUE}
## wrangling finfish data so can merge with other datasets
## source of this dataset is helcom
## spatial file located here:
## http://metadata.helcom.fi/geonetwork/srv/eng/catalog.search#/metadata/3cfa469a-6a78-4913-b82f-57fd0e7f4dc0
finfish_raw <- as_tibble(finfish_mariculture_raw) %>% 
  mutate(SUBBASIN = ifelse(is.na(SUBBASIN), COUNTY, SUBBASIN)) %>% 
  dplyr::rename(
    area = SUBBASIN,
    farm_species = PRODUCTION,
    country = COUNTRY
  ) %>% 
  ## remove the facilities on land
  ## these are entries with any of NA, on land, or On land as 'AREA'
  ## are we sure that 'NA' value for AREA means that it is on land? there are so many NAs, leaves only "SE" "DK" "FI" data...
  filter(is.na(AREA) |!str_detect(str_to_lower(AREA), "on land"),
         !(area == "Bay of Mecklenburg")) %>% 
  tibble::rowid_to_column("farm_ID") %>% 
  mutate(farm_ID = as.factor(farm_ID)) %>% 
  ## replace NA value with general mariculture name 'finfish'
  mutate(
    area = str_replace(area,"Sland Sea","Aland Sea"),
    AREA = str_replace(AREA, ",", "."),
    farm_species = ifelse(
      is.na(farm_species), 
      "Finfish", ifelse(
        str_detect(farm_species, "Rainbow trout|rainbow trout"),
        "Rainbow trout", farm_species
      )
    )
  ) %>% select(-AREA, -NAME, -COMMENTS)

## rename names within AREA without <?> symbols
arealookup <- data.frame(
  fix_area = c(
    "Kalmar lan",
    "Gavleborgs lan",
    "Vasternorrlands lan",
    "Vasternorrlands lan",
    "Stockholm lan",
    "Vasterbottens lan",
    "Norrbottens lan"
  ),
  area = unique(finfish_raw$area)[1:7]
)
arealookup[,] <- sapply(arealookup[,], as.character)

## gather production, phosphorus and nitrogen vars by year
spreadcols <- names(finfish_raw)[1:5]
gathercols <- names(finfish_raw)[6:26]

## reshape to have year and 3 variable cols: 
## production (PR), nitrogen (N), and phosphorus (P)
finfish_gather_yr <- as_tibble(finfish_raw) %>% 
  tidyr::pivot_longer(cols = gathercols, names_to = "varyear", values_to = "value") %>% 
  mutate(
    year = str_extract(varyear, pattern = "[0-9]{4}"),
    var = str_extract(varyear, pattern = "[A-Z]+")
  ) %>% 
  filter(!is.na(year)) %>%  # filter out na years as these represent aggregated values, but keep NA values
  tidyr::pivot_wider(id_cols = c(spreadcols, "year", "farm_ID"), names_from = var, values_from = value) %>% 
  ## where production is zero and nutrients aren't close to zero, assume production should be NA...
  rowwise() %>% 
  dplyr::mutate(PR = ifelse(PR < 1 & (!is.na(N)|!is.na(P)), ifelse(any(c(N,P) < 10), PR, NA), PR)) %>% 
  ungroup() %>%
  ## keep only necessary columns and join with renamed areas
  select(year, country, area, farm_species, produced_tonnes = PR, p_kg = P, n_kg = N, farm_ID) %>% 
  left_join(arealookup, by = "area") %>%
  mutate(area = ifelse(!is.na(fix_area), fix_area, area), source = "helcom") %>%
  select(-fix_area, -farm_ID)
```


#### 2.2.2 Standardize Units: Production regions and BHI Region assignments

**Note: where multiple BHI regions exist within the areas reported for mariculture data (e.g. "Ne_coast" for Sweden contains BHI regions 37, 39, and 41), the data values are split among the regions based on region sizes, i.e. with the assumption that each unit area is equally likely to contain the given mariculture farm...** For future assessments, if adequate data are available, mariculture sites may be matched to BHI regions more precisely using spatial files (shapefiles).  


```{r combine into a single harmonized dataset save, echo = TRUE}
## join spatial area information to bhiregions lookup table
st_geometry(bhi_rgns_simple) <- NULL
bhiregions <- bhi_rgns_simple %>% 
  dplyr::select(region_id = BHI_ID, Area_km2) %>% 
  distinct() %>%
  right_join(bhiregions, by = "region_id") %>% 
  mutate(level = as.numeric(ifelse(level == "natl", "1", "2")))

## combine the datasets and add the ID column, then deal with overlapping data
## overlap here due to nesting of different spatial resolutions, not duplicate entries

combined_rawdata <- rbind(rbt_raw, finfish_gather_yr) %>%
  left_join(bhiregions, by = c("country", "area")) %>% 
  ## in the case where theres no subnational data, use national
  mutate(level = ifelse(level == 2 & is.na(produced_tonnes) & is.na(p_kg)& is.na(n_kg), 0, level)) %>% 
  group_by(year, country, region_id, farm_species) %>% 
  ## top_n function will select uppermost available level within grouping
  top_n(1, level) %>% 
  ungroup()

level_area <- combined_rawdata %>%
  group_by(year, country, level, area, farm_species) %>%
  summarize(level_area_km2 = sum(Area_km2)) %>%
  ungroup()

combined_rawdata <- combined_rawdata %>%
  left_join(level_area, by = c("year", "country", "level", "area", "farm_species")) %>%
  mutate(area_frac = Area_km2/level_area_km2) %>% 
  group_by(year, country, level, area, farm_species, region_id) %>% 
  mutate(area_frac = sum(area_frac)) %>%  # if there are multiple points per group, should keep unique
  ungroup() %>% 
  mutate(
    split_production = ifelse(level == 2, produced_tonnes*area_frac, NA),
    split_N = ifelse(level == 2, n_kg*area_frac, NA),
    split_P = ifelse(level == 2, p_kg*area_frac, NA)
  ) %>%
  group_by(year, country, farm_species) %>% 
  mutate(
    subnatl_prod = sum(ifelse(source == "national", split_production, 0), na.rm = TRUE),
    subnatl_N = sum(ifelse(source == "national", split_N, 0), na.rm = TRUE),
    subnatl_P = sum(ifelse(source == "national", split_P, 0), na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  mutate(
    split_production = ifelse(level == 1, (produced_tonnes-subnatl_prod)*area_frac, split_production),
    split_N = ifelse(level == 1, (n_kg-subnatl_N)*area_frac, split_N),
    split_P = ifelse(level == 1, (p_kg-subnatl_P)*area_frac, split_P)
  ) %>% 
  select(
    year, country, source, area, level, region_id, farm_species,
    produced_tonnes, n_kg, p_kg, 
    rgn_area_km2 = Area_km2, area_fraction = area_frac,
    split_production, split_N, split_P
  )

## save the full merged data with assigned BHI regions
readr::write_csv(combined_rawdata, here::here("data", "MAR", version_year, "intermediate", "mar_full_nmerged_dataset.csv"))
```

#### 2.2.3 Imputation/Gapfilling of merged datasets

```{r investigate nutrient estimates with linear models}
## gapfill using raw merged data, 
## not data split and assigned to BHI regions!
plotdf <- rbind(rbt_raw, finfish_gather_yr) %>% 
  filter(!is.na(p_kg) & !is.na(n_kg)) %>% 
  filter(produced_tonnes > 20) %>% 
  ## to use predict function later based on lm obj, need these names in models
  dplyr::rename(split_production = produced_tonnes, split_N = n_kg, split_P = p_kg)

## check relationships between production and nutrients
## quite linear, so probably ok to gapfill using this relationship...
## note: remember 'split' values here are actually original data renamed!
p_mdl <- lm(split_P ~ 0 + split_production, data = plotdf) # summary(p_mdl)
n_mdl <- lm(split_N ~ 0 + split_production, data = plotdf) # summary(n_mdl)

plotly::ggplotly(
  ggplot(plotdf) +
    geom_abline(slope = coef(p_mdl)[["split_production"]], intercept = 0, color = "grey") +
    geom_point(aes(x = split_production, y = split_P), color = "blue", alpha = 0.75)
)

## production estimates with linear models
## strange things happen when including phosphorus (negative coefficient...)
prod_mdl <- lm(split_production ~ 0 + split_N, data = plotdf) # summary(prod_mdl)

plotly::ggplotly(
  ggplot(plotdf) +
    geom_abline(slope = coef(prod_mdl)[["split_N"]], intercept = 0, color = "grey") +
    geom_point(aes(x = split_N, y = split_production), color = "blue", alpha = 0.75)
)
```


#### 2.2.4 Save to BHI Database

```{r gapfilling and save datasets}
## create dataset with nutrient ESTIMATES (kg) from COMBINED data
mar_gapfilling <- combined_rawdata %>% 

  ## identify where to gapfill
  mutate(
    gapfill_nutrients = (is.na(split_P)|is.na(split_N)) & !is.na(split_production),
    gapfill_prod = is.na(split_production) & !is.na(split_N) & !is.na(split_P)
  ) %>% 
  
  ## estimates based on production
  cbind(
    estim_p_kg = predict(p_mdl, combined_rawdata),
    estim_n_kg = predict(n_mdl, combined_rawdata),
    estim_prod = predict(prod_mdl, combined_rawdata)
  ) %>% 
  
  ## gapfilling nutrients based on production and vice versa...
  ## production from regression w N and P, so cannot gapfill if either are NA
  mutate(
    split_N_gf = ifelse(is.na(split_N), estim_n_kg, split_N),
    split_P_gf = ifelse(is.na(split_P), estim_p_kg, split_P),
    split_prod_gf = ifelse(gapfill_prod, estim_prod, split_production)
  ) %>%

  ## nutrient ratios
  mutate(
    gapfilled = gapfill_nutrients|gapfill_prod,
    ## calculate ratios of nutrients used to fish produced
    ## grams per kg fish, unit conversion factors cancel
    N_prod_ratio = ifelse(split_prod_gf == 0, 0, split_N_gf/split_prod_gf),
    P_prod_ratio = ifelse(split_prod_gf == 0, 0, split_P_gf/split_prod_gf)
  ) %>% 
  mutate(
    ## NAs where production is gapfilled but nutrient inputs are zero
    N_prod_ratio = ifelse(gapfill_prod & n_kg == 0, NA, N_prod_ratio),
    P_prod_ratio = ifelse(gapfill_prod & p_kg == 0, NA, P_prod_ratio)
  ) %>% 
  select(
    year, country, region_id, farm_species, 
    gapfilled, gapfill_nutrients, gapfill_prod, gapfill_nutrients,
    estim_n_kg, estim_p_kg, estim_prod, 
    split_N_gf, split_P_gf, split_prod_gf,
    N_prod_ratio, P_prod_ratio
  )

mar_datalayers <- mar_gapfilling %>% 
  group_by(year, region_id) %>% 
  ## get summarized values by BHI region
  summarize(
    n_kg = sum(split_N_gf, na.rm = TRUE),
    p_kg = sum(split_P_gf, na.rm = TRUE),
    produced_tonnes = sum(split_prod_gf, na.rm = TRUE),
    n_ratio = mean(N_prod_ratio, na.rm = TRUE),
    p_ratio = mean(P_prod_ratio, na.rm = TRUE),
    pct_gf = sum(gapfilled)/n(),
    pct_prod_gf = sum(gapfill_prod)/n(),
    pct_nutrient_gf = sum(gapfill_nutrients)/n()
  ) %>% 
  ungroup() %>% 
  mutate(year = as.character(year)) %>% 
  mutate(year = as.numeric(year))

## save gapfilled dataset and dataset recording where gapfilling occurred
write_csv(mar_gapfilling, here::here("data", "MAR", version_year, "intermediate", "mar_gapfilling.csv"))

mar_harvest <- mar_datalayers %>% 
  select(year, region_id, produced_tonnes)
mar_nutrients <- mar_datalayers %>% 
  select(year, region_id, n_kg, p_kg, n_ratio, p_ratio)

write_csv(mar_harvest, here::here("layers", version_year, "mar_harvest.csv"))
write_csv(mar_nutrients, here::here("layers", version_year, "mar_nutrients.csv"))
```

<br/>

### 2.3 Initial Data Exploration

```{r explore raw data by source and country}
datasources <- ggplot(
  combined_rawdata %>% 
    mutate(region_id = as.factor(region_id)) %>% 
    mutate(year = as.numeric(year)) %>% 
    mutate(source = ifelse(source == "fao", "FAO", str_to_title(source))),
  aes(x = year, y = split_production, color = source)
)
datasources + 
  geom_point(alpha =  0.5) + 
  facet_wrap(~ country, ncol = 1) + 
  labs(x = "Year", y = "Production, split over BHI Regions\n", color = "Data Source")
```

```{r explore gapfilled data by country}
plotdf <- mar_datalayers %>% 
  left_join(
    bhiregions %>% 
      select(region_id, country) %>% 
      distinct(),
    by = "region_id"
  ) %>% 
  mutate(region_id = as.factor(region_id)) %>% 
  rename(Nitrogen = n_kg, Phosphorus = p_kg, Production = produced_tonnes) %>% 
  mutate(Nmax = 50*Production, Pmax = 7*Production) %>% 
  group_by(year, country) %>% 
  mutate(Nmax = sum(Nmax, na.rm = TRUE), Pmax = sum(Pmax, na.rm = TRUE)) %>% 
  ungroup() %>% 
  tidyr::pivot_longer(cols = c(Nitrogen, Phosphorus, Nmax, Pmax, Production))


ggplot(
  filter(plotdf, name == "Production"),
  aes(x = year, y = value, fill = region_id)
  ) +
  geom_area(position = "stack", alpha =  0.5, show.legend = FALSE) + 
  facet_wrap(~ country, ncol = 1, scales = "free_y") + 
  labs(x = "Year", y = "Mariculture production (tonnes, gapfilled)\n")

  
ggplot() +
  geom_area(
    mapping = aes(x = year, y = value, fill = region_id),
    data = plotdf %>% 
      filter(name %in% c("Nitrogen", "Phosphorus")),
    position = "stack", 
    alpha =  0.5, 
    show.legend = FALSE
  ) + 
  geom_line(
    mapping = aes(x = year, y = value), # color = region_id
    data = plotdf %>% 
      filter(name %in% c("Nmax", "Pmax")) %>% 
      mutate(name = ifelse(name == "Nmax", "Nitrogen", "Phosphorus")),
    inherit.aes = FALSE,
    size = 0.4,
    show.legend = FALSE
  ) + 
  facet_grid(rows = vars(country), cols = vars(name), scales = "free_y") + 
  labs(x = "Year", y = "Nutrient Use (kg, gapfilled)\n")
```

```{r gapfilled percentages by country and region id}
percentagegf <- ggplot(
  mar_datalayers %>% 
    left_join(
      bhiregions %>% 
        select(region_id, country) %>% 
        distinct(),
      by = "region_id"
    ) %>% 
    filter(year > 2008) %>% 
    mutate(region_id = as.factor(region_id)) %>% 
    mutate(year = as.character(year)),
  aes(fill = region_id, x = year, y = pct_nutrient_gf) # also visualize: pct_gf, pct_prod_gf
)
percentagegf +
  geom_col(position = position_dodge(), alpha = 0.5, show.legend = FALSE) + 
  facet_wrap(~ country, ncol = 1) + 
  labs(x = "Year", y = "Percentage gapfilled\n", fill = "BHI Region ID")
```

<br/>


```{r}
## create datasets for the plots
plot_nutrients <- combined_rawdata %>% 
  filter(year %in% 2010:2019) %>% 
  mutate(countryarea = paste(country, area, sep = "_")) %>% 
  dplyr::select(-farm_species) %>% 
  rename(P_KG = p_kg, N_KG = n_kg) %>% 
  tidyr::pivot_longer(cols = c("P_KG", "N_KG"), names_to = "Input", values_to = "Value")

plot_nutrients_bounds <- combined_rawdata %>% 
  filter(year %in% 2010:2019) %>% 
  mutate(countryarea = paste(country, area, sep = "_")) %>% 
  dplyr::select(-farm_species, -p_kg, -n_kg) %>% 
  tidyr::pivot_longer(cols = c("maxP_kg", "maxN_kg"), names_to = "maxInput", values_to = "Value")

## plot format nutrient reference
nutrients_plot <- ggplot(data = plot_nutrients) +
  geom_errorbar(
    data = plot_nutrients_bounds, 
    aes(x = year, ymin = Value, ymax = Value, color = maxInput), 
    alpha = 0.2, 
    size = 0.5
  ) +
  geom_point(aes(x = year, y = Value, color = Input), alpha = 0.5, size = 4, shape = 18) +
  facet_grid(cols = vars(country), rows = vars(Input)) +
  scale_color_brewer(palette = "Paired") +
  theme(legend.position = "none")

nutrients_plot
```

<br/>

#### 2.3.1 Compare versus Previous Years Data

#### 2.3.2 Timeseries Plots

#### 2.3.3 Map


## 4. Visualizing Data Layers

### 4.1 Goal Status Map
