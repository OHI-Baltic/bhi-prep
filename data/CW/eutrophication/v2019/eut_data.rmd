
## 2. Data

```{r Preamble, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "data.R"))
```

For the Eutrophication sub-goal five indicators were included:

-   winter (December-February) dissolved inorganic nitrogen (DIN) concentrations in the surface layer (0 - 10 m depth)
-   winter (December-February) dissolved inorganic phosphorus (DIP) concentrations in the surface layer (0 - 10 m depth)
-   summer (June-September) chlorophyll a concentration in the surface layer (0 - 10 m depth)
-   summer (June-September) Secchi depth
-   oxygen debt (hypoxic area below the halocline)

### 2.1 Datasets with Sources
<br/>

#### 2.1.1. Secchi Depth data

**Secchi Depth, ICES**
<!-- dataset save location BHI_share/BHI 2.0/Goals/CW/EUT/SecchiDepth_ICES -->

Extraction from ICES database is classified into HELCOM Assessment Units – HELCOM sub basins with coastal WFD water bodies or water types

```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Dataset set:", "Oceanographic (per Parameter)"), 
  c("Parameter:", "secchi depth (Download)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [ICES data portal](http://ecosystemdata.ices.dk/inventory/Index.aspx?) <br/> Requested 24 Feb 2020 by Andrea De Cervo and received 24 Feb 2020 by Else Juul Green") 
```
*must request all records as web download limited to max 10000 records per layer*

<br/>

**Secchi Depth, SMHI**  
<!-- dataset save location BHI_share/BHI 2.0/Goals/CW/EUT/SecchiDepth_SMHI -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Datatype:", "Physical and Chemical"), 
  c("Parameter:", "secchi depth"),
  c("Months:", "All"),
  c("Years:", "1893-2020"),
  c("Decimal/fält-avgränsare (decimal/delimiter):", "punkt/semikolon (period/semicolon)"),
  c("Teckenkodning:", "UTF-8"),
  c("Rubrikrad:", "Englelska (English)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [SMHI Shark database](http://www.smhi.se/klimatdata/oceanografi/havsmiljodata/marina-miljoovervakningsdata) <br/> Downloaded 6 March 2020 by Andrea De Cervo")
```

<br/>

#### 2.1.2. Oxygen debt

**Oxygen debt**
<!-- dataset save location BHI_share/BHI 2.0/Goals/CW/EUT/OxygenDebt_ICES -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Period:", "2010-2020"), 
  c("Parameter:", "Oxygen"),
  c("Country:", "(choose each Baltic country at a time)"),
  c("Ship:", "Any")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [ICES database](https://ocean.ices.dk/HydChem/HydChem.aspx?plot=yes) <br/> Downloaded 27 February 2020 by Andrea De Cervo")
# each dataset has been extracted by country and Denmark split into two because too big
```
*The maximum number of stations per download is 20000*

<br/>

#### 2.1.3. Chlorophyll a, and Nutrients (DIN and DIP)

**Chlorophyll a, and Nutrients, Baltic Nest**
<!-- dataset save location BHI_share/BHI 2.0/Goals/CW/EUT/NestData/nestdata_winter_nutrients.csv -->
<!-- dataset save location BHI_share/BHI 2.0/Goals/CW/EUT/NestData/nestdata_summer_chlorophyl.csv -->
```{r echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Latitude/Longitude Begin/End:", "Baltic Sea"), 
  c("Dates Begin/End:", "Jan 1, 2005 to Dec 31, 2019"), 
  c("Parameters:", "PO4P, NO3N, NO2N, NO23N, NH4N, CHL")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Baltic Nest database](http://nest.su.se/dataPortal/getStations) <br/> Downloaded 28 February 2020 by Ellie Campbell. See data.R/get_nest_data function for more detailed info.")
```
<br/>

**Nutrients, Baltic Nest**
```{r using get_nest_data function to download winter nutrient data, eval = FALSE}
dir_B <- "/home/ellie/data/bhi_share/BHI 2.0"
get_nest_data(
  date_range = c(20050101,20191231), 
  months = c(11,12,1:3), 
  param_codes = c("NO3N","NO2N","NO23N","NH4N","TOTN","PO4P")
) %>% readr::write_csv(file.path(dir_B, "Goals", "CW", "EUT", "NestData", "nestdata_winter_nutrients.csv"))
```
<br/>

**Chlorophyll a, Baltic Nest**
```{r using get_nest_data function to download summer chlorophyl A data, eval = FALSE}
get_nest_data(
  date_range = c(20050101, 20191231), 
  months = 5:10, 
  param_codes = c("CHL")
) %>% readr::write_csv(file.path(dir_B, "Goals", "CW", "EUT", "NestData", "nestdata_summer_chlorophyl.csv"))
```
<br/>

#### 2.1.4. HELCOM HOLAS Basin
These basins are the relevant physical units.  
Secchi data will be first assessed at this level and then assigned to BHI region. EEZ divisions may result in some BHI regions that have no data but they are physically the same basin as a BHI region with data.

```{r basin lookup}
dir_lookup <- file.path(dir_prep, "supplement", "lookup_tabs")
basin_lookup_table <-  read.csv(file.path(dir_lookup, "bhi_basin_country_lookup.csv"), sep=";")
basin_lookup <- basin_lookup_table %>% 
  select(bhi_id = BHI_ID, basin = Subbasin, rgn_nam) %>% 
  mutate(basin = as.character(basin),
         rgn_nam = as.character(rgn_nam))
  
```
<br/>


#### 2.1.5. Threshold values

The threshold values have been agreed on by HELCOM and by Heads of Delegation (HOD) and the applied threshold values for core and pre-core indicators in the HELCOM open sea assessment units are presented in the [Baltic Sea Environment Proceedings no.156](http://stateofthebalticsea.helcom.fi/wp-content/uploads/2019/09/BSEP156-Eutrophication.pdf) (p.10, Table 2).

```{r read raw datasets, message = FALSE, warning = FALSE, echo = TRUE, results = "hide"}
## root location of the raw data
dir_B <- file.path(dirname(dir_prep), "bhi-data", "BHI 2.0")
dir_rawdata <- file.path(dir_B, "Goals", "CW", "EUT")

eut_thresholds_values <- read.delim(file.path(dir_rawdata, "eut_threshold_values.csv"), sep = ";")

eut_thresholds <- eut_thresholds_values %>% 
  rename(basin = Assessment.units, winter_DIN = DIN.._mol.l.1., winter_DIP = DIP.._mol.l.1., 
         summer_chla = Chla.._g.l.1., summer_secchi = Water.clarity..m., oxyg_debt = O2..mg.l.1.) %>% 
  select(basin, winter_DIN, winter_DIP, summer_chla, summer_secchi, oxyg_debt) %>% 
  mutate(basin = str_replace_all(basin,"_",""),
         ## ‘N’ means that the indicator is not applicable there, so it will be replaced as NA
         oxyg_debt = str_replace(oxyg_debt, "N", " "),
         oxyg_debt = as.numeric(oxyg_debt))

## TO-DO: INCORPORATE IT TO SECCHI DATA

str(eut_thresholds)
str(basin_lookup_table)
```
<br/>

### 2.2 Centralization & Normalization

**Secchi data**
```{r read raw datasets, message = FALSE, warning = FALSE, echo = TRUE, results = "hide"}

## read in secchi data
secchi_raw_ices <- read.delim(file.path(dir_rawdata, "SecchiDepth_ICES", "SecchiDepth_ICES.csv"), sep = ";")
secchi_raw_smhi <- read.delim(file.path(dir_rawdata, "SecchiDepth_SMHI", "SecchiDepth_SMHI.csv"), sep = ";")
```
<br/>

**Oxygen**
```{r read raw datasets, message = FALSE, warning = FALSE, echo = TRUE, results = "hide"}
oxden1 <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "denmark1ox", "denmark1ox.csv"), sep = ",")
oxden2 <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "denmark2ox", "denmark2ox.csv"), sep = ",")
oxest <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "estoniaox", "estoniaox.csv"), sep = ",")
oxfin <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "finlandox", "finlandox.csv"), sep = ",")
oxger <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "germanyox", "germanyox.csv"), sep = ",")
oxlat <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "latviaox", "latviaox.csv"), sep = ",")
oxlit <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "lithuaniaox", "lithuaniaox.csv"), sep = ",")
oxpol <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "polandox", "polandox.csv"), sep = ",")
oxrus <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "russiaox", "russiaox.csv"), sep = ",")
oxswe <- read.delim(file.path(dir_rawdata, "OxygenDebt_ICES", "swedenox", "swedenox.csv"), sep = ",")
```
<br/>

**Chlorophyll a and Nutrients**
```{r read raw datasets, message = FALSE, warning = FALSE, echo = TRUE, results = "hide"}
chlorophyll <- read.delim(file.path(dir_rawdata, "NestData", "nestdata_summer_chlorophyl.csv"), sep = ",")
nutrient <- read.delim(file.path(dir_rawdata, "NestData", "nestdata_winter_nutrients.csv"), sep = ",")
```
<br/>


#### 2.2.1. Merging datasets

**Secchi datasets**
```{r merge two finish datasets, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5, fig.height = 4.5}

# Data overview
colnames(secchi_raw_ices)
str(secchi_raw_ices)

colnames(secchi_raw_smhi)
str(secchi_raw_smhi)

## Merging the two datasets
secchi <- bind_rows( 
   # smhi
  secchi_raw_smhi %>% 
    rename(secchi = Value, date = Sampling.date, year = Year, 
         # use the decimal degrees for lat and lon (as for ICES)
         lat = Sample.latitude..DD., lon = Sample.longitude..DD.,
         # don't find the "cruise" variable?? (Station.ID..VISS. as example)
         cruise = Station.ID..VISS., station = Station.name, bottom_m = Station.water.depth) %>%
  mutate(date =  as.Date(date), month = format(date, "%m"),
         secchi = as.numeric(secchi), year = as.character(year),
         supplier = 'smhi') %>% 
    ## REMOVE OSPAR ROWS (TO-DO)
  dplyr::select(cruise, station, date, year, month,
                lat, lon, secchi, bottom_m, supplier),
    # ices
    secchi_raw_ices %>% 
  rename(secchi = Secchi.Depth..m.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         bottom_m = as.numeric(bottom_m), 
         supplier = 'ices'))

## CHECK FOR DUPLICATES (TO-DO)   
str(secchi)

```
<br/>

**Oxygen data**
```{r merge two finish datasets, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5, fig.height = 4.5}

# Data overview
colnames(oxden1)
str(oxden1)

colnames(secchi_raw_smhi)
str(oxswe)

oxygen <- bind_rows(
  oxden1 %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         bottom_m = as.numeric(bottom_m),
         country = "denmark"),
  oxden2 %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         station = as.character(station),
         bottom_m = as.numeric(bottom_m),
         country = "denmark"),
  oxest %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         bottom_m = as.numeric(bottom_m),
         country = "estonia"),
  oxfin %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         oxygen_ml_l = as.numeric(as.character(oxygen_ml_l)),
         bottom_m = as.numeric(bottom_m),
         country = "finland"),
  oxger %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         oxygen_ml_l = as.numeric(as.character(oxygen_ml_l)),
         bottom_m = as.numeric(bottom_m),
         country = "germany"),
  oxlat %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         bottom_m = as.numeric(bottom_m),
         country = "latvia"),
  oxlit %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         bottom_m = as.numeric(bottom_m),
         country = "lithuania"),
  oxpol %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         country = "poland"),
  oxrus %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         station = as.character(station),
         country = "russia"),    
  oxswe %>% 
  rename(oxygen_ml_l = DOXY..ml.l.,  date = yyyy.mm.ddThh.mm, 
                lat = Latitude..degrees_north., lon = Longitude..degrees_east., 
                cruise = Cruise, station = Station, bottom_m = Bot..Depth..m.) %>%
  select(-Type, -PRES..db., -TEMP..deg.C., -PSAL..psu.) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"),
         station = as.character(station),
         oxygen_ml_l = as.numeric(as.character(oxygen_ml_l)),
         bottom_m = as.numeric(bottom_m),
         country = "sweden"))

str(oxygen)
```
<br/>

**Chlorophyll a and Nutrients data**
```{r merge two finish datasets, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5, fig.height = 4.5}

# Data overview
colnames(chlorophyll)
str(chlorophyll)

colnames(nutrient)
str(nutrient)

chla <- chlorophyll %>% 
  rename(chl = CHL,  date = OBSDATE, 
                lat = LATITUDE, lon = LONGITUDE, 
                cruise = SHIP, id = ID) %>%
  select(-OBSTIME, -OBSDEP) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"))

nutrients <- nutrient %>% 
  rename(no3 = NO3N,  no2 = NO2N, nh4 = NH4N, po4 = PO4P, date = OBSDATE, 
                lat = LATITUDE, lon = LONGITUDE, 
                cruise = SHIP, id = ID) %>%
  select(-OBSTIME, -OBSDEP, -NO23N, -TOTN) %>% 
  mutate(date =  as.Date(date), year = format(date, "%Y"), 
         date =  as.Date(date), month = format(date, "%m"))

```


### 2.3 Initial Data Exploration

#### 2.3.1 Compare versus Previous Years Data

#### 2.3.2 Timeseries Plots

#### 2.3.3 Map
