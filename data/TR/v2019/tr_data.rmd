
```{r tr data preamble, eval = FALSE, echo = TRUE, message = FALSE, warning = FALSE}
source(here::here("R", "setup.R"))
source(here::here("R", "spatial.R"))

## root location of the raw data
dir_B <- file.path(dirname(dir_prep), "bhi-data", "BHI 2.0")
dir_rawdata <- file.path(dir_B, "Goals", "TR")
```


### 2.1 Datasets with Sources {-}

Data for all countries were downloaded from the [Eurostat Database](https://ec.europa.eu/eurostat/data/database); data downloaded for 'Nights spent at tourist accommodation establishments by all NUTS regions' and 'Nights spent at tourist accommodation establishments by coastal and non-coastal area'

<br/>

#### 2.1.1 Tourism Accommodations Data {-}

**Nights spent at tourist accommodation establishments by all NUTS regions**
<!-- dataset save location BHI_share/BHI 2.0/Goals/TR/Accomodation/tour_occ_nin2 -->

```{r nights spent at tourist accommodation establishments by nuts2 regions, echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("TIME:", "1999-2019"), 
  c("Unit of measure:", "Number"),
  c("GEO:", "Selected all Geographic areas (includes NUTS0, NUTS1, NUTS2; view by CODE so can join to NUTS shapefile)"),
  c("Classification of economic activities - NACE Rev.2:", "Hotels; holiday and other short-stay accommodation; camping grounds, recreational vehicle parks and trailer parks"),
  c("Country of residence:", "Reporting Country")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Eurostat database](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=tour_occ_nin2&lang=en) <br/> Downloaded 22 July, 2020 by Andrea De Cervo")
```
<br/>


**Nights spent at tourist accommodation establishments by coastal and non-coastal area**  
<!-- dataset save location BHI_share/2.0/Goals/TR/Accomodation/tour_occ_nin2c -->
<!-- dataset save location BHI_share/2.0/Goals/TR/Metadata/tour_occ_esms.sdmx -->

```{r nights spent at tourist accommodation establishments by coastal and non-coastal area, echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("TIME:", "2012-2019"), 
  c("Unit of measure:", "Number"),
  c("GEO:", "Selected all Geographic areas (includes NUTS0, NUTS1, NUTS2; view by CODE so can join to NUTS shapefile)"),
  c("Classification of economic activities - NACE Rev.2:", "Hotels; holiday and other short-stay accommodation; camping grounds, recreational vehicle parks and trailer parks"),
  c("Country of residence:", "Reporting Country"),
  c("Territorial tipology:", "Select all")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [Eurostat database](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=tour_occ_nin2c&lang=en), [Metadata](http://ec.europa.eu/eurostat/cache/metadata/en/tour_occ_esms.htm)  <br/> Downloaded 22 July, 2020 by Andrea De Cervo")
```
<br/>

#### 2.1.2 EU Baltic countries GVA Data {-}

Data for the 8 EU Baltic countries were extracted from the [2020 EU Blue economy report](https://ec.europa.eu/maritimeaffairs/sites/maritimeaffairs/files/2020_06_blueeconomy-2020-ld_final.pdf) on July 14 2020 by Andrea De Cervo. These are the same data used for the Coastal Economiess subgoal, but for the Tourism goal data from only the 'Coastal Tourism' sub-sectors are used: .

In particular, detailed info on GVA% by sub-sector and activity per member state were extracted from the tables on the [Annex I](https://ec.europa.eu/maritimeaffairs/sites/maritimeaffairs/files/2020_06_blueeconomy-2020-annexes-ld-part1_final.pdf) and [Annex II](https://ec.europa.eu/maritimeaffairs/sites/maritimeaffairs/files/2020_06_blueeconomy-2020-annexes-ld-part2_final.pdf).



#### 2.1.3 Reference values {-}

As part of EU's Blue Growth strategy, the [coastal and maritime tourism sector](https://ec.europa.eu/maritimeaffairs/policy/coastal_tourism_en) has been identified as an area with special potential to foster a smart, sustainable and inclusive Europe.

The [Study in support of policy measures for maritime and coastal tourism at EU level](https://ec.europa.eu/maritimeaffairs/sites/maritimeaffairs/files/docs/body/study-maritime-and-coastal-tourism_en.pdf) (Page 157) states that the Nordic Countries sea basins tourism has a potential to grow annually by 2.2 % until 2020. We therefore keep the target to an annual growth of 2.2%.


### 2.2 Centralization & Normalization {-}

#### 2.2.1 Spatial Data {-}

[Eurostat NUTS regions shapefiles can be found here](https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/nuts). The NUTS 2016, 2013, 2010, 2006, and 2003 were downloaded at 1:10 million resolution (NUTS_RG_10M_year_4326_LEVL_2or3 files within the zipped downloads are the polygons in espg 4326 projection).

```{r NUTS2 polygons}
##  NUTS2 shapefiles
## using level 2 but also have level 3 NUTS if those are better?
nutsshpfiles <- grep(
  "NUTS_RG_10M_[0-9]{4}_4326_LEVL_2/.*\\.shp", 
  list.files(file.path(dirname(dir_B), "Shapefiles", "all_NUTS_shapefiles"), recursive = TRUE),
  value = TRUE
)
for(f in nutsshpfiles){
  ## gives GDAL Errors / CPL_read_ogr warnings, but reads in the shapefile...
  shp <- sf::st_read(
    dsn = file.path(dirname(dir_B), "Shapefiles", "all_NUTS_shapefiles", stringr::str_extract(f, "ref.*LEVL_2(?=/)")),
    stringsAsFactors = FALSE
  )
  shp_baltic <- shp %>% filter(CNTR_CODE %in% c("SE", "FI", "EE", "LV", "LT", "PL", "DE", "DK"))
  assign(sprintf("nuts2_%s_shp", stringr::str_extract(f, "(?<=10M_)[0-9]{4}")), shp_baltic)
}

## 25km inland buffer for BHI regions
buffer_25km_inland <- st_read(
  file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"),
  "BHI_shapefile_25km_buffer"
)
buffer_25km_inland <- cbind(
  buffer_25km_inland,
  buffer_area_km2 = as.numeric(sf::st_area(buffer_25km_inland)/(1000^2))
)


## create some spatial objects for making maps later
buffer_25k_simple <- rmapshaper::ms_simplify(input = buffer_25km_inland) %>% sf::st_as_sf()

basemap <- ggplot2::ggplot(rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")) +
  geom_sf(size = 0.1, color = "burlywood", alpha = 0.4) +
  theme(panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3")) +
  scale_x_continuous(limit = c(4, 32)) +
  scale_y_continuous(limit = c(53.5, 66)) 
```

<br>

#### 2.2.2 Clean Accommodation Data by NUTS2 and by Coastal areas: standardize units, rename fields/variables {-}

```{r read in NUTS2 regional accommodations data, message = FALSE}
## regional tourism accommodation (nights) per NUTS2 assessemnt areas
tourism_accommodations_data <- file.path(
    dir_rawdata, "Accommodation", 
    "tour_occ_nin2_nuts_codes", 
    "tour_occ_nin2_1_Data.csv"
  )
tourism_accommod <- read.csv(
  tourism_accommodations_data, 
  stringsAsFactors = FALSE
)

## accommodation (nights) per NUTS2 and Coastal/Non-Coastal areas
tourism_accommodations_coastal_data <- file.path(
    dir_rawdata, "Accommodation", 
    "tour_occ_nin2c_nuts_codes", 
    "tour_occ_nin2c_1_Data.csv"
  )
tourism_accommod_coastal <- read.csv(
  tourism_accommodations_coastal_data, 
  stringsAsFactors = FALSE
)
```

```{r clean NUTS accommodations data}
tourism_accommod_clean <- tourism_accommod %>%
  select(
    year = TIME, nuts2 = GEO,
    unit = UNIT, value = Value, 
    flag_notes = Flag.and.Footnotes
  ) %>% 
  mutate(
    flag_notes = case_when(
      flag_notes == "b" ~ "break in timeseries",
      flag_notes == "u" ~ "low reliability",
      flag_notes == "bu" ~ "break in timeseries and low reliability",
      !flag_notes %in% c("b", "u", "bu") ~ ""
    )
  )

## check dataflags
unique(tourism_accommod_clean$flag_notes)
filter(tourism_accommod_clean, flag_notes == "low reliability") # no Baltic countries
filter(tourism_accommod_clean, flag_notes == "break in timeseries and low reliability") # none
filter(tourism_accommod_clean, flag_notes == "break in timeseries") # not such a concern...?

## remove flags_notes
tourism_accommod_clean <- tourism_accommod_clean %>% 
  select(-flag_notes, -unit) %>% 
  filter(substr(nuts2, 1, 2) %in% c("SE", "FI", "EE", "LV", "LT", "PL", "DE", "DK")) %>% 
  mutate(value = ifelse(value == ":", NA, value)) %>% 
  mutate(value = stringr::str_remove_all(value, ",")) %>% 
  mutate(value = as.numeric(value))
# summary(tourism_accommod_clean$value)
```

```{r clean Coastal accommodations by NUTs regions data}
tourism_accommod_coastal_clean <- tourism_accommod_coastal %>%
  select(
    year = TIME, nuts2 = GEO, coastal = TERRTYPO,
    unit = UNIT, value = Value, 
    flag_notes = Flag.and.Footnotes
  ) %>% 
  mutate(
    flag_notes = case_when(
      flag_notes == "b" ~ "break in timeseries",
      flag_notes == "u" ~ "low reliability",
      flag_notes == "bu" ~ "break in timeseries and low reliability",
      !flag_notes %in% c("b", "u", "bu") ~ ""
    )
  )

## check dataflags
unique(tourism_accommod_coastal_clean$flag_notes)
filter(tourism_accommod_coastal_clean, flag_notes == "low reliability") # no Baltic countries
filter(tourism_accommod_coastal_clean, flag_notes == "break in timeseries and low reliability") # none
filter(tourism_accommod_coastal_clean, flag_notes == "break in timeseries") # not such a concern...?

## remove flags_notes
tourism_accommod_coastal_clean <- tourism_accommod_coastal_clean %>% 
  select(-flag_notes, -unit) %>% 
  mutate(coastal = case_when(
    coastal == "Total" ~ "all",
    coastal == "Coastal areas" ~ "coastal",
    coastal == "Non-coastal areas" ~ "noncoastal"
  )) %>% 
  # filter(coastal == "coastal") %>% 
  filter(substr(nuts2, 1, 2) %in% c("SE", "FI", "EE", "LV", "LT", "PL", "DE", "DK")) %>% 
  mutate(value = ifelse(value == ":", NA, value)) %>% 
  mutate(value = stringr::str_remove_all(value, ",")) %>% 
  mutate(value = as.numeric(value))
# summary(tourism_accommod_clean$value)
```

```{r join coastal tourism and nuts2 overall datasets into one dataframe}
tourism_accommod_alldf <- full_join(
  tourism_accommod_clean %>% 
    mutate(coastal = "all") %>% 
    rename(num_nights = value),
  tourism_accommod_coastal_clean %>% 
    rename(num_nights_coastal = value),
  by = c("year", "nuts2", "coastal")
)

tourism_accommod_alldf <- tourism_accommod_alldf %>% 
  mutate(num_nights_coastal = case_when(
    coastal == "all" & year < 2012 ~ num_nights,
    !(coastal == "all" & year < 2012) ~ num_nights_coastal
  )) %>% 
  select(-num_nights) %>% 
  tidyr::pivot_wider(names_from = "coastal", values_from = "num_nights_coastal")
```


<br>

**Join tourism accommodations info with NUTS2 shapefiles**

```{r join tourism accom data with nuts2 rgns, results = "show", fig.width = 9.5, fig.height = 4}
## all tourism, join with nuts2 regions
tourism_all_nuts_spatial <- tourism_accommod_alldf %>% 
  select(year, nuts2, all) %>% 
  tidyr::pivot_wider(names_from = year, names_prefix = "tour_", values_from = all)

tourism_all_nuts_spatial <- nuts2_2016_shp %>% 
  rename(nuts2 = NUTS_ID) %>% 
  left_join(tourism_all_nuts_spatial, by = "nuts2")


## coastal tourism, join with nuts2 regions
tourism_coastal_nuts_spatial <- tourism_accommod_alldf %>% 
  select(year, nuts2, coastal) %>% 
  tidyr::pivot_wider(names_from = year, names_prefix = "tour_", values_from = coastal)

tourism_coastal_nuts_spatial <- nuts2_2016_shp %>% 
  rename(nuts2 = NUTS_ID) %>% 
  left_join(tourism_coastal_nuts_spatial, by = "nuts2")


## plotting initial values, raw NUTS2 regions employment rates
map_pal <- c("gray", "darkslateblue", "royalblue", "purple", "plum", "orchid", "magenta4")
gridExtra::grid.arrange(
  basemap + 
    geom_sf(data = tourism_all_nuts_spatial, aes(fill = tour_2019), size = 0.1) +
    # geom_sf(data = buffer_25k_simple, fill = NA, color = "red", size = 0.2) +
    scale_fill_gradientn(
      colors = map_pal,
      values = c(0, 0.001, 0.2, 0.4, 0.65, 1),
      limits = c(0, 3.5*10^7)
    ) +
    labs(fill = "Number of Nights") +
    theme(legend.position = c(0.15, 0.85)) +
    ggtitle("Tourism Accommodations in 2019"),
  basemap + 
    geom_sf(data = tourism_coastal_nuts_spatial, aes(fill = tour_2019), size = 0.1, show.legend = FALSE) +
    # geom_sf(data = buffer_25k_simple, fill = NA, color = "red", size = 0.2) +
    scale_fill_gradientn(
      colors = map_pal,
      values = c(0, 0.001, 0.2, 0.4, 0.65, 1),
      limits = c(0, 3.5*10^7)
    ) +
    labs(fill = "Number of Nights") +
    ggtitle("Tourism Coastal Accommodations in 2019"),
  nrow = 1
)
## loop through all years to check employment data alignment with reporting regions...
```



#### 2.2.3 Clean Coastal Tourism GVA Data: standardize units, rename fields/variables

The downloaded raw datasets provides an overview of the Blue Economy in the individual Member States. They include the established sectors, ensuring a comparable analysis across all the MS. In particular, these datasets shows an overview of the Blue Economy by sub-sector and activity for employment, GVA and turnover.

```{r load raw gva data for tourism goal, echo = TRUE, message = FALSE, warning = FALSE}

columns <- c(
  "country",
  "Sector",
  "Sub-sector",
  "Activity",
  "Persons employed (2009)",
  "Persons employed (2018)",
  "Persons employed (delta 2018-09)",
  "Turnover (M€) (2009)",
  "Turnover (M€) (2018)",
  "Turnover (M€) (delta 2018-09)",
  "Value added at factor cost (M€) (2009)",
  "Value added at factor cost (M€) (2018)",
  "Value added at factor cost (M€) (delta 2018-09)",
  "GVA to turnover (%) (2009)",
  "GVA to turnover (%) (2018)",
  "GVA to turnover (%) (delta 2018-09)",
  "Gross operating surplus (M€) (2009)",
  "Gross operating surplus (M€) (2018)",
  "Gross operating surplus (M€) (delta 2018-09)",
  "Gross profit margin (%) (2009)",
  "Gross profit margin (%) (2018)",
  "Gross profit margin (%) (delta 2018-09)",
  "Personnel costs per employee (k€) (2009)",
  "Personnel costs per employee (k€) (2018)",
  "Personnel costs per employee (k€)  (delta 2018-09)"
) 
columns <- columns %>% 
    stringr::str_to_lower() %>% 
    stringr::str_remove(" \\(.*\\) ") %>% 
    stringr::str_replace_all(" |\\(|\\)|-", "_") %>% 
    stringr::str_remove("_$") %>% 
    stringr::str_replace_all("__", "_")

dir_ecodata <- file.path(dir_B, "Goals", "LE", "ECO")
for(f in grep(".*csv", list.files(dir_ecodata), value = TRUE)){
  
  tmp <- read.csv(file.path(dir_ecodata, f), sep = ";")
  tmp[,] <- sapply(tmp[,], as.character)
  colnames(tmp) <- columns
  
  assign(
    sprintf("%s_gva", substr(f, 1, 3)),
    tmp %>% 
      mutate_at(
        setdiff(columns, c("country", "sector", "sub_sector", "activity")), 
        function(x){as.numeric(stringr::str_replace(stringr::str_remove(x, "%| |-$"), ",", "."))}
      ) %>% 
      mutate_at(
        vars(matches(".*delta.*|.*gva_to_turnover.*|.*gross_profit_margin.*")), 
        function(x){x/100}
      ) %>% 
      filter(country != "", sector != "", sub_sector!= "", activity!= "")
  )
}
```

<br>

**Clean, explore and merge GVA datasets**

```{r merging eu gva data for tourism goal}
eco_data_combined <- rbind(den_gva, est_gva, fin_gva, ger_gva, lat_gva, lit_gva, pol_gva, swe_gva) %>% 
  filter(!(sector == "all sectors" & sub_sector == "all sub-sectors")) %>% 
  filter(sector %in% c("Coastal tourism", "Maritime transport")) %>% 
  filter(sub_sector %in% c("Passenger transport", "Accommodation", "Transport", "Other expenditure"))
```

<br>

#### 2.2.4 Save Coastal Tourism Data Layer

```{r save coastal tourism accommodations data layer}
# write_csv(
#   select(
#     coastal_tourism_bhi_rgns, 
#     region_id = bhi_id,
#     year,
#     tourism_country_gva
#   ), 
#   dir_layers
# )
```

<br>

### 2.3 Initial Data Exploration


#### 2.3.1 Timeseries Plots: check regional tourism accommodations time series

```{r plot and check regional employment time series, results = "show", fig.width = 9.5}
ggplot(tourism_accommod_alldf) +
  geom_point(aes(x = year, y = all, colour = nuts2), size = 0.8) +
  geom_line(aes(x = year, y = emp, colour = nuts2)) +
  facet_wrap(~bhi_id, ncol = 6) +
  labs(x = NULL, y = "Employment rate (%)\n", color = "NUTS2 2016 Region") + 
  scale_color_manual(values = pal)
```
