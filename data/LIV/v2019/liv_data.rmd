
```{r liv data preamble, echo = FALSE, include = FALSE, error = FALSE}
source(here::here("R", "setup.R"))
source(here::here("R", "spatial.R"))
```


### 2.1 Datasets with Sources {-}
<br/>

#### 2.1.1 EuroStat Data {-}

**Employment rates by sex, age and NUTS 2 regions % (lfst_r_lfe2emprt)**
<!-- dataset save location BHI_share/BHI 2.0/Goals/LE/LIV/Employment_NUTS2/lfst_r_lfe2emprt_2019_w_nutscodes -->

```{r employment rates by sex age and nuts2 regions, echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("TIME:", "1999-2019"), 
  c("AGE:", "Y15-74 (code) From 15 to 64 years (label)"),
  c("GEO:", "NUTS2 (Filtering - Nuts level) SHOW: CODES"), # need NUTS codes to match to BHI regions
  c("SEX:", "Total"),
  c("Unit of measure:", "Percentage")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [eurostat database](https://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=lfst_r_lfe2emprt&lang=en) <br/> Downloaded 3 August, 2020 by Ellie Campbell")
```
<br/>

The source for the regional labour market information down to NUTS level 2 is the EU Labour Force Survey (EU-LFS). This is a quarterly household sample survey conducted in all Member States of the EU and in EFTA and Candidate countries.   

The EU-LFS survey follows the definitions and recommendations of the International Labour Organisation (ILO). To achieve further harmonization, the Member States also adhere to common principles when formulating questionnaires. The LFS' target population is made up of all persons in private households aged 15 and over. For more information see the EU Labour Force Survey (lfsi_esms, see paragraph 21.1.).  

The EU-LFS is designed to give accurate quarterly information at national level as well as annual information at NUTS 2 regional level and the compilation of these figures is well specified in the regulation. Microdata including the NUTS 2 level codes are provided by all the participating countries with a good degree of geographical comparability, which allows the production and dissemination of a complete set of comparable indicators for this territorial level.  

- b 	break in time series  
- c 	confidential  
- d 	definition differs, see metadata  
- e 	estimated  
- f 	forecast  
- i 	see metadata (phased out)  
- n 	not significant  
- p 	provisional  
- r 	revised  
- s 	Eurostat estimate (phased out)  
- u 	low reliability  
- z 	not applicable 

<br/>

**Population change - Demographic balance and crude rates at national level**  
<!-- dataset save location BHI_share/2.0/Goals/LE/LIV/Population_Jan1/demo_gind -->
<!-- maybe in future use eurostat pkg https://ropengov.github.io/eurostat/articles/eurostat_tutorial.html -->

```{r population change at national level, echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Years:", "1990-2020"), 
  c("Demographic Indicator (INDIC_DE):", "Population on 1 January - Total, Average Population - Total, Natural change of population (NATGROW), Total population change (GROW), Crude rate of total population change (GROWRT)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [eurostat database](https://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=demo_gind&lang=en) <br/> Downloaded 21 July, 2019 by Andrea De Cervo")
```
<br/>

Summary explanation about indicator: Eurostat aims at collecting from the EU-28's Member States' data on population on 31st December, which is further published as 1 January of the following year. The recommended definition is the 'usual resident population' and represents the number of inhabitants of a given area on 31st December. However, the population transmitted by the countries can also be either based on data from the most recent census adjusted by the components of population change produced since the last census, either based on population registers.

<br/>

**Employment and population (subset to data for Russia)**  
<!-- dataset save location BHI_share/2.0/Goals/LE/LIV/Pop_Employ_Russia_2019 -->

```{r employment and population for russia, echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Years:", "1990-2019"), 
  c("NA_ITEM:", "Total population national concept (POP_NC), Employees domestic concept (SAL_DC), Total employment domestic concept (EMP_DC)"), 
  c("GEO:", "RU	Russia"),
  c("Unit:", "Thousand persons (THS_PER)")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [eurostat database](http://appsso.eurostat.ec.europa.eu/nui/show.do?dataset=naida_10_pe&lang=en) <br/> Downloaded 21 July, 2020 by Andrea De Cervo")
```
<br/>

#### 2.1.2 HYDE Database {-}

**Population density data**  
<!-- dataset save location BHI_share/2.0/Goals/LE/LIV/GriddedPop_2016AD -->
<!-- ftp://ftp.pbl.nl/hyde/ -->

```{r population density data from hyde database, echo = FALSE, results = "asis"}
tab <- t(data.frame(
  c("Proceed to the FTP-server to", "download the datasets"), 
  c("Connect as", "Guest"),
  c("Index:", "hyde/hyde3.2/2017_beta_release/001/zip/"), 
  c("Name:", "2016AD_pop.zip")))

colnames(tab) <- c("Option", "Specification")
rownames(tab) <- NULL

knitr::kable(tab, caption = "Source: [HYDE database, FTP-server](https://themasites.pbl.nl/tridion/en/themasites/hyde/download/index-2.html) <br/> Downloaded 21 July, 2020 by Andrea De Cervo")
```
<br/>

Year of data = 2005. Data were a 5' resolution. Population density within a 25km buffer from the coast will be used.

<br/>


### 2.2 Centralization & Normalization {-}


Summary of steps/analysis in this document:

**Clean Employment Rates Data**
- check and remove dataflags
- explore reporting NUTS2 regions, check whether need to do spatial corrections
- clean and visualize national employment data

**Clean/Create Population Density Data**
- intersect BHI 25km buffer with NUTS2 (reporting areas used in employment rate data) 
- aggregate population density across the buffer-NUTS2 polygons to get population in the polygons

**Corrections for NUTS Regions Misalignment**
- corrections for Finland data-- different regions used than included in the raw data...
- corrections for Lithuania...

**Derive and save Numbers Employed per BHI Region & Country**
- calculate number employed (in polygons from BHI buffer-NUTS2 intersection) as the population in the polygon times the relevant NUTS2 employment rate
- sum number employed in BHI buffer-NUTS2 polygons across each BHI region, to get coastal employed per BHI region
- sum population in BHI buffer-NUTS2 polygons across each BHI region, to get coastal population per BHI region
- divide coastal employed per BHI region by coastal population per BHI region, to get BHI region coastal employment rate


```{r read in regional data, message = FALSE}
dir_rawdata <- file.path(dir_B, "Goals", "LE", "LIV")

## regional employment per NUTS2 assessemnt areas, raw data from eurostat
regional_employ_data <- file.path(
    dir_rawdata, "Employment_NUTS2", 
    "lfst_r_lfe2emprt_2019_w_nutscodes", 
    "lfst_r_lfe2emprt_1_Data.csv"
  )
regional_employ <- read.csv(
  regional_employ_data, 
  stringsAsFactors = FALSE
)

## PopDensity, derived from HYDE density data and BHI buffer (25km inland) shapefile
# nuts2_pop_density <- read_csv(file.path(dir_rawdata, "NUTS2_BHI_ID_Pop_density_in_buffer.csv"))
```


#### 2.2.1 Clean Employment Rates Data: standardize units, rename fields/variables {-}

```{r clean regional data object}
rgn_employ_clean <- regional_employ %>%
  select(
    year = TIME, nuts2 = GEO,
    unit = UNIT, value = Value, 
    flag_notes = Flag.and.Footnotes
  ) %>% 
  mutate(
    flag_notes = case_when(
      flag_notes == "b" ~ "break in timeseries",
      flag_notes == "u" ~ "low reliability",
      flag_notes == "bu" ~ "break in timeseries and low reliability",
      !flag_notes %in% c("b", "u", "bu") ~ ""
    )
  )

## check dataflags
unique(rgn_employ_clean$flag_notes)
filter(rgn_employ_clean, flag_notes == "low reliability") # not Baltic country
filter(rgn_employ_clean, flag_notes == "break in timeseries and low reliability") # not Baltic country
filter(rgn_employ_clean, flag_notes == "break in timeseries") # not such a concern

## remove flags_notes
rgn_employ_clean <- rgn_employ_clean %>% select(-flag_notes, -unit)
```


**Join employment info with NUTS2 shapefile**

```{r join with nuts2 shapefile, results = "show", fig.width = 9.5, fig.height = 4}
nuts2_shp <- sf::st_read(
  dsn = file.path(dirname(dir_B), "Shapefiles", "NUTS2006_Level_2_3"),
  layer = "NUTS2006_Level_2",
  stringsAsFactors = FALSE
)
rgn_employ_nuts_spatial <- rgn_employ_clean %>% 
  mutate(value = ifelse(value == ":", NA, value)) %>% 
  mutate(value = as.numeric(value)) %>% 
  tidyr::pivot_wider(names_from = year, names_prefix = "yr_", values_from = value)

rgn_employ_nuts_spatial <- nuts2_shp %>% 
  sf::st_transform(crs = 4326) %>% 
  rename(nuts2 = NUTS_ID) %>% 
  left_join(rgn_employ_nuts_spatial, by = "nuts2")


## plotting initial values, raw NUTS2 regions employment rates
basemap <- ggplot2::ggplot(rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")) +
  geom_sf(size = 0.1, color = "burlywood", alpha = 0.4) +
  theme(panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3")) +
  scale_x_continuous(limit = c(4, 32)) +
  scale_y_continuous(limit = c(53.5, 66)) 

buffer_25km_inland <- st_read(
  file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"),
  "BHI_shapefile_25km_buffer"
)
buffer_25k_simple <- rmapshaper::ms_simplify(input = buffer_25km_inland) %>% sf::st_as_sf()


gridExtra::grid.arrange(
  basemap + 
    geom_sf(data = rgn_employ_nuts_spatial, aes(fill = yr_2019), size = 0.1) +
    geom_sf(data = buffer_25k_simple, fill = NA, color = "red", size = 0.2) +
    scale_fill_gradient2(mid = "thistle", midpoint = 65, limits = c(60, 90)) +
    labs(fill = "Employment Rate %") +
    theme(legend.position = c(0.15, 0.85)) +
    ggtitle("Employment 2019"),
  basemap + 
    geom_sf(data = rgn_employ_nuts_spatial, aes(fill = yr_2009), size = 0.1, show.legend = FALSE) +
    geom_sf(data = buffer_25k_simple, fill = NA, color = "red", size = 0.2) +
    scale_fill_gradient2(mid = "thistle", midpoint = 65, limits = c(60, 90)) +
    ggtitle("Employment 2009"),
  nrow = 1
)
## why is there not info for much of Finland?? and missing rates also for Lithuania...
```



```{r aligning NUTS regions with employment data across years and changes in regions reporting}

```


**From NUTS2 to BHI regions**

```{r match nuts2 to BHI rgns using shapefiles}

```


#### 2.2.2 Clean Population Data: standardize units, rename fields/variables {-}

```{r clean nuts pop area data}
## nuts2 population data

nuts2_pop_area1 = nuts2_pop_density %>%
                  select(-PopUrb,-PopRur,-PopUrb_density_in_NUTS2_buffer_per_km2,-PopRur_density_in_NUTS2_buffer_per_km2, -HELCOM_ID, - CNTR_CODE) %>%
                  dplyr::rename(rgn_id = BHI_ID,
                                nuts2 = NUTS_ID,
                                pop = PopTot,
                                pop_km2 = PopTot_density_in_NUTS2_buffer_per_km2,
                                country = rgn_nam,
                                basin = Subbasin,
                                area = NUTS2_area_in_BHI_buffer_km2) %>% 
                  mutate(country_abb = substr(nuts2, 1, 2))
```


**Check NUTS2 names from Finland**

Shapefiles have names from 2006, check accom1 and accom_coast1 to see if the names have been updated, will need to fix. 

- ![Map of old NUTS2 names for Gulf of Finland](BHI_regions_NUTS2_plot.png?raw=true)  
- ![Map of new NUTS2 names for Gulf of Finland](new_FI_nuts2.png?raw=true)  

```{r check fi nuts2 names}
check1 = regional_employ1 %>% filter(grepl("FI", nuts2)) %>% 
  select(nuts2, nuts2_name) %>% 
  distinct()
## These are the newer region names : FI1B, FI1C, FI1D

check2 = nuts2_pop_area1 %>% 
  filter(grepl("FI", nuts2)) %>% 
  select(nuts2) %>% 
  distinct()
## These are the older region names: FI18, FI1A

## Challenge because of coasts
## FI1C is associated with both the Gulf of Finland and the Aland Sea. FI1B has a small fraction associated with Aland Sea, the rest is Gulf of Finland

## Old FI18, contains both FI1C and FI1B. May need to combine data from the new regions, and apply fraction from the older region.  Helsinki is in FI1B, which would assign almost entirely to BHI 32 and whereas FI1C would divide more equally btween BHI 36 and BHI 32. Therefore, combining these regions in order to apply the division generated from the old region may have a different result.

## old FI1A seems to be the same along the coast as the new FI1D but new FI1D covers inland areas previously in FI13

## Do this after joining accom and accom_coast with the nuts2_pop_area data, will have to add these regions back in.
```


**Check for incorrectly assigned NUTS2 regions to BHI regions and fix**

As mentioned in Section 4. 

```{r check for incorrectly assigned NUTS2 regions, message = FALSE}
## write to csv, fix manually, re-import csv
misassigned_nuts2 = nuts2_pop_area1 %>% select(nuts2, country, rgn_id)

## read in corrected assignments - same file as used for TR

# add BHI rgn 21 to the previously corrected file. 9.28.2016. 
corrected_nuts2 = read.csv(file.path(dir_liv,"misassigned_nuts2_manually_corrected.csv"), sep=";", stringsAsFactors = FALSE) %>%       rbind(c("PL63","Poland", as.integer(21),NA,NA, "", as.integer(21), 'Poland')) %>%
      mutate(rgn_id = as.integer((rgn_id)),
             X.correct_BH_ID = as.integer(X.correct_BH_ID))

## join nuts2_pop_area1 with corrected data and fix

nuts2_pop_area2 = nuts2_pop_area1 %>%
                  full_join(., corrected_nuts2,
                            by=c("rgn_id","nuts2","country")) %>%
                  select(-country,-rgn_id,-incorrect,-BHI_ID_manual, -X.country_manual) %>%
                  dplyr::rename(country =X.correct_country,
                               rgn_id = X.correct_BH_ID) %>%
                  select(rgn_id,nuts2,country,country_abb,basin,pop,pop_km2,area) %>%
                  group_by(rgn_id, nuts2, country,country_abb,basin) %>%
                  summarise(pop =sum(pop),
                            pop_km2 = sum(pop_km2),
                            area = sum(area)) %>% ## some regions occurr twice because of correcting the assignment, sum to get single value for each region
                  ungroup()

str(nuts2_pop_area2)

```

#### 2.2.3 Join Employment and Population Datasets {-}

**Join accom times series with nuts pop and area**

Join data with inner join, this will exclude Finland areas with name mismatches. Fix Finnish data and add back into the dataset

```{r join regional_employ1 with nuts_pop_area1, message = FALSE, results = "hide"}
employ_nuts1 = inner_join(regional_employ1, nuts2_pop_area2,
                         by=c("nuts2"))

 dim(regional_employ1) ## 5344    5
 dim(nuts2_pop_area2) ## 60 8
 dim(employ_nuts1) ## 896  12

 str(employ_nuts1) ## this is now missing the Finnish data where there are name discrepancies

```

**Get Finnish data that was excluded**

One challenge is that the new regions are two regions (FI1B,FI1C) where the old region was one (FI18). FI1B includes Helsinki and plot below shows similar pattern but that FI1B is between 5.8 to 6.8 higher than FI1C. 

Assume because FI1B is where Helsinki is located, this is the majority of the population, so apply the FI1B rate. 

FI1D (new name) areas match old FIA1 areas - so this is a straight-forward fix.  

![See Population density from Eurostat](pop_density_nuts2_FI.png?raw=TRUE)
[Eurostat Population density image source](http://ec.europa.eu/eurostat/statistical-atlas/gis/viewer/#). Layer is under 'Background Maps' 

```{r Get Finnish data that was excluded, message = FALSE}

## Get Finnish data renamed so that employmodating and population data match
fi_employ_newnuts = regional_employ1 %>%
                   filter(nuts2 %in% c("FI1C","FI1B", "FI1D"))
# fi_employ_newnuts

## compare the employment percentage between FI1C and FI1B which used to be one region
ggplot(fi_employ_newnuts) +
  geom_point(aes(year,value, colour=nuts2, shape=nuts2)) +
  ggtitle("Comparison of Finnish Region NUTS2 Employment percentage")

## difference between FI1B and FI1C
fi_employ_newnuts %>% 
  select(-nuts2_name) %>%
  spread(nuts2,value) %>%
  mutate(diff_1b_1c = FI1B - FI1C) %>%
  filter(!is.na(diff_1b_1c))
            
##Assume because FI1B is where Helsinki is located, this is the majority of the population, so apply the FI1B rate. 
    ## Therefore, only retain data for FI1B (exclude FI1C)

fi_employ_newnuts1 = fi_employ_newnuts %>% 
                     filter(nuts2 != "FI1C")




## assign old nuts names to employ data
fi_employ_newnuts1 = fi_employ_newnuts1 %>%
                    mutate(nuts_old = ifelse(nuts2 == "FI1B", "FI18",
                                      ifelse(nuts2 == "FI1D", "FI1A","")),
                           nuts2_name_old= ifelse(nuts2 == "FI1B","old region",nuts2_name )) %>%
                    select(-nuts2, -nuts2_name) %>%
                    dplyr::rename(nuts2=nuts_old,
                                  nuts2_name = nuts2_name_old)
                        
# head(fi_employ_newnuts1) ## there are NA but were NA for all regions in those years

## Get population data associated with old nuts names
fi_nuts_oldnuts = nuts2_pop_area2 %>%
                  filter(nuts2 %in% c("FI18","FI1A"))

# fi_nuts_oldnuts


## join fi employ to fi pop and area

fi_employ_correct_nuts = full_join(fi_employ_newnuts1, fi_nuts_oldnuts,
                          by=c("nuts2")) %>%
                          select(year,nuts2,nuts2_name,unit,
                                 value,rgn_id,country,country_abb,basin, pop,
                                 pop_km2,area)


# str(fi_employ_correct_nuts)
```

**Join Finnish data to other regional data**

```{r Join Finnish data to other regional data, message = FALSE, results = "hide"}

### bind to rest of data
colnames(fi_employ_correct_nuts)
colnames(employ_nuts1)

employ_nuts2 = bind_rows(employ_nuts1, fi_employ_correct_nuts) %>%
              dplyr::rename(employ_rate = value)
```


**Plot and check regional employment time series** 

```{r  Plot and check regional employment time series }
ggplot(employ_nuts2) +
  geom_point(aes(year,employ_rate, colour=nuts2)) +
  geom_line(aes(year,employ_rate, colour=nuts2)) +
  facet_wrap(~country, scale="free_y") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90,
                                   hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("Time series Percent Employed NUTS2")


```

```{r restrict regional dataset years, message = FALSE}

employ_nuts3 = employ_nuts2 %>% 
              filter(year >=2000)
```



#### 2.2.4 Missing BHI Regions?

Expected missing:

- 19,22, and 33 from Russia
- 30 has no coastline

```{r are bhi regions missing from regional employ and pop join, message = FALSE, results = "hide"}
employ_nuts3 %>% select(rgn_id) %>% distinct() %>% arrange(rgn_id)

## there are 38 regions

## missing: 19, 22, 30, 33

```

<br/>

### 2.3 Initial Data Exploration

#### 2.3.1 Compare with Previous Years Data

#### 2.3.2 Timeseries Plots

#### 2.3.3 Maps
