
## 3. Pressure Model

### 3.1 Current conditions 
Value in most recent year. 

PCB 153 = 2016  

### 3.2 Rescaling  
Min value = 0

Max value = maximum value across all basin 1990 - max year  


## 4. Data layer preparation

```{r setup}
## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## root location of the raw data
source(here::here("R", "setup.R"))
source(here::here("R", "data.R"))
source(here::here("R", "spatial.R"))

dir_A <- file.path(dirname(dir_prep), "bhi-data")
dir_B <- file.path(dirname(dir_prep), "bhi-data", "BHI 2.0")
dir_rawdata <- file.path(dir_B, "Pressure", "atmos_con")
```

### 4.1 Read in and organize data

#### 4.1.1 Read in data

Computed annual atmospheric deposition of PCB-153 over the six Baltic Sea sub-basins, the whole Baltic Sea (BAS) and normalized deposition to the Baltic Sea (Norm) for period 1990-2016. Units: kg/year.
```{r read in data}
pcb153 <- read.csv(file.path(dir_rawdata, "pcb153.csv"), sep=";", stringsAsFactors = FALSE)

basin_lookup <- file.path(dir_prep, "supplement", "lookup_tabs", "rgns_complete.csv") %>% 
  read_csv() %>%
  dplyr::select(bhi_id = region_id, subbasin, rgn_nam = region_name, HELCOM_ID = helcom_id) %>%
  mutate(
    subbasin = as.character(subbasin),
    rgn_nam = as.character(rgn_nam)
  )

# Create lookup table to match the basins to the holas (sub)basins
basins <- bind_rows(
  c(basin = "Archipelago Sea", subbasin = "Aland Sea"),
  c(basin = "Baltic Proper", subbasin = "Arkona Basin"),
  c(basin = "Baltic Proper", subbasin = "Bornholm Basin"),
  c(basin = "Baltic Proper", subbasin = "Eastern Gotland Basin"),
  c(basin = "Baltic Proper", subbasin = "Gdansk Basin"),
  c(basin = "Baltic Proper", subbasin = "Northern Baltic Proper"),
  c(basin = "Baltic Proper", subbasin = "Western Gotland Basin"),
  c(basin = "Bothnian Bay", subbasin = "Bothnian Bay"),
  c(basin = "Bothnian Sea", subbasin = "Bothnian Sea"),
  c(basin = "Bothnian Sea", subbasin = "The Quark"),
  c(basin = "Gulf of Finland", subbasin = "Gulf of Finland"),
  c(basin = "Gulf of Riga", subbasin = "Gulf of Riga"),
  c(basin = "Kattegat", subbasin = "Kattegat"),
  c(basin = "The Sound", subbasin = "The Sound"),
  c(basin = "Western Baltic", subbasin = "Bay of Mecklenburg"),
  c(basin = "Western Baltic", subbasin = "Great Belt"),
  c(basin = "Western Baltic", subbasin = "Kiel Bay"))

```

#### 4.1.2 Transform data to long format
```{r transform to long format}
pcb153_long <- pcb153 %>%
  gather(subbasin_abb, value, -X) %>%
  rename(year = X) %>% 
  mutate(unit = "kg/year",
         basin = ifelse(subbasin_abb == "ARC", "Archipelago Sea",
                        ifelse(subbasin_abb == "BOB", "Bothnian Bay",
                               ifelse(subbasin_abb == "BOS", "Bothnian Sea",
                                      ifelse(subbasin_abb == "BAP", "Baltic Proper",
                                             ifelse(subbasin_abb == "GUF", "Gulf of Finland",
                                                    ifelse(subbasin_abb == "GUR", "Gulf of Riga",
                                                           ifelse(subbasin_abb == "KAT", "Kattegat",
                                                                  ifelse(subbasin_abb == "SOU", "The Sound",
                                                                         ifelse(subbasin_abb == "WEB", "Western Baltic",
                                                                                       NA))))))))),
         year = as.numeric(year),
         value = str_replace(value, ",", "."),
         value = as.numeric(value)) %>% 
  # filter out the whole Baltic Sea (BAS) and normalized deposition to the Baltic Sea (Norm) values
         filter(subbasin_abb != "BAS", subbasin_abb != "Norm")

```

#### 4.1.3 Join to HOLAS basin names  
Data are joined to HOLAS basin names because these are what are associated with BHI regions. This is a slightly indirect approach, could have made a look up table to associated the major basins from the deposition data directly with the BHI regions, but this should have the same result.  
```{r join to holas basin names}
pcb153_basins <- pcb153_long %>%
  full_join(., basins, by = "basin") 
```

#### 4.1.4 Plot data
```{r plot raw data}
# Plot data by major basin provided
ggplot(pcb153_basins) +
  geom_point(aes(year, value)) +
  facet_wrap(~ basin)+
  ylab("PCB 153 kg/year")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                  hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("PCB153 Atmospheric Deposition by Major Basin")

# Plot data by subbasin
ggplot(pcb153_basins) +
  geom_point(aes(year, value)) +
  facet_wrap(~ subbasin)+
  ylab("PCB 153 kg/year")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                  hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("PCB153 Atmospheric Deposition by Subbasin")
```


### 4.2 Current value

#### 4.2.1 Get most recent year for current value
```{r get current year value}
max_yr_pcb153 <- pcb153_basins %>%
  select(year)%>%
  max()%>%
  as.numeric()

```

#### 4.2.2 Get current pressure data
```{r get current pressure data values}
current_pcb153 <- pcb153_basins %>%
  filter(year == max_yr_pcb153) %>%
  select(subbasin, value, unit, year)
```

#### 4.2.3 Plot current year data
```{r plot current year data}
ggplot(current_pcb153)+
  geom_point(aes(subbasin, value), size = 2.5)+
  ylab("PCB 153 kg/year")+
  ylim(0,15)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                  hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("PCB 153 Atmospheric Deposition in 2016")

```


### 4.3 Rescale data  

#### 4.3.1 Maximum value
Select maximum value across all basins within each time series. 
PCB 153:  Baltic Proper in 1990, 40.246 kg/year  
```{r select max values}
max_pcb153 <- pcb153_basins %>%
  select(value)%>%
  max()%>%
  as.numeric()
max_pcb153

## which year and basin 
pcb153_basins %>% filter(value == max_pcb153) %>% select(basin, year, unit, value) %>% distinct()

```

#### 4.3.2 Minimum value
Minimum value is 0, the value at which there is no pressure 
```{r select min values}
min_pcb153 = 0
```

#### 4.3.3 Join current, max, and min values
```{r join current max and min values}
pcb153_rescale <- current_pcb153 %>%
  mutate(min = min_pcb153, 
         max= max_pcb153) %>% 
  dplyr:: rename(current = value)
```

#### 4.3.4 Plot current, max and min
```{r plot current max and min}
ggplot(gather(pcb153_rescale, type, concentration, -subbasin, -unit, -year)) +
  geom_point(aes(subbasin, concentration, colour = type, shape = type), size= 2.5)+
  ylab("PCB 153 kg/year") +
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("PCB 153 minimum, maximum, and current pressure value")

```


#### 4.3.5 Rescale data
```{r rescale data}
pcb153_rescale1 <- pcb153_rescale %>%
  mutate(pcb153_normalize = (current - min)/(max - min))
```

#### 4.3.6 Plot rescaled pressure layer
```{r plot rescales pressure layer}
ggplot(pcb153_rescale1) +
  geom_point(aes(subbasin, pcb153_normalize), size= 2.5)+
  ylab("Pressure Value") +
  ylim(0,1)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("PCB 153 pressure value")
```

### 4.4 Pressure layer for BHI regions

#### 4.4.1 Apply basin values to BHI regions
```{r apply basin values to BHI regions}
pcb153_rgn <- pcb153_rescale1 %>%
            full_join(., basin_lookup, by = "subbasin") %>%
            select(rgn_id, pcb153_normalize)%>%
            arrange(rgn_id)

pcddf_rgn = pcddf_rescale1 %>%
            full_join(., bhi_lookup, by = "holas_basin") %>%
            select(rgn_id, pcddf_normalize)%>%
            arrange(rgn_id)

```

#### 4.4.2 Plot Pressure layer by BHI regions
```{r Plot Pressure layer by BHI regions}
ggplot(pcb153_rgn)+
  geom_point(aes(rgn_id,pcb153_normalize), size= 2.5)+
  ylab("Pressure Value")+
  ylim(0,1)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("PCB 153 pressure value by BHI regions")




ggplot(pcddf_rgn)+
  geom_point(aes(rgn_id, pcddf_normalize), size= 2.5) +
 ylab("Pressure Value")+
  ylim(0,1)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("PCDD/F Pressure value by BHI regions")

```


### 4.5 Prepare and save object for layers  

#### 4.5.1 Prepare objects
```{r prepare object for layers}
po_atmos_pcb153 = pcb153_rgn %>%
                  dplyr::rename(pressure_score = pcb153_normalize)


po_atmos_pcddf = pcddf_rgn %>%
                  dplyr::rename(pressure_score = pcddf_normalize)
```

#### 4.5.2 Save objects to layers
```{r save objects to layers}
write.csv(po_atmos_pcb153,file.path(dir_layers,"po_atmos_pcb153_bhi2015.csv"), row.names = FALSE)

write.csv(po_atmos_pcddf,file.path(dir_layers,"po_atmos_pcddf_bhi2015.csv"), row.names = FALSE)
```

