## 4. Pressure Model
Overlay trawl effort with BHI shape files so can assign intensity per each BHI region.

### 4.1 Current pressure data  
Use most recent year: 2016  
Xtrawl_r_y = sum hours within a BHI region in each year *y* in each region *r* / area of BHI region *r* (hours/km2)  

 
### 4.2 Rescale data
Calculate Xtrawl_r_y for all data years.  

min value = 0  

max value = max(Xtrawl_r_y) in any area  
*It should be discussed with the team if this is okay, or if think even higher pressure in the past, should take pressure_max =  max(XtrawL_r_y) x 1.2  or some greater percentage?*  

for now: 

rescaled value = (max - current) / (max - min)

```{r r bottom trawling data setup, echo = FALSE, message = FALSE}
## root location of the raw data
source(here::here("R", "setup.R"))
source(here::here("R", "spatial.R"))

dir_A <- file.path(dirname(dir_prep), "bhi-data")
dir_B <- file.path(dirname(dir_prep), "bhi-data", "BHI 2.0")
dir_rawdata <- file.path(dir_B, "Pressure", "bottom_trawling")
dir_intermediate <- file.path(here::here("data", "pressures", "bottom_trawling", version_year, "intermediate"))

bhi_basin_lookup <- read_delim(file.path(dir_prep, "supplement", "lookup_tabs", "bhi_basin_country_lookup.csv"), delim = ";") %>% 
  rename(subbasin = Subbasin) 
```

### 4.3 Read joined shapefile and explore it 

### 4.3.1 Extract swept area (SubsurfSAR) by BHI region 
**Only 2 BHI regions have reported swept area: 3 and 4**
```{r extract swept area data, eval = FALSE, echo = FALSE}
trawling_bhi_raw <- sf::st_read(file.path(dir_intermediate, "trawling_bhi_raw.shp"))
# st_geometry(trawling_bhi_raw) <- NULL

swept_area <- trawling_bhi_raw %>%
  mutate(swept = ifelse(SubsurfSAR >= 0, SubsurfSAR, NA)) %>% # the negative values are considered "missing info"
  filter(!is.na(BHI_ID)) %>% # those with not assigned BHI_ID are points out of the Baltic Sea area
  filter(!is.na(swept)) %>% 
  dplyr::select(swept, BHI_ID) %>%
  group_by(BHI_ID) 
```


### 4.5 Calculate and Plot Swept Area

Plot below shows the trawling intensity per area in each region in 2016. 

```{r calculate and plot hours per area region}
# rescale swept_area
bottom_trawling_score <- swept_area %>%
  mutate(max = max(swept), 
         min = min(swept),
         score = round((swept - min) / (max - min), 1),
         score = ifelse(is.na(score), min, score)) %>% # only one value for bhi_id = 4
  group_by(BHI_ID) %>% 
  summarize(mean_score = round(mean(score, na.rm = TRUE), 3)) %>% 
  dplyr::select(BHI_ID, 
         score = mean_score) 

# join bhi regions and include final pressure scores
bottom_trawling_score <- full_join(bhi_basin_lookup, bottom_trawling_score, 
                                   by = "BHI_ID") %>% 
  mutate(score = ifelse(is.na(score), 0, score)) %>% 
  dplyr::select(BHI_ID, 
                pressure_score = score)

# save pressure layer
write_csv(bottom_trawling_score, file.path(dir_layers, 'hab_bottom_trawl_bhi2019.csv')) 

```

