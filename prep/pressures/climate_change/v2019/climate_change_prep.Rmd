
```{r setup}

## Libraries
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RMySQL)
library(stringr)
library(tools)
library(rprojroot) # install.packages('rprojroot')

## root location of the raw data
source(here::here("R", "setup.R"))
source(here::here("R", "data.R"))
source(here::here("R", "spatial.R"))

dir_A <- file.path(dirname(dir_prep), "bhi-data")
dir_B <- file.path(dirname(dir_prep), "bhi-data", "BHI 2.0")
dir_rawdata <- file.path(dir_B, "Pressure", "climate_change")
regions_shape(sp_dir = file.path(dirname(dir_B), "Shapefiles"))

```

## 3. HELCOM data organization

Two data layers, surface water salinity and temperature. 

### 3.1 Current conditions
Current conditions = mean salinity 2010-2014  

### 3.2 Rescaling data
Salinity is projected to decrease with climate change, therefore we take the maximum from the historical period and the minimum from the current period. 

min value = minimum annual salinity during the future projection period (2020-2050)   

max value = maximum annual salinity duing reference period (1960-1990)  

**Greater pressure with lower salinity, so will need to take the inverse of the rescaling**

### 3.3 BHI region pressure
Apply basin values to BHI regions.  

## 4 Prepare surface salinity Data layer

### 4.1 Read in surface salinity data
Read in all datasets
```{r read surface sal in data}
## read in data
climate_change_ices <- read.csv(file.path(dir_rawdata, "Helcom", 'helcom.csv'))

basin_lookup <- file.path(dir_prep, "supplement", "lookup_tabs", "rgns_complete.csv") %>% 
  read_csv() %>%
  dplyr::select(bhi_id = region_id, subbasin, rgn_nam = region_name, HELCOM_ID = helcom_id) %>%
  mutate(
    subbasin = as.character(subbasin),
    rgn_nam = as.character(rgn_nam)
  )
```

### 4.2 Clean data
```{r clean surface sal data}
## remove where year is NA - these are for basins from baltsem not used
ices_sst <- climate_change_ices %>% 
  rename(
    latitude = Latitude..degrees_north.,
    longitude = Longitude..degrees_east., 
    temp = TEMP..deg.C.
  ) %>%
  mutate(
    date =  as.Date(yyyy.mm.ddThh.mm), 
    year = format(date, "%Y"), 
    month = format(date, "%m"),
    month = str_replace(month, "^0+", ""),
    cruise = as.character(Cruise),
    station = as.character(Station)
  ) %>%
  filter(year >= 1990) %>% 
  select(cruise, station, date, year, month, latitude, longitude, temp) 

ices_sal <- climate_change_ices %>% 
  rename(
    lat = Latitude..degrees_north.,
    lon = Longitude..degrees_east., 
    sal = PSAL..psu.
  ) %>%
  mutate(
    date =  as.Date(yyyy.mm.ddThh.mm), 
    year = format(date, "%Y"), 
    month = format(date, "%m"),
    month = str_replace(month, "^0+", ""),
    cruise = as.character(Cruise),
    station = as.character(Station)
  ) %>%
  filter(year >= 1990) %>% 
  select(cruise, station, date, year, month, lat, lon, sal) 
```


### 4.3 Match BHI regions {-}
```{r match bhi regions}
## assign bhi basins to sal and temp data 
sal_rgns <- join_rgns_info(
  ices_sal, helcomID_col = "helcom_id", country_col = "country", 
  latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"), 
  buffer_shp = NULL
) 

# Filter out data points out of the Baltic Sea
sal_rgns_nobs <- sal_rgns %>% 
  filter(!(between(lon, 8.4118, 9.6403)),
         !(between(lat, 53.547, 53.570)))

## Make these points (x = 24.4800, y = 64.670); (y = 63.952,	x = 22.850); (y = 63.950,	x = 22.850) part of "Finland	FIN	Bothnian Bay	SEA-017	BHI_ID42	14930.90	FALSE"

# Check data points where no BHI_id can be assigned
sal_rgns_nobhi <- sal_rgns_nobs %>% 
  filter(is.na(BHI_ID))      

temp_rgns <- join_rgns_info(
  ices_sst, helcomID_col = "helcom_id", country_col = "country", 
  latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"), 
  buffer_shp = NULL
) 

# Check data points where no BHI_id can be assigned
temp_rgns_nobhi <- temp_rgns %>% 
  filter(is.na(BHI_ID))
```

### 4.4 Plot data
```{r plot surface sal data}
## make basemap
basemap <- ggplot2::ggplot(rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")) + 
  geom_sf(size = 0.1, color = "burlywood", alpha = 0.4) +
  scale_x_continuous(limit = c(4, 32)) +
  scale_y_continuous(limit = c(53.5, 66)) +
  theme(panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3"))

bhi_rgns_simple <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% sf::st_as_sf()

sal_nobhi_map <- basemap +
  geom_sf(data = bhi_rgns_simple, fill = "white", size = 0.2, color = "burlywood") +
  geom_sf(
    mapping = aes(colour = station),
    data = sf::st_as_sf(
      sal_rgns_nobhi, 
      coords = c("lon", "lat"), 
      crs = 4326
    ),
    size = 1.8
  ) +
  labs(x = NULL, y = NULL, colour = "Station") +
  ggtitle("Sampling Locations")

# library(ggmap)
map <- get_map(location = c(8.5, 53, 32, 67.5))
no_coastal_or_bhi_id <- ggmap(map) + 
  geom_point(aes(x = 24.4800, y = 64.670), data = sal_rgns, color = "red", size = 1) +
  labs(x = NULL, y = NULL)
## there are locations outside of the Baltic Sea
### Remove: 53.547	9.863, 53.550	9.820, 53.570	9.670, 53.6500	9.5167
	
# Plot salinity time series
ggplot(sal_rgns)+
  geom_line(aes(year, sal)) + 
  facet_wrap(~Subbasin, scales = "free_y") +
  theme(axis.text.x = element_text(colour = "grey20", size = 8, angle=90, 
                                    hjust = .5, vjust = .5, face = "plain")) +
  ggtitle("ICES Annual Surface Salinity time series")

# Plot temperature time series
ggplot(temp_rgns)+
  geom_line(aes(year, temp)) + 
  facet_wrap(~Subbasin, scales = "free_y") +
  theme(axis.text.x = element_text(colour = "grey20", size = 8, angle = 90, 
                                    hjust=.5, vjust=.5, face = "plain")) +
  ggtitle("ICES Annual Temperature time series")
```


### 4.4 Current conditions 2015-2019

#### 4.4.1 Current conditions if taken from the hindcast data
Five most recent years

```{r current surface sal ices}
max_year <- 2019

surf_sal_current <- sal_rgns %>%
  filter(year >= (max_year - 4)) %>%
  select(Subbasin, sal) %>%
  group_by(Subbasin) %>%
  summarise(current_surf_sal = mean(sal)) %>%
  ungroup()
              

surf_sal_current

```

### 4.4.3 Plot Current condition - compare datasets
```{r plot current surface sal condition}
ggplot(bind_rows(
       mutate(surf_sal_current, type = "hindcast"),
       mutate(surf_sal_current_echam5, type = "echam5")))+
  geom_point(aes(basin_name_holas, current_surf_sal, colour=type, shape=type), size=2.5)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Mean Surface Salinity 2010-2014, compare time series")


```



### 4.5 Minimum val
From projection data, extract the minimum annual surface salinity for each basin between 2020-2050. Compare between the two projection data sets. ECHAM5 projects higher salinity than HADCM3, difference greatest between the two in Great Belt, Kattegat, Kiel, The Sound (which are the most variable and most saline).  
```{r min surface sal}

min_surf_sal1 = proj_surf_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_surface)%>%
           group_by(basin_name_holas)%>%
           summarise(min_surf_sal = min(sal_surface))%>%
           ungroup()

min_surf_sal1

min_surf_sal2 = proj2_surf_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_surface)%>%
           group_by(basin_name_holas)%>%
           summarise(min_surf_sal = min(sal_surface))%>%
           ungroup()

min_surf_sal2


## difference between two model estimates

proj_diff = full_join(min_surf_sal1,min_surf_sal2,by="basin_name_holas")%>%
            dplyr::rename(min_echam5 = min_surf_sal.x,
                          min_hadcm3 = min_surf_sal.y)%>%
            mutate(proj_diff = min_echam5 - min_hadcm3)

## plot difference
ggplot(proj_diff)+
    geom_point(aes(basin_name_holas, proj_diff))+
 theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Diff in Projected Min Sal (ECHAM5 - HADCM3)")

```


### 4.6 Maximum surface sal

#### 4.6.1 Take max from hindcast dataset
From hindcast data, extract the maximum annual surface temperature for each basin between 1960-1990
```{r max surf sal from hindcast}
max_surf_sal = hind_surf_sal %>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_surface)%>%
             group_by(basin_name_holas)%>%
             summarise(max_surf_sal = max(sal_surface))%>%
             ungroup()
max_surf_sal
```


#### 4.6.2 Take max from ECHAM5 dataset
From echam5 data, extract the maximum annual surface temperature for each basin between 1960-1990. 
```{r max surf sal from echam 5}
max_surf_sal_echam5 = proj_surf_sal %>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_surface)%>%
             group_by(basin_name_holas)%>%
             summarise(max_surf_sal = max(sal_surface))%>%
             ungroup()
max_surf_sal_echam5
```


#### 4.6.3 Plot max historic value: Compare hindcast and echam5
Relatively similar between time series.  
```{r plot max surface sal condition}
ggplot(bind_rows(
       mutate(max_surf_sal, type = "hindcast"),
       mutate(max_surf_sal_echam5, type = "echam5")))+
  geom_point(aes(basin_name_holas, max_surf_sal, colour=type, shape=type), size=2.5)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Max Surface Salinity 1960-1990, compare time series")


```

### 4.7 Plot min, max, and current
If black dot ("current salinity") is not between the max and min salinity values, using these values to rescale would mean that the pressure is either at its highest (if salinity is lower than the min value) or lowest (if above the max value). Current salinity is not great than the max value.  However, it is often lower than the minimum value.  

#### 4.7.1 Using different datasets
Hindcast for past and current, compare projections for future
```{r plot surf sal min, max, current}
##join data for plot
surf_sal_data = full_join(surf_sal_current,min_surf_sal1, by="basin_name_holas")%>%
             full_join(.,min_surf_sal2, by="basin_name_holas") %>%
            full_join(.,max_surf_sal, by="basin_name_holas") %>%
            dplyr::rename(min_surf_sal_echam5 = min_surf_sal.x,
                          min_surf_sal_hadcm3 = min_surf_sal.y)%>%
              gather(sal_type, salinity, -basin_name_holas)
  

ggplot(surf_sal_data)+
  geom_point(aes(basin_name_holas,salinity, colour = sal_type, shape=sal_type), size=2)+
  scale_shape_manual(values=c(19,19,19,17))+
  scale_colour_manual(values = c("black","red","light blue","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Basin Annual Surface Sal Min, Current, Max")

ggplot(surf_sal_data)+
  geom_point(aes(sal_type,salinity, colour = sal_type, shape=sal_type), size=2)+
  facet_wrap(~basin_name_holas, scales = "free_y")+
  scale_shape_manual(values=c(19,19,19,17))+
  scale_colour_manual(values = c("black","red","light blue","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("Basin Annual Surface Sal Min, Current, Max")

```

#### 4.7.2 Using only ECHAM5
```{r plot echam 5 all components}
max_surf_sal_echam5  = max_surf_sal_echam5 %>%
                       dplyr::rename(salinity =max_surf_sal) %>%
                        mutate(type = "max")
min_surf_sal1 = min_surf_sal1 %>%
                dplyr::rename(salinity =min_surf_sal) %>%
                        mutate(type = "min")
surf_sal_current_echam5  =surf_sal_current_echam5 %>%
                          dplyr::rename(salinity =current_surf_sal) %>%
                        mutate(type = "current")

surf_sal_data_echam5 = bind_rows(max_surf_sal_echam5,
                                 min_surf_sal1,
                                 surf_sal_current_echam5)

ggplot(surf_sal_data_echam5)+
  geom_point(aes(basin_name_holas,salinity, colour = type, shape=type), size=2)+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("ECHAM5 Basin Annual Surface Sal Min, Current, Max")


  ggplot(surf_sal_data_echam5)+
  geom_point(aes(type,salinity, colour =type, shape=type), size=2)+
  facet_wrap(~basin_name_holas, scales = "free_y")+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("ECHAM5 Basin Annual Surface Sal Min, Current, Max")

```

**It is clear that using only a single dataset produces a much better result** 




### 4.8 Rescale data for pressure layer
**Use data from ECHAM5**  
1. Normalize data  
3. Take inverse so greater pressure with fresher conditions  

```{r rescale to min and max surf sal}
 surf_sal_rescale =surf_sal_data_echam5 %>%
                    spread(type,salinity)%>%
               mutate(surf_sal_normalize = (current - min) / (max - min),
                      surf_sal_rescale_inv = 1- surf_sal_normalize)
                      ## take inverse 

 surf_sal_rescale
```

#### 4.8.1 Plot Surface pressure layer by basin 

```{r plot surface pressure layers by basin}
ggplot(surf_sal_rescale)+
  geom_point(aes(basin_name_holas,surf_sal_rescale_inv),size=2.5)+
  ylim(0,1)+
  ylab("Pressure value")+
  xlab("Basin")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                  hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Surface salinity pressure layer")



```




### 4.9 Assign basin values to BHI regions

#### 4.9.1 Read in lookup for BHI regions
```{r read in bhi lookup}
bhi_holas_lookup = read.csv(file.path(dir_cc, 'bhi_basin_country_lookup.csv'), sep=";")%>%
                   select(BHI_ID, Subbasin)%>%
                   dplyr::rename(rgn_id = BHI_ID, 
                                 basin_name= Subbasin)
             

```

#### 4.9.2 join lookup for BHI regions to sst_rescale
```{r join bhi regions to  surf_sal_rescale}
 surf_sal_rescale1 = surf_sal_rescale %>%
              full_join(., bhi_holas_lookup, by=c("basin_name_holas" = "basin_name"))%>%
              select(rgn_id,surf_sal_rescale_inv)%>%
              dplyr::rename(pressure_score = surf_sal_rescale_inv)%>%
              arrange(rgn_id)


```

#### 4.9.3 Plot rescaled surface salinity by BHI ID
```{r plot surface salinity pressure by bhi id}
ggplot(surf_sal_rescale1)+
  geom_point(aes(rgn_id,pressure_score), size=2.5)+
   ggtitle("Surface Salinity pressure data layer")

```

### 4.10 Write surface salinity to layers 
```{r write surface sal to layers}
write.csv(surf_sal_rescale1, file.path(dir_layers, 'cc_sal_surf_bhi2015.csv' ), row.names=FALSE)

```



## 5 Prepare Deep salinity Data layer

### 5.1 Read in deep salinity data
```{r read deep sal in data}
## read in data

hind_deep_sal = read.csv(file.path(dir_salincc, 'sal_data_database/hind_sal_deep.csv'))

proj_deep_sal = read.csv(file.path(dir_salincc,'sal_data_database/proj_sal_deep.csv')) #echam5

proj2_deep_sal = read.csv(file.path(dir_salincc,'sal_data_database/proj2_sal_deep.csv')) #hadcm3
```

### 5.2 Clean data
```{r clean deep sal data}
## remove where year is NA - these are for basins from baltsem not used
hind_deep_sal %>% filter(is.na(year))

hind_deep_sal = hind_deep_sal %>%
           filter(!is.na(year))


proj_deep_sal %>% filter(is.na(year))

proj_deep_sal = proj_deep_sal %>%
           filter(!is.na(year))


proj2_deep_sal %>% filter(is.na(year))

proj2_deep_sal = proj2_deep_sal %>%
           filter(!is.na(year))
```


### 5.3 Plot data
```{r plot deep sal data}
ggplot(hind_deep_sal)+
  geom_line(aes(year,sal_deep, colour=factor(salin_bottom_depth))) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Hindcast Annual Deep Salinity time series")

ggplot(proj_deep_sal)+
  geom_line(aes(year,sal_deep,colour=factor(salin_bottom_depth))) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Projected A1b Annual Deep Salinity time series ECHAM5")

ggplot(proj2_deep_sal)+
  geom_line(aes(year,sal_deep,colour=factor(salin_bottom_depth))) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Projected A1b Annual Deep Salinity time series HADCM3")


### bind data together and plot in single plot
sal_deep_plot = bind_rows(
                mutate(hind_deep_sal, sim_name = "hindcast"),
                mutate(proj_deep_sal, sim_name = "echam5"),
                mutate(proj2_deep_sal, sim_name = "hadcm3")) %>%
                arrange(basin_name_holas,sim_name,year)

ggplot(sal_deep_plot)+
  geom_line(aes(year,sal_deep, colour = sim_name)) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  xlim(1950,2100)+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("All Annual Deep Salinity time series")



## Plot the depth for the deep data
ggplot(filter(sal_deep_plot, sim_name=="echam5"))+
  geom_point(aes(basin_name_holas,salin_bottom_depth),size=2.5) + 
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Depth from which Deep salinity value taken")


```


### 5.4 Current conditions 2010-2014

#### 5.4.1 Using hindcast data
Five most recent years

```{r current deep sal }
max_year = hind_deep_sal %>%
           select(year)%>%
           max()%>%
           as.numeric()

deep_sal_current = hind_deep_sal %>%
              filter(year >= (max_year-4))%>%
              select(basin_name_holas,sal_deep)%>%
              group_by(basin_name_holas)%>%
              summarise(current_deep_sal = mean(sal_deep))%>%
              ungroup()
              

deep_sal_current

```

#### 5.4.2 Using ECHAM5 data
Five most recent years

```{r current deep sal echam 5 }
year_range = seq(2010,2014)

deep_sal_current_echam5 = proj_deep_sal %>%
              filter(year %in% year_range)%>%
              select(basin_name_holas,sal_deep)%>%
              group_by(basin_name_holas)%>%
              summarise(current_deep_sal = mean(sal_deep))%>%
              ungroup()
              

deep_sal_current_echam5

```


### 5.5.1 Plot Current condition
```{r plot current deep sal condition}
ggplot(bind_rows(
       mutate(deep_sal_current, type = "hindcast"),
       mutate(deep_sal_current_echam5, type = "echam5")))+
  geom_point(aes(basin_name_holas, current_deep_sal, colour=type, shape=type), size=2.5)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Mean Deep Salinity 2010-2014, compare time series")

```



### 5.5 Minimum val
From projection data, extract the minimum annual deep salinity for each basin between 2020-2050. Compare the two projections. Direction of difference and magnitude is different among basins.
```{r min deep sal}

min_deep_sal1 = proj_deep_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_deep)%>%
           group_by(basin_name_holas)%>%
           summarise(min_deep_sal = min(sal_deep))%>%
           ungroup()

min_deep_sal1




min_deep_sal2 = proj2_deep_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_deep)%>%
           group_by(basin_name_holas)%>%
           summarise(min_deep_sal = min(sal_deep))%>%
           ungroup()

min_deep_sal2


## difference between two model estimates

proj_diff_deep = full_join(min_deep_sal1,min_deep_sal2,by="basin_name_holas")%>%
            dplyr::rename(min_echam5 = min_deep_sal.x,
                          min_hadcm3 = min_deep_sal.y)%>%
            mutate(proj_diff = min_echam5 - min_hadcm3)

## plot difference
ggplot(proj_diff_deep)+
    geom_point(aes(basin_name_holas, proj_diff))+
    geom_hline(yintercept = 0)+
 theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Difference in Deep Min Val between Projection datasets (ECHAM5 - HADCM3")

```


### 5.6 Maximum deep sal

#### 5.6.1 Using the Hindcast data
From hindcast data, extract the maximum annual deep temperature for each basin between 1960-1990
```{r max deep sal hindcast}
max_deep_sal = hind_deep_sal %>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_deep)%>%
             group_by(basin_name_holas)%>%
             summarise(max_deep_sal = max(sal_deep))%>%
             ungroup()
max_deep_sal
```

#### 5.6.2 Using the ECHAM 5 data
```{r max deep sal echam5}
max_deep_sal_echam5 = proj_deep_sal%>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_deep)%>%
             group_by(basin_name_holas)%>%
             summarise(max_deep_sal = max(sal_deep))%>%
             ungroup()
max_deep_sal_echam5
```

### 5.7 Plot min, max, and current

#### 5.7.1 Using different datasets
Hindcast for max and current, and different projections compared for future
```{r plot deep min, max, current}
##join data for plot
deep_sal_data = full_join(deep_sal_current,min_deep_sal1, by="basin_name_holas")%>%
             full_join(.,min_deep_sal2, by="basin_name_holas") %>%
            full_join(.,max_deep_sal, by="basin_name_holas") %>%
            dplyr::rename(min_deep_sal_echam5 = min_deep_sal.x,
                          min_deep_sal_hadcm3 = min_deep_sal.y)%>%
              gather(sal_type, salinity, -basin_name_holas)
  

ggplot(deep_sal_data)+
  geom_point(aes(basin_name_holas,salinity, colour = sal_type, shape=sal_type), size=2)+
  scale_shape_manual(values=c(19,19,19,17))+
  scale_colour_manual(values = c("black","red","light blue","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Basin Annual Deep Sal Min, Current, Max")

```

#### 5.7.2 Using only the ECHAM 5 dataset
```{r plot deep echam 5 all components}
max_deep_sal_echam5  = max_deep_sal_echam5 %>%
                       dplyr::rename(salinity =max_deep_sal) %>%
                        mutate(type = "max")
min_deep_sal1 = min_deep_sal1 %>%
                dplyr::rename(salinity =min_deep_sal) %>%
                        mutate(type = "min")
deep_sal_current_echam5  =deep_sal_current_echam5 %>%
                          dplyr::rename(salinity =current_deep_sal) %>%
                        mutate(type = "current")

deep_sal_data_echam5 = bind_rows(max_deep_sal_echam5,
                                 min_deep_sal1,
                                 deep_sal_current_echam5)

ggplot(deep_sal_data_echam5)+
  geom_point(aes(basin_name_holas,salinity, colour = type, shape=type), size=2)+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("ECHAM5 Basin Annual Deep Sal Min, Current, Max")


  ggplot(deep_sal_data_echam5)+
  geom_point(aes(type,salinity, colour =type, shape=type), size=2)+
  facet_wrap(~basin_name_holas, scales = "free_y")+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("ECHAM5 Basin Annual Deep Sal Min, Current, Max")

```

**It is clear that using only a single dataset produces a much better result** 


### 5.8 Rescale data for pressure layer
**Use data from ECHAM5**  
1. Normalize data  
3. Take inverse so greater pressure with fresher conditions  

```{r rescale to min and max deep sal}
 deep_sal_rescale = deep_sal_data_echam5 %>%
                    spread(type,salinity)%>%
                    mutate(deep_sal_normalize = (current - min) / (max - min),
                      deep_sal_rescale_inv = 1- deep_sal_normalize) ## take inverse 

 deep_sal_rescale
```

#### 4.8.1 Plot Deep pressure layer by basin 

```{r plot deep pressure layers by basin}
ggplot(deep_sal_rescale)+
  geom_point(aes(basin_name_holas,deep_sal_rescale_inv),size=2.5)+
  ylim(0,1)+
  ylab("Pressure value")+
  xlab("Basin")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                  hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Deep salinity pressure layer")



```
### 5.9 Assign basin values to BHI regions

#### 5.9.1 Read in lookup for BHI regions
Done above in 4.9.1  

#### 5.9.2 join lookup for BHI regions to sst_rescale
```{r join bhi regions to  deep_sal_rescale}
 deep_sal_rescale1 = deep_sal_rescale %>%
              full_join(., bhi_holas_lookup, by=c("basin_name_holas" = "basin_name"))%>%
              select(rgn_id,deep_sal_rescale_inv)%>%
              dplyr::rename(pressure_score = deep_sal_rescale_inv)%>%
              arrange(rgn_id)

```

#### 5.9.3 Plot rescaled deep salinity by BHI ID
```{r plot deep salinity pressure by bhi id}
ggplot(deep_sal_rescale1)+
  geom_point(aes(rgn_id,pressure_score), size=2.5)+
   ggtitle("Deep Salinity pressure data layer")

```

### 5.10 Write deep salinity to layers 
```{r write deep sal to layers}
write.csv(deep_sal_rescale1, file.path(dir_layers, 'cc_sal_deep_bhi2015.csv' ), row.names=FALSE)

```
