---
title: "Climate change pressure layer prep"
output:
  html_document:
    toc: true
    toc_depth: 4
    code_folding: hide
---

<br>
<br>

```{r climate change pressure preamble prep, message = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = TRUE, results = "hide", fig.width = 9.5, fig.height = 6)
source(here::here("R", "setup.R"))
loc <- here::here("prep", "pressures", "climate_change")
data_path <- here::here("data", "pressures", "climate_change", version_year, "climate_change_data.rmd")
```

<br>

## 1. Background {-}

The direct effects of climate change in the abiotic environment will be changes to water temperature and salinity. In the BHI framework, we will include sea surface temperature (SST) and surface salinity (SS) as climate change pressures. Depth of bottom water varies by basin. In BHI1.0 we also used bottom water salinity (BWS), but were not able to obtain this (modeled) data for more recent years to include.


### 1.1 Notes on the Data {-}

In BHI 1.0, data were extracted from the [BALTSEM model](http://www.balticnest.org/balticnest/thenestsystem/baltsem.4.3186f824143d05551ad20ea.html), run by BÃ¤rbel Muller-Karulis from the Baltic Sea Centre at Stockholm University. In BHI 2.0, since the BALTSEM is not as easily accessible, [data from HELCOM stations, obtained from ICES](https://ocean.ices.dk/Helcom/Helcom.aspx?Mode=1) was used instead.

These pressure layers are both calculated on the sub-basin scale, the scores which are then applied for all BHI regions  within the respective sub-basin.


### 1.2 Reference points and Rescaling {-}


Current conditions = mean salinity of recent 5 years

Salinity is projected to decrease with climate change, therefore we take the maximum from the historical period and the minimum from the current period. 

min value = minimum annual salinity during the future projection period (2020-2050)   

max value = maximum annual salinity during reference period (1960-1990)  

**Greater pressure with lower salinity, so will need to take the inverse of the rescaling**


<br/>

## 2. Data {-}

This prep document is used to generate and explore the following data layer:

- `cc_sst_bhi2019.csv` 
- `cc_sal_surf_bhi2019.csv` 

These are saved to the `layers` folder. These are derived from or informed by the raw Oceanographic datasets obtained from ICES.

<br>

```{r climate change pressure prep data, child = data_path, results = "asis", echo = FALSE}
```

<br/>

## 3. Prep: Wrangling & Derivations, Checks/Evaluation, Gapfilling {-}


Two data layers, surface water salinity and temperature. 

```{r read in the climate change pressure data}
## read in the climate raw data from ICES
## data.table::fread is faster than read.csv or readr
ices_cc_data <- data.table::fread(
  file.path(dir_B, "Pressure", "climate_change", "Helcom",  "helcom.csv"), 
  stringsAsFactors = FALSE
)
```

```{r load spatial data for climate change layers prep}
source(here::here("R", "spatial.R"))
rgns_complete <- file.path(dir_prep, "supplement", "lookup_tabs", "rgns_complete.csv")
regions_shape()
```

###  3.1 Initial Cleaning {-}

```{r rename and take subset of cc data columns}
ices_cc_data <- ices_cc_data %>% 
  dplyr::mutate(
    date = as.Date(`yyyy-mm-ddThh:mm`),
    year = format(date, "%Y"), 
    month = format(date, "%m"),
    month = str_replace(month, "^0+", ""),
    cruise = as.character(Cruise),
    station = as.character(Station),
    bottom_m = as.numeric(`Bot. Depth [m]`)
  ) %>% 
  dplyr::select(
    year,
    month,
    cruise,
    station,
    latitude = `Latitude [degrees_north]`, 
    longitude = `Longitude [degrees_east]`,
    temp = `TEMP [deg C]`,
    surfsal = `PSAL [psu]`
  ) %>% 
  filter(year >= 1960)
```


### 3.2 Match Monitoring Stations to Subbasins {-}

```{r match cc pressure layers data to subbasins using lat long and spatial files}
cc_data_w_rgns <- join_rgns_info(
  ices_cc_data, helcomID_col = "helcom_id", country_col = "country", 
  latlon_vars = c("latitude", "longitude"), return_spatial = TRUE, 
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"), 
  buffer_shp = NULL
) 
```


### 3.2 Check Spatial Assignment of Data, Distributions, Timeseries {-}

```{r load spatial files for climate change pressures maps}
bhi_rgn <- st_read(file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile"))
bhi_rgn_simple <- rmapshaper::ms_simplify(input = bhi_rgn) %>% 
  sf::st_as_sf() %>% 
  select(region_id = BHI_ID, rgn_nam, subbasin = Subbasin) %>% 
  mutate(region_nam = paste(rgn_nam, subbasin, sep  = ", "))
```

```{r climate change pressure data spatial checks}
library(leaflet)

## check points not assigned to BHI regions...
## first, to speed mapping, identify unique lat/long missing BHI regions
## also reproject to match leaflet epsg:3857 proj??
mapdf <- filter(cc_data_w_rgns, is.na(BHI_ID)) 
mapdf <- sf::st_transform(mapdf, crs = 3857)
data.table::setDT(mapdf)
selectedcols <- c("latitude", "longitude")
mapdf <- mapdf[!duplicated(mapdf, by = selectedcols), selectedcols, with = FALSE]
  
leaflet::leaflet(data = mapdf) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(18, 59, zoom = 5) %>%
  addCircleMarkers(radius = 2) %>% 
  addPolygons(data = bhi_rgn_simple, fillOpacity = 0.1, fill = "grey", weight = 0.5)

## seems like there are many points near north sea or in denmark which are and should be exculded
## but others especially along Finnish coast, where there are lots of islands, should be included...

## going back to assignment fo BHI regions (join_rgns_info) and including the coastal buffer, 
## more points are assigned to BHI regions...
bhibuffer <- st_read(file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"))
cc_data_w_rgns <- join_rgns_info(
  ices_cc_data, helcomID_col = "helcom_id", country_col = "country", 
  latlon_vars = c("latitude", "longitude"), return_spatial = TRUE, 
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"), 
  ## using buffer to assign more of the points, will need still to exclude eg north sea or estuaries...
  buffer_shp = bhibuffer
) 

## keep if not in the buffer zone, or
## if in the buffer zone, keep if not in BHI regions 1, 2, 8, 10
cc_data_w_rgns <- cc_data_w_rgns %>% 
  filter(!in_25km_buffer|(in_25km_buffer & !BHI_ID %in% c(1, 2, 8, 10))) %>% 
  sf::st_drop_geometry() %>% 
  mutate(month = as.numeric(month))
```

```{r climate change pressure datasets maps}
basemap <- ggplot2::ggplot(rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")) +
  geom_sf(size = 0.1, color = "burlywood", alpha = 0.4) +
  theme(panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3")) +
  scale_x_continuous(limit = c(4, 32)) +
  scale_y_continuous(limit = c(53.5, 66)) 

cols <- c("indianred", "coral", "goldenrod1", "khaki", "lightblue", "steelblue")
```

```{r surface salinity data points map, fig.width = 9.5, fig.heigth = 3, results = "show"}
basemap +
  geom_sf(
    data = st_as_sf(cc_data_w_rgns, coords = c("longitude", "latitude"), crs = 4326) %>% 
      filter(year %in% c(1998, 2008, 2018), !is.na(surfsal)),
    mapping = aes(color = surfsal),
    size = 2,
    alpha = 0.2
  ) +
  scale_color_gradientn(
    colors = c("khaki", "lightblue", "steelblue"),
    values = c(0, 0.4, 1)
  ) +
   labs(color = "Salinity") +
  facet_grid(cols = vars(year))
```

```{r sea surface temperatures data points map, fig.width = 9.5, fig.heigth = 3, results = "show"}
basemap +
  geom_sf(
    data = st_as_sf(cc_data_w_rgns, coords = c("longitude", "latitude"), crs = 4326) %>% 
      filter(year %in% c(1998, 2008, 2018), !is.na(temp)),
    mapping = aes(color = temp),
    size = 2,
    alpha = 0.2
  ) +
  scale_color_gradientn(
    colors = c("khaki", "lightblue", "steelblue"),
    values = c(0, 0.4, 1)
  ) +
  labs(color = "SST") +
  facet_grid(cols = vars(year))
```


<br>

### 3.3 Current Conditions {-}

Current conditions if taken from the hindcast data. Each scenario year takes average from the five most recent years (e.g. for 2019 assessment, pressure score is derived from 2015-2019 average, rescaled).

```{r current surface sal and temp ices, results = "show", fig.width = 9.5}
surf_sal_current <- cc_data_w_rgns %>%
  group_by(Subbasin, year) %>% 
  summarize(annual_mean_surfsal = mean(surfsal, na.rm = TRUE)) %>% 
  arrange(Subbasin, year) %>% 
  group_by(Subbasin) %>%
  mutate(
    ma5_surf_sal = zoo::rollapply(annual_mean_surfsal, 5, mean, na.rm = TRUE, align = "right", fill = NA),
    year = as.numeric(year)
  ) %>% 
  rename(basin_name_holas = Subbasin) %>% 
  ungroup() %>% 
  arrange(desc(year))

surf_temp_current <- cc_data_w_rgns %>%
  group_by(Subbasin, year) %>% 
  summarize(annual_mean_temp = mean(temp, na.rm = TRUE)) %>% 
  arrange(Subbasin, year) %>% 
  group_by(Subbasin) %>%
  mutate(
    ma5_surf_temp = zoo::rollapply(annual_mean_temp, 5, mean, na.rm = TRUE, align = "right", fill = NA),
    year = as.numeric(year)
  ) %>% 
  rename(basin_name_holas = Subbasin) %>% 
  ungroup() %>% 
  arrange(desc(year))

## plot timeseries of surface salinity and temp, annual means and 5year moving average
## data for BHI1.0 had ECHAM5 model data, projections; we don't have that here, only have hindcast... 
gridExtra::grid.arrange(
  ggplot(tidyr::pivot_longer(surf_sal_current, cols = c("annual_mean_surfsal", "ma5_surf_sal"))) +
    geom_point(aes(year, value, color = name), alpha = 0.6) +
    facet_wrap(~basin_name_holas, scales = "free_y", ncol = 4) +
    theme(legend.position = c(0.9, 0.1)) +
    scale_x_continuous(breaks = c(1990, 2000, 2010, 2020)) +
    labs(color = "Name", x = NULL, y = "Annual Average Salinity (PSU)"),
   ggplot(tidyr::pivot_longer(surf_temp_current, cols = c("annual_mean_temp", "ma5_surf_temp"))) +
    geom_point(aes(year, value, color = name), alpha = 0.6) +
    facet_wrap(~basin_name_holas, scales = "free_y", ncol = 4) +
    theme(legend.position = c(0.9, 0.1)) +
    scale_x_continuous(breaks = c(1990, 2000, 2010, 2020)) +
    labs(color = "Name", x = NULL, y = "Annual Average Temp (deg C)"),
  nrow = 1
)
```



### 3.4 Maximums and Minimums for Normalizing Salinity and Temperature Averages {-}

**Maximum Annual Salinity**

max value = maximum annual salinity during reference period (1960-1990)  
From hindcast data, extract the maximum annual surface salinity for each basin between 1960-1990

```{r max annual salinity}
## take max from hindcast dataset
## use moving average or annual means??
max_surf_sal <- surf_sal_current %>%
  filter(year %in% 1960:1990) %>%
  select(basin_name_holas, ma5_surf_sal) %>%
  group_by(basin_name_holas) %>%
  summarise(max_surf_sal = max(ma5_surf_sal, na.rm = TRUE)) %>%
  ungroup()
```








### 3.4 Calculate Surface Salinity Pressure Scores {-}

### 3.5 Calculate Sea Surface Temperature Pressure Scores {-}





########################----------------------------------------------------########################




### 4.5 Minimum val
From projection data, extract the minimum annual surface salinity for each basin between 2020-2050. Compare between the two projection data sets. ECHAM5 projects higher salinity than HADCM3, difference greatest between the two in Great Belt, Kattegat, Kiel, The Sound (which are the most variable and most saline).  
```{r min surface sal}

min_surf_sal1 = proj_surf_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_surface)%>%
           group_by(basin_name_holas)%>%
           summarise(min_surf_sal = min(sal_surface))%>%
           ungroup()

min_surf_sal1

min_surf_sal2 = proj2_surf_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_surface)%>%
           group_by(basin_name_holas)%>%
           summarise(min_surf_sal = min(sal_surface))%>%
           ungroup()

min_surf_sal2


## difference between two model estimates

proj_diff = full_join(min_surf_sal1,min_surf_sal2,by="basin_name_holas")%>%
            dplyr::rename(min_echam5 = min_surf_sal.x,
                          min_hadcm3 = min_surf_sal.y)%>%
            mutate(proj_diff = min_echam5 - min_hadcm3)

## plot difference
ggplot(proj_diff)+
    geom_point(aes(basin_name_holas, proj_diff))+
 theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Diff in Projected Min Sal (ECHAM5 - HADCM3)")

```


### 4.6 Maximum surface sal

#### 4.6.1 Take max from hindcast dataset
From hindcast data, extract the maximum annual surface temperature for each basin between 1960-1990
```{r max surf sal from hindcast}
max_surf_sal = hind_surf_sal %>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_surface)%>%
             group_by(basin_name_holas)%>%
             summarise(max_surf_sal = max(sal_surface))%>%
             ungroup()
max_surf_sal
```


#### 4.6.2 Take max from ECHAM5 dataset
From echam5 data, extract the maximum annual surface temperature for each basin between 1960-1990. 
```{r max surf sal from echam 5}
max_surf_sal_echam5 = proj_surf_sal %>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_surface)%>%
             group_by(basin_name_holas)%>%
             summarise(max_surf_sal = max(sal_surface))%>%
             ungroup()
max_surf_sal_echam5
```


#### 4.6.3 Plot max historic value: Compare hindcast and echam5
Relatively similar between time series.  
```{r plot max surface sal condition}
ggplot(bind_rows(
       mutate(max_surf_sal, type = "hindcast"),
       mutate(max_surf_sal_echam5, type = "echam5")))+
  geom_point(aes(basin_name_holas, max_surf_sal, colour=type, shape=type), size=2.5)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Max Surface Salinity 1960-1990, compare time series")


```

### 4.7 Plot min, max, and current
If black dot ("current salinity") is not between the max and min salinity values, using these values to rescale would mean that the pressure is either at its highest (if salinity is lower than the min value) or lowest (if above the max value). Current salinity is not great than the max value.  However, it is often lower than the minimum value.  

#### 4.7.1 Using different datasets
Hindcast for past and current, compare projections for future
```{r plot surf sal min, max, current}
##join data for plot
surf_sal_data = full_join(surf_sal_current,min_surf_sal1, by="basin_name_holas")%>%
             full_join(.,min_surf_sal2, by="basin_name_holas") %>%
            full_join(.,max_surf_sal, by="basin_name_holas") %>%
            dplyr::rename(min_surf_sal_echam5 = min_surf_sal.x,
                          min_surf_sal_hadcm3 = min_surf_sal.y)%>%
              gather(sal_type, salinity, -basin_name_holas)
  

ggplot(surf_sal_data)+
  geom_point(aes(basin_name_holas,salinity, colour = sal_type, shape=sal_type), size=2)+
  scale_shape_manual(values=c(19,19,19,17))+
  scale_colour_manual(values = c("black","red","light blue","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Basin Annual Surface Sal Min, Current, Max")

ggplot(surf_sal_data)+
  geom_point(aes(sal_type,salinity, colour = sal_type, shape=sal_type), size=2)+
  facet_wrap(~basin_name_holas, scales = "free_y")+
  scale_shape_manual(values=c(19,19,19,17))+
  scale_colour_manual(values = c("black","red","light blue","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("Basin Annual Surface Sal Min, Current, Max")

```

#### 4.7.2 Using only ECHAM5
```{r plot echam 5 all components}
max_surf_sal_echam5  = max_surf_sal_echam5 %>%
                       dplyr::rename(salinity =max_surf_sal) %>%
                        mutate(type = "max")
min_surf_sal1 = min_surf_sal1 %>%
                dplyr::rename(salinity =min_surf_sal) %>%
                        mutate(type = "min")
surf_sal_current_echam5  =surf_sal_current_echam5 %>%
                          dplyr::rename(salinity =current_surf_sal) %>%
                        mutate(type = "current")

surf_sal_data_echam5 = bind_rows(max_surf_sal_echam5,
                                 min_surf_sal1,
                                 surf_sal_current_echam5)

ggplot(surf_sal_data_echam5)+
  geom_point(aes(basin_name_holas,salinity, colour = type, shape=type), size=2)+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("ECHAM5 Basin Annual Surface Sal Min, Current, Max")


  ggplot(surf_sal_data_echam5)+
  geom_point(aes(type,salinity, colour =type, shape=type), size=2)+
  facet_wrap(~basin_name_holas, scales = "free_y")+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("ECHAM5 Basin Annual Surface Sal Min, Current, Max")

```

**It is clear that using only a single dataset produces a much better result** 




### 4.8 Rescale data for pressure layer
**Use data from ECHAM5**  
1. Normalize data  
3. Take inverse so greater pressure with fresher conditions  

```{r rescale to min and max surf sal}
 surf_sal_rescale =surf_sal_data_echam5 %>%
                    spread(type,salinity)%>%
               mutate(surf_sal_normalize = (current - min) / (max - min),
                      surf_sal_rescale_inv = 1- surf_sal_normalize)
                      ## take inverse 

 surf_sal_rescale
```

#### 4.8.1 Plot Surface pressure layer by basin 

```{r plot surface pressure layers by basin}
ggplot(surf_sal_rescale)+
  geom_point(aes(basin_name_holas,surf_sal_rescale_inv),size=2.5)+
  ylim(0,1)+
  ylab("Pressure value")+
  xlab("Basin")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                  hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Surface salinity pressure layer")



```




### 4.9 Assign basin values to BHI regions

#### 4.9.1 Read in lookup for BHI regions
```{r read in bhi lookup}
bhi_holas_lookup = read.csv(file.path(dir_cc, 'bhi_basin_country_lookup.csv'), sep=";")%>%
                   select(BHI_ID, Subbasin)%>%
                   dplyr::rename(rgn_id = BHI_ID, 
                                 basin_name= Subbasin)
             

```

#### 4.9.2 join lookup for BHI regions to sst_rescale
```{r join bhi regions to  surf_sal_rescale}
 surf_sal_rescale1 = surf_sal_rescale %>%
              full_join(., bhi_holas_lookup, by=c("basin_name_holas" = "basin_name"))%>%
              select(rgn_id,surf_sal_rescale_inv)%>%
              dplyr::rename(pressure_score = surf_sal_rescale_inv)%>%
              arrange(rgn_id)


```

#### 4.9.3 Plot rescaled surface salinity by BHI ID
```{r plot surface salinity pressure by bhi id}
ggplot(surf_sal_rescale1)+
  geom_point(aes(rgn_id,pressure_score), size=2.5)+
   ggtitle("Surface Salinity pressure data layer")

```

### 4.10 Write surface salinity to layers 
```{r write surface sal to layers}
write.csv(surf_sal_rescale1, file.path(dir_layers, 'cc_sal_surf_bhi2015.csv' ), row.names=FALSE)

```



## 5 Prepare Deep salinity Data layer

### 5.1 Read in deep salinity data
```{r read deep sal in data}
## read in data

hind_deep_sal = read.csv(file.path(dir_salincc, 'sal_data_database/hind_sal_deep.csv'))

proj_deep_sal = read.csv(file.path(dir_salincc,'sal_data_database/proj_sal_deep.csv')) #echam5

proj2_deep_sal = read.csv(file.path(dir_salincc,'sal_data_database/proj2_sal_deep.csv')) #hadcm3
```

### 5.2 Clean data
```{r clean deep sal data}
## remove where year is NA - these are for basins from baltsem not used
hind_deep_sal %>% filter(is.na(year))

hind_deep_sal = hind_deep_sal %>%
           filter(!is.na(year))


proj_deep_sal %>% filter(is.na(year))

proj_deep_sal = proj_deep_sal %>%
           filter(!is.na(year))


proj2_deep_sal %>% filter(is.na(year))

proj2_deep_sal = proj2_deep_sal %>%
           filter(!is.na(year))
```


### 5.3 Plot data
```{r plot deep sal data}
ggplot(hind_deep_sal)+
  geom_line(aes(year,sal_deep, colour=factor(salin_bottom_depth))) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Hindcast Annual Deep Salinity time series")

ggplot(proj_deep_sal)+
  geom_line(aes(year,sal_deep,colour=factor(salin_bottom_depth))) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Projected A1b Annual Deep Salinity time series ECHAM5")

ggplot(proj2_deep_sal)+
  geom_line(aes(year,sal_deep,colour=factor(salin_bottom_depth))) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Projected A1b Annual Deep Salinity time series HADCM3")


### bind data together and plot in single plot
sal_deep_plot = bind_rows(
                mutate(hind_deep_sal, sim_name = "hindcast"),
                mutate(proj_deep_sal, sim_name = "echam5"),
                mutate(proj2_deep_sal, sim_name = "hadcm3")) %>%
                arrange(basin_name_holas,sim_name,year)

ggplot(sal_deep_plot)+
  geom_line(aes(year,sal_deep, colour = sim_name)) + 
  facet_wrap(~basin_name_holas, scales="free_y")+
  xlim(1950,2100)+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("All Annual Deep Salinity time series")



## Plot the depth for the deep data
ggplot(filter(sal_deep_plot, sim_name=="echam5"))+
  geom_point(aes(basin_name_holas,salin_bottom_depth),size=2.5) + 
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Depth from which Deep salinity value taken")


```


### 5.4 Current conditions 2010-2014

#### 5.4.1 Using hindcast data
Five most recent years

```{r current deep sal }
max_year = hind_deep_sal %>%
           select(year)%>%
           max()%>%
           as.numeric()

deep_sal_current = hind_deep_sal %>%
              filter(year >= (max_year-4))%>%
              select(basin_name_holas,sal_deep)%>%
              group_by(basin_name_holas)%>%
              summarise(current_deep_sal = mean(sal_deep))%>%
              ungroup()
              

deep_sal_current

```

#### 5.4.2 Using ECHAM5 data
Five most recent years

```{r current deep sal echam 5 }
year_range = seq(2010,2014)

deep_sal_current_echam5 = proj_deep_sal %>%
              filter(year %in% year_range)%>%
              select(basin_name_holas,sal_deep)%>%
              group_by(basin_name_holas)%>%
              summarise(current_deep_sal = mean(sal_deep))%>%
              ungroup()
              

deep_sal_current_echam5

```


### 5.5.1 Plot Current condition
```{r plot current deep sal condition}
ggplot(bind_rows(
       mutate(deep_sal_current, type = "hindcast"),
       mutate(deep_sal_current_echam5, type = "echam5")))+
  geom_point(aes(basin_name_holas, current_deep_sal, colour=type, shape=type), size=2.5)+
   theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Mean Deep Salinity 2010-2014, compare time series")

```



### 5.5 Minimum val
From projection data, extract the minimum annual deep salinity for each basin between 2020-2050. Compare the two projections. Direction of difference and magnitude is different among basins.
```{r min deep sal}

min_deep_sal1 = proj_deep_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_deep)%>%
           group_by(basin_name_holas)%>%
           summarise(min_deep_sal = min(sal_deep))%>%
           ungroup()

min_deep_sal1




min_deep_sal2 = proj2_deep_sal %>%
           filter(year >= 2020 & year <= 2050)%>%
           select(basin_name_holas,sal_deep)%>%
           group_by(basin_name_holas)%>%
           summarise(min_deep_sal = min(sal_deep))%>%
           ungroup()

min_deep_sal2


## difference between two model estimates

proj_diff_deep = full_join(min_deep_sal1,min_deep_sal2,by="basin_name_holas")%>%
            dplyr::rename(min_echam5 = min_deep_sal.x,
                          min_hadcm3 = min_deep_sal.y)%>%
            mutate(proj_diff = min_echam5 - min_hadcm3)

## plot difference
ggplot(proj_diff_deep)+
    geom_point(aes(basin_name_holas, proj_diff))+
    geom_hline(yintercept = 0)+
 theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Difference in Deep Min Val between Projection datasets (ECHAM5 - HADCM3")

```


### 5.6 Maximum deep sal

#### 5.6.1 Using the Hindcast data
From hindcast data, extract the maximum annual deep temperature for each basin between 1960-1990
```{r max deep sal hindcast}
max_deep_sal = hind_deep_sal %>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_deep)%>%
             group_by(basin_name_holas)%>%
             summarise(max_deep_sal = max(sal_deep))%>%
             ungroup()
max_deep_sal
```

#### 5.6.2 Using the ECHAM 5 data
```{r max deep sal echam5}
max_deep_sal_echam5 = proj_deep_sal%>%
             filter(year >= 1960 & year <= 1990)%>%
             select(basin_name_holas,sal_deep)%>%
             group_by(basin_name_holas)%>%
             summarise(max_deep_sal = max(sal_deep))%>%
             ungroup()
max_deep_sal_echam5
```

### 5.7 Plot min, max, and current

#### 5.7.1 Using different datasets
Hindcast for max and current, and different projections compared for future
```{r plot deep min, max, current}
##join data for plot
deep_sal_data = full_join(deep_sal_current,min_deep_sal1, by="basin_name_holas")%>%
             full_join(.,min_deep_sal2, by="basin_name_holas") %>%
            full_join(.,max_deep_sal, by="basin_name_holas") %>%
            dplyr::rename(min_deep_sal_echam5 = min_deep_sal.x,
                          min_deep_sal_hadcm3 = min_deep_sal.y)%>%
              gather(sal_type, salinity, -basin_name_holas)
  

ggplot(deep_sal_data)+
  geom_point(aes(basin_name_holas,salinity, colour = sal_type, shape=sal_type), size=2)+
  scale_shape_manual(values=c(19,19,19,17))+
  scale_colour_manual(values = c("black","red","light blue","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Basin Annual Deep Sal Min, Current, Max")

```

#### 5.7.2 Using only the ECHAM 5 dataset
```{r plot deep echam 5 all components}
max_deep_sal_echam5  = max_deep_sal_echam5 %>%
                       dplyr::rename(salinity =max_deep_sal) %>%
                        mutate(type = "max")
min_deep_sal1 = min_deep_sal1 %>%
                dplyr::rename(salinity =min_deep_sal) %>%
                        mutate(type = "min")
deep_sal_current_echam5  =deep_sal_current_echam5 %>%
                          dplyr::rename(salinity =current_deep_sal) %>%
                        mutate(type = "current")

deep_sal_data_echam5 = bind_rows(max_deep_sal_echam5,
                                 min_deep_sal1,
                                 deep_sal_current_echam5)

ggplot(deep_sal_data_echam5)+
  geom_point(aes(basin_name_holas,salinity, colour = type, shape=type), size=2)+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("ECHAM5 Basin Annual Deep Sal Min, Current, Max")


  ggplot(deep_sal_data_echam5)+
  geom_point(aes(type,salinity, colour =type, shape=type), size=2)+
  facet_wrap(~basin_name_holas, scales = "free_y")+
  scale_shape_manual(values=c(19,19,17))+
  scale_colour_manual(values = c("black","red","blue"))+
    theme(axis.text.x = element_text(colour="grey20", size=6, angle=90, 
                                    hjust=.5, vjust=.5, face = "plain"),
          strip.text.x = element_text(size = 6))+
  ggtitle("ECHAM5 Basin Annual Deep Sal Min, Current, Max")

```

**It is clear that using only a single dataset produces a much better result** 


### 5.8 Rescale data for pressure layer
**Use data from ECHAM5**  
1. Normalize data  
3. Take inverse so greater pressure with fresher conditions  

```{r rescale to min and max deep sal}
 deep_sal_rescale = deep_sal_data_echam5 %>%
                    spread(type,salinity)%>%
                    mutate(deep_sal_normalize = (current - min) / (max - min),
                      deep_sal_rescale_inv = 1- deep_sal_normalize) ## take inverse 

 deep_sal_rescale
```

#### 4.8.1 Plot Deep pressure layer by basin 

```{r plot deep pressure layers by basin}
ggplot(deep_sal_rescale)+
  geom_point(aes(basin_name_holas,deep_sal_rescale_inv),size=2.5)+
  ylim(0,1)+
  ylab("Pressure value")+
  xlab("Basin")+
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                  hjust=.5, vjust=.5, face = "plain"))+
  ggtitle("Deep salinity pressure layer")



```
### 5.9 Assign basin values to BHI regions

#### 5.9.1 Read in lookup for BHI regions
Done above in 4.9.1  

#### 5.9.2 join lookup for BHI regions to sst_rescale
```{r join bhi regions to  deep_sal_rescale}
 deep_sal_rescale1 = deep_sal_rescale %>%
              full_join(., bhi_holas_lookup, by=c("basin_name_holas" = "basin_name"))%>%
              select(rgn_id,deep_sal_rescale_inv)%>%
              dplyr::rename(pressure_score = deep_sal_rescale_inv)%>%
              arrange(rgn_id)

```

#### 5.9.3 Plot rescaled deep salinity by BHI ID
```{r plot deep salinity pressure by bhi id}
ggplot(deep_sal_rescale1)+
  geom_point(aes(rgn_id,pressure_score), size=2.5)+
   ggtitle("Deep Salinity pressure data layer")

```

### 5.10 Write deep salinity to layers 
```{r write deep sal to layers}
write.csv(deep_sal_rescale1, file.path(dir_layers, 'cc_sal_deep_bhi2015.csv' ), row.names=FALSE)

```
