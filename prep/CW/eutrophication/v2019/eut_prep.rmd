---
title: "Clean Water (CW) - Eutrophication (EUT) Subgoal Data Preparation"
output:
  html_document:
    toc: true
    toc_depth: 3
    code_folding: hide
---

<br>

```{r preamble prep including spatial functions and files, message = FALSE, warning = FALSE, include = FALSE}
loc <- here::here("prep", "CW", "eutrophication")

source(here::here("R", "setup.R"))
knitr::opts_chunk$set(message = FALSE, warning = FALSE, results = "hide", fig.width = 9.5)

bkgd_path <- here::here("supplement", "goal_summaries", "EUT.Rmd")
data_path <- here::here("data", "CW", "eutrophication", version_year, "eut_data.rmd")
refs_path <- file.path(loc, "eut_references.Rmd")

dir_lookup <- file.path(dir_prep, "supplement", "lookup_tabs")
basin_lookup_table <-  read.csv(file.path(dir_lookup, "bhi_basin_country_lookup.csv"), sep=";")
basin_lookup <- basin_lookup_table %>% 
  select(bhi_id = BHI_ID, subbasin = Subbasin, rgn_nam, HELCOM_ID, rgn_key) %>% 
  mutate(subbasin = as.character(subbasin),
         rgn_nam = as.character(rgn_nam))

source(here::here("R", "data.R"))
dir_B <- file.path(dirname(dir_prep), "bhi-data", "BHI 2.0")
dir_rawdata <- file.path(dir_B, "Goals", "CW", "EUT")

source(here::here("R", "spatial.R"))
regions_shape()
buffer_sf <- st_read(
  file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"), 
  "BHI_shapefile_25km_buffer"
)
bhi_rgns_simple <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% sf::st_as_sf()
fullpal <- c(
  RColorBrewer::brewer.pal(8, "Dark2"),
  RColorBrewer::brewer.pal(9, "Set1")
)
statuspal <- colorRampPalette(fullpal)(42)[sample(1:42, size = 18)]
```

## 1. Background

```{r Background, child = bkgd_path, results = "asis", echo = FALSE}
```

<br/>

## 2. Data

This prep document is used to generate and explore the following data layers:

- `cw_eut_status_bhi2019.csv` 
- `cw_eut_trend_bhi2019.csv` 

These are saved to the `layers/v2019` folder. Saved to `data/GOAL/v2019/intermediate` are intermediate datasets: `secchi_merged_rawdata.csv`, `ox_merged_rawdata.csv` and `DATASETINTEMED3.csv`. All these are derived from or informed by the raw datasets from ICES, SMHI and Baltic Nest database.

<br>

<!-- ## 2. Data --- header in the child  document -->
```{r Data, child = data_path, results = "asis", echo = FALSE}
```

<br/>

## 3. Prep: Wrangling & Derivations, Checks/Evaluation, Gapfilling

```{r load datasets, echo = FALSE, include = FALSE}
combined_secchi_rawdata <- read_csv(file.path(dirname(data_path), "intermediate", "secchi_merged_rawdata.csv"))
combined_ox_rawdata <- read_csv(file.path(dirname(data_path), "intermediate", "ox_merged_rawdata.csv"))
chla_rawdata <- read_csv(file.path(dirname(data_path), "intermediate", "chla_rawdata.csv"))
eut_thresholds_values <- read.delim(file.path(dir_rawdata, "eut_threshold_values.csv"), sep = ";")

eut_thresholds <- eut_thresholds_values %>% 
  rename(basin = Assessment.units, winter_DIN = DIN.._mol.l.1., winter_DIP = DIP.._mol.l.1., 
         summer_chla = Chla.._g.l.1., summer_secchi = Water.clarity..m., oxyg_debt = O2..mg.l.1.) %>% 
  select(basin, winter_DIN, winter_DIP, summer_chla, summer_secchi, oxyg_debt) %>% 
  mutate(basin = str_replace_all(basin,"_",""),
         basin = str_trim(basin, side = "right"),
         ## ‘N’ means that the indicator is not applicable there, so it will be replaced as NA
         oxyg_debt = str_replace(oxyg_debt, "N", " "),
         oxyg_debt = as.numeric(oxyg_debt)) 
```

### 3.1 Secchi Indicator

#### 3.1.1 Match BHI regions

```{r assign BHI regions to Secchi data, echo = TRUE, message = FALSE, warning = FALSE}
# before assigning bhi basins to secchi data, run this function first:
regions_shape(sp_dir = file.path(dirname(dir_B), "Shapefiles"))
 
# assign bhi basins to secchi data 
secchi_rgns_shp <- join_rgns_info(
  combined_secchi_rawdata, helcomID_col = "helcom_id", country_col = "country", 
                           latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
                           rgn_shps_loc = file.path(dirname(dir_B), "Shapefile"), buffer_shp = NULL) %>% 
  # select summer months (June-September) and Years >= 2000  
  filter(month == "06" | month == "07" | month == "08" | month == "09") %>% 
  filter(year >=2000) %>% 
  rename(country = rgn_nam,
         ctry_key = rgn_key,
         subbasin = Subbasin,
         helcom_id = HELCOM_ID,
         bhi_id = BHI_ID,
         ices_area = ICES_area)

##secchi_rgns_shp <- join_rgns_info(
  ##secchi, helcomID_col = "helcom_id", country_col = "country", 
    ##                       latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
      ##                     regions_shape(sp_dir = file.path(dirname(dir_B), "Shapefiles")), buffer_shp = NULL)

```

**Spatial Visualization of Secchi data**
```{r secchi timeseries yearly and monthly by bhi regions and subbasins, results = "show", echo = TRUE, fig.width = 9.5}
# Plot by bhi regions
ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m, color = supplier), size = 0.3, alpha = 0.4) +
  facet_grid(cols = vars(country), rows = vars(bhi_id)) +
  labs(x = "Year", y = "Secchi depth (m)") +
  ggtitle("Yearly Secchi by bhi regions")

ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~bhi_id, scales ="free_y") +
    labs(x = "Year", y = "Secchi depth (m)") +
  ggtitle("Yearly Secchi by bhi regions")

ggplot(secchi_rgns_shp) + 
  geom_point(aes(month, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~bhi_id, scales ="free_y") +
    labs(x = "Month", y = "Secchi depth (m)") +
  ggtitle("Monthly Secchi by bhi regions")

# Plot by subbasins
ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m), size = 0.3, alpha = 0.4) +
  facet_grid(cols = vars(subbasin), rows = vars(country)) +
    labs(x = "Year", y = "Secchi depth (m)") +
  ggtitle("Yearly Secchi by Subbasins")

ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~subbasin, scales ="free_y") +
    labs(x = "Year", y = "Secchi depth (m)") +
  ggtitle("Yearly Secchi by Subbasins")

ggplot(secchi_rgns_shp) + 
  geom_point(aes(month, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~subbasin, scales ="free_y") +
    labs(x = "Month", y = "Secchi depth (m)") +
  ggtitle("Montly Secchi by Subbasins")

```

<br/>

#### 3.1.2 Mean secchi Calculation

```{r calculate monthly mean secchi by subbasins, results = "show", echo = TRUE, fig.width = 9.5}
# Calculate mean monthly value for each summer month (subbasin)
secchi_subbasin_mean_months <- secchi_rgns_shp %>% 
  dplyr::select(year, month, subbasin, secchi_m)%>%
  group_by(year, month, subbasin) %>%
  summarise(mean_secchi = round(mean(secchi_m, na.rm=TRUE), 1)) %>%
  ungroup()

# Calculate summer mean secchi (subbasin)
secchi_subbasin_mean_months_summer <- secchi_subbasin_mean_months %>% 
  dplyr::select(year, subbasin, mean_secchi) %>%
  group_by(year, subbasin) %>%
  summarise(mean_secchi = round(mean(mean_secchi,na.rm=TRUE),1)) %>%
  filter(!is.na(subbasin)) %>% 
  ungroup()  #in mean calculation all some months to have NA, ignore for that years calculation

```


```{r calculate monthly mean secchi by bhi regions, results = "show", echo = TRUE, fig.width = 9.5}
# Calculate mean monthly value for each summer month (bhi basins)
secchi_bhi_mean_months <- secchi_rgns_shp %>% 
  dplyr::select(year, month, bhi_id, secchi_m)%>%
  group_by(year, month, bhi_id) %>%
  summarise(mean_secchi = round(mean(secchi_m, na.rm=TRUE), 1)) %>%
  ungroup()

secchi_bhi_mean_months_summer <- secchi_bhi_mean_months %>% 
  dplyr::select(year, bhi_id, mean_secchi) %>%
  group_by(year, bhi_id) %>%
  summarise(mean_secchi = round(mean(mean_secchi,na.rm=TRUE),1)) %>%
  ungroup()  #in mean calculation all some months to have NA, ignore for that years calculation

# Plot summer mean secchi
ggplot(secchi_bhi_mean_months_summer) + 
  geom_point(aes(year, mean_secchi)) +
  geom_line(aes(year, mean_secchi)) +
  facet_wrap(~bhi_id)+
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Summer Secchi by bhi regions")

## There might be some outlier to check (TO-DO)
```
<br/>

**Plot summer secchi with target values indicated**
Horizontal lines are HELCOM target values 
```{r summer secchi with target, results = "show", echo = TRUE, fig.width = 9.5}
target_secchi <- eut_thresholds %>% 
  select(subbasin = basin, target_secchi = summer_secchi)

subbasin_target_secchi <- left_join(secchi_subbasin_mean_months_summer, target_secchi, by = "subbasin")

ggplot(subbasin_target_secchi) + 
  geom_point(aes(year, mean_secchi)) +
  geom_line(aes(year, mean_secchi)) +
  geom_line(aes(year, target_secchi), colour = "red") +
  facet_wrap(~subbasin)+
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Summer Secchi against Targe values")

all_target_secchi <- left_join(secchi_rgns_shp, target_secchi, by = "subbasin")

```
<br/>

#### 3.1.3 Status Calculation

**Explore status years**

All basins have data for 2019, which will be used as the status year, except for seven basins (2018): 
Aland Sea, Bay of Mecklenburg, Gdansk Basin, Great Belt, Gulf of Finland, Gulf of Riga, and Kiel Bay
For these seven basins, their most recent year's data is used for current status calculations
```{r what is the last year, results = "hide"}

## get the last year of non-NA data
secchi_last_year = subbasin_target_secchi %>%
  filter(!is.na(mean_secchi))%>%
  group_by(subbasin)%>%
  summarise(last_year = last(year)) %>%
  print(n=15)

##which are not in 2013
secchi_last_year %>% filter(last_year < 2019)

```

**Status calculation with raw (non-modeled) mean summer secchi by basin** 

Status must be calculated in data prep because it's calculated on the basin level and then applied to all regions
```{r Status calculation, results = "show", echo = TRUE, fig.width = 9.5}

## Define constants for status calculation
min_year = 2010        # earliest year to use as a start for regr_length timeseries
##data already filtered for 
regr_length = 10       # number of years to use for regression
future_year = 5        # the year at which we want the likely future status
min_regr_length = 5    # min actual number of years with data to use for regression.

## Basin data with target
subbasin_target_secchi

## Calculate basin status = basin_mean/basin_target
secchi_subbasin_status <- subbasin_target_secchi %>%
  mutate(., status =  pmin(1, mean_secchi/target_secchi)) %>%
  left_join(basin_lookup, by = "subbasin") %>% 
  mutate(region = paste(subbasin, rgn_nam, sep = ", "))

## Assign basin status to BHI regions
secchi_bhi_status <- secchi_subbasin_status %>%
  group_by(subbasin) %>%
  filter(year == max(year)) %>% #select last year of data for status in each basin (this means status year differs by basin)
  mutate(status = round(status*100)) %>% #status is whole number 0-100
  mutate(dimension = 'status',
         indicator = "secchi") %>% 
  dplyr::select(Subbasin = subbasin, BHI_ID = bhi_id, dimension, score=status, region, indicator)

# Plot the status (by subbasin)
ggplot(secchi_subbasin_status, aes(region, status, fill = subbasin)) +
  geom_col(position = position_dodge(), color = "grey", alpha = 0.7, show.legend = FALSE) + 
  coord_flip() +
  labs(x = NULL, y = NULL) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7)) +
    ggtitle("Secchi Status by subbasins")

# Plot the status (by bhi regions)
ggplot(secchi_bhi_status, aes(region, score, fill = BHI_ID)) +
  geom_col(position = position_dodge(), color = "grey", alpha = 0.7, show.legend = FALSE) + 
  coord_flip() +
  labs(x = NULL, y = NULL) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7)) +
      ggtitle("Secchi Status by bhi regions")
```

#### 3.1.4 Calculate Trend 

**METHOD 1**
```{r trend calculation}
## Calculate basin trend
secchi_subbasin_trend1 <- secchi_subbasin_status %>%
  group_by(subbasin) %>%
  do(tail(. , n = regr_length)) %>%  # calculate trend only if there is at least X years of data (min_regr_length) in the last Y years of time serie (regr_length)
  do({if(sum(!is.na(.$status)) >= min_regr_length)
    data.frame(trend_score = 
                 max(-1, min(1, coef(lm(status ~ year, .))['year'] * future_year)))
    else data.frame(trend_score = NA)}) %>%
  ungroup() 

## Assign basin trend to BHI regions
secchi_bhi_trend1 <- left_join(basin_lookup, secchi_subbasin_trend1, by = "subbasin") %>%
  mutate(score = round(trend_score, 2),
         dimension = "trend",
         region = paste(subbasin, rgn_nam, sep = ", ")) %>%
  dplyr::select(bhi_id, dimension, score, region, subbasin)
```

**METHOD 2 (Ellie)**
```{r trend calculation}
## Calculate basin trend
trendyrs <- min_year:(min_year + regr_length)

secchi_lm_estim <- secchi_rgns_shp %>% 
  filter(year %in% trendyrs) %>% 
  group_by(subbasin) %>% 
  mutate(
    trendcalc_nyrs = n_distinct(year),
    num_obs = n()
  ) %>% 
  ## how much data is enough data to calculate short-term trends?
  do(trend_mdl = lm(secchi_m ~ year, data = .)) %>%
  mutate(
    projected = predict(trend_mdl, data.frame(year = max(trendyrs) + future_year)),
    current_estimated = predict(trend_mdl, data.frame(year = max(trendyrs))),
    trend_score = (projected-current_estimated)/current_estimated
  )

# filter(trendcalc_nyrs >= 6|(trendcalc_nyrs >= 4 & num_obs > 8)) %>% 
subbasin_trend_secchi2 <- secchi_lm_estim %>% 
  ungroup() %>% 
  select(-trend_mdl) %>% 
  group_by(subbasin) %>% 
  summarize(trend = mean(trend_score, na.rm = TRUE) %>% round(3)) %>%
  ## constrain trend values between one and negative one
  mutate(trend = ifelse(-1 <= trend & trend <= 1, trend, trend*abs(1/trend)))

## Assign basin trend to BHI regions
secchi_bhi_trend2 <- left_join(basin_lookup, subbasin_trend_secchi2, by = "subbasin") %>%
  mutate(score = round(trend, 2),
         dimension = "trend",
         indicator = "secchi") %>%
  dplyr::select(Subbasin = subbasin, BHI_ID = bhi_id, dimension, score, indicator)
```

#### 3.1.5 Plot Status and Trend

**Plot basin status**
Basin status is initially a value between 0 - 1.  Calculated for each year between 2000 and 2020.  
```{r plot basin status, results = "show", echo = TRUE, fig.width = 9.5}
ggplot(secchi_subbasin_status) + 
  geom_point((aes(year, status))) +
  facet_wrap(~subbasin) +
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                   hjust=.5, vjust=.5, face = "plain"))

```

**Plot BHI region status and trend values**

Status values can range from 0-100 -- this is the status for the *most recent* year. In most cases this is 2019. No status or trend for 5 or 6 - these are The Sound, which had no data. 
```{r bhi status and trend plot, results = "show", echo = TRUE, fig.width = 9.5}
## Method 1
# secchi_bhi_status <- as.data.frame(secchi_bhi_status)
ggplot(rbind(secchi_bhi_status, secchi_bhi_trend1)) + 
  geom_point(aes(bhi_id, score),size=2)+
  facet_wrap(~dimension, scales="free_y")+
  xlab("BHI region")

## Method 2
ggplot(rbind(secchi_bhi_status, secchi_bhi_trend2)) + 
  geom_point(aes(bhi_id, score),size=2)+
  facet_wrap(~dimension, scales="free_y")+
  xlab("BHI region")
```

### 3.2 Chl a Indicator

#### 3.2.1 Match BHI regions

```{r assign BHI regions to Secchi data, echo = TRUE, message = FALSE, warning = FALSE}
# before assigning bhi basins to secchi data, run this function first:
regions_shape(sp_dir = file.path(dirname(dir_B), "Shapefiles"))
 
# assign bhi basins to secchi data 
chla_rgns_shp <- join_rgns_info(
  chla_rawdata, helcomID_col = "helcom_id", country_col = "country", 
                           latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
                           rgn_shps_loc = file.path(dirname(dir_B), "Shapefile"), buffer_shp = NULL) %>% 
  # select summer months (June-September) and Years >= 2000  
  filter(month == "06" | month == "07" | month == "08" | month == "09") %>% 
  filter(year >=2000) %>% 
  rename(country = rgn_nam,
         ctry_key = rgn_key,
         subbasin = Subbasin,
         helcom_id = HELCOM_ID,
         bhi_id = BHI_ID,
         ices_area = ICES_area)

##chla_rgns_shp <- join_rgns_info(
  ##chla_rawdata, helcomID_col = "helcom_id", country_col = "country", 
    ##                       latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
      ##                     regions_shape(sp_dir = file.path(dirname(dir_B), "Shapefiles")), buffer_shp = NULL)

```

**Spatial Visualization of Chl a data**
```{r chl a timeseries yearly and monthly by bhi regions and subbasins, results = "show", echo = TRUE, fig.width = 9.5}
# Plot by bhi regions
ggplot(chla_rgns_shp) + 
  geom_point(aes(year, chla_ug_l), size = 0.3, alpha = 0.4) +
  facet_grid(cols = vars(country), rows = vars(bhi_id)) +
  labs(x = "Year", y = "Chl a (ug/L)") +
  ggtitle("Yearly Chl a by bhi regions")

ggplot(chla_rgns_shp) + 
  geom_point(aes(year, chla_ug_l, colour = country), size = 0.3, alpha = 0.4) +
  facet_wrap(~bhi_id, scales ="free_y") +
  labs(x = "Year", y = "Chl a (ug/L)") +
  ggtitle("Yearly Chl a by bhi regions")

ggplot(chla_rgns_shp) + 
  geom_point(aes(month, chla_ug_l, colour = country), size = 0.3, alpha = 0.4) +
  facet_wrap(~bhi_id, scales ="free_y") +
  labs(x = "Month", y = "Chl a (ug/L)") +
  ggtitle("Monthly Chl a by bhi regions")

# Plot by subbasins
ggplot(chla_rgns_shp) + 
  geom_point(aes(year, chla_ug_l), size = 0.3, alpha = 0.4) +
  facet_grid(cols = vars(subbasin), rows = vars(country)) +
  labs(x = "Year", y = "Chl a (ug/L)") +
  ggtitle("Yearly Chl a by subbasins")

ggplot(chla_rgns_shp) + 
  geom_point(aes(year, chla_ug_l, colour = country), size = 0.3, alpha = 0.4) +
  facet_wrap(~subbasin, scales ="free_y") +
  labs(x = "Year", y = "Chl a (ug/L)") +
  ggtitle("Yearly Chl a by subbasins")

ggplot(chla_rgns_shp) + 
  geom_point(aes(month, chla_ug_l, colour = country), size = 0.3, alpha = 0.4) +
  facet_wrap(~subbasin, scales ="free_y") +
  labs(x = "Month", y = "Chl a (ug/L)") +
  ggtitle("Monthly Chl a by subbasins")

```

<br/>

#### 3.2.2 Mean Chl a Calculation

```{r calculate monthly and summer mean chl a by subbasins}
# Calculate mean monthly value for each summer month (subbasin)
chla_subbasin_mean_months <- chla_rgns_shp %>% 
  dplyr::select(year, month, subbasin, chla_ug_l)%>%
  group_by(year, month, subbasin) %>%
  summarise(mean_chla = round(mean(chla_ug_l, na.rm=TRUE), 1)) %>%
  ungroup()

# Calculate summer mean chl a (subbasin)
chla_subbasin_mean_months_summer <- chla_subbasin_mean_months %>% 
  dplyr::select(year, subbasin, mean_chla) %>%
  group_by(year, subbasin) %>%
  summarise(mean_chla = round(mean(mean_chla, na.rm=TRUE), 1)) %>%
  filter(!is.na(subbasin)) %>% 
  ungroup()  #in mean calculation all some months to have NA, ignore for that years calculation

```


```{r calculate monthly mean chl a by bhi regions, results = "show", echo = TRUE, fig.width = 9.5}
# Calculate mean monthly value for each summer month (bhi basins)
chla_bhi_mean_months <- chla_rgns_shp %>% 
  dplyr::select(year, month, bhi_id, chla_ug_l)%>%
  group_by(year, month, bhi_id) %>%
  summarise(mean_chla = round(mean(chla_ug_l, na.rm=TRUE), 1)) %>%
  ungroup()

# Calculate summer mean chl a (bhi basins)
chla_bhi_mean_months_summer <- chla_bhi_mean_months %>% 
  dplyr::select(year, bhi_id, mean_chla) %>%
  group_by(year, bhi_id) %>%
  summarise(mean_chla = round(mean(mean_chla, na.rm=TRUE), 1)) %>%
  ungroup()  #in mean calculation all some months to have NA, ignore for that years calculation

# Plot summer mean secchi
ggplot(chla_bhi_mean_months_summer) + 
  geom_point(aes(year, mean_chla)) +
  geom_line(aes(year, mean_chla)) +
  facet_wrap(~bhi_id)+
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Summer Chl a")

## There might be some outlier to check (TO-DO)
```

<br/>

**Plot summer secchi with target values indicated**
Horizontal lines are HELCOM target values 
```{r summer chl a with target, results = "show", echo = TRUE, fig.width = 9.5}
target_chla <- eut_thresholds %>% 
  select(subbasin = basin, target_chla = summer_chla)

subbasin_target_chla <- left_join(chla_subbasin_mean_months_summer, target_chla, by = "subbasin")

ggplot(subbasin_target_chla) + 
  geom_point(aes(year, mean_chla)) +
  geom_line(aes(year, target_chla), colour = "red") +
  facet_wrap(~subbasin)+
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Summer Chl a against Targe values")

```
<br/>

#### 3.2.3 Status Calculation

**Explore status years**

All basins have data for 2018, which will be used as the status year, except for five basins: 
Aland Sea (2017), Bay of Mecklenburg (2010), Great Belt (2014), Kiel Bay (2010), and The Quark (2013).
For these five basins, their most recent year's data is used for current status calculations
```{r what is the last year, results = "hide"}

## get the last year of non-NA data
chla_last_year <- subbasin_target_chla %>%
  filter(!is.na(mean_chla))%>%
  group_by(subbasin)%>%
  summarise(last_year = last(year)) %>%
  print(n=15)

##which are not in 2013
chla_last_year %>% filter(last_year < 2018)

```

**Status calculation with raw (non-modeled) mean summer chla by basin** 

Status must be calculated in data prep because it's calculated on the basin level and then applied to all regions
```{r Status calculation, results = "show", echo = TRUE, fig.width = 9.5}

## Define constants for status calculation

min_year = 2010        # earliest year to use as a start for regr_length timeseries
##data already filtered for 
regr_length = 10       # number of years to use for regression
future_year = 5        # the year at which we want the likely future status
min_regr_length = 5    # min actual number of years with data to use for regression.

## Basin data with target
subbasin_target_chla

## Calculate basin status = basin_mean/basin_target
chla_subbasin_status <- subbasin_target_chla %>%
  mutate(., status =  pmin(1, mean_chla/target_chla)) %>%
  left_join(basin_lookup, by = "subbasin") %>% 
  mutate(region = paste(subbasin, rgn_nam, sep = ", "))
#  dplyr::select(subbasin, year, status) 

## Assign basin status to BHI regions
chla_bhi_status <- chla_subbasin_status %>%
  group_by(subbasin) %>%
  filter(year == max(year)) %>% #select last year of data for status in each basin (this means status year differs by basin)
  mutate(status = round(status*100)) %>% #status is whole number 0-100
  ungroup() %>%
  mutate(dimension = 'status',
         indicator = "chla") %>%
  dplyr::select(Subbasin = subbasin, BHI_ID = bhi_id, dimension, score=status, region, indicator)

# Plot the status (by subbasin)
ggplot(chla_subbasin_status, aes(region, status, fill = subbasin)) +
  geom_col(position = position_dodge(), color = "grey", alpha = 0.7, show.legend = FALSE) + 
  coord_flip() +
  labs(x = NULL, y = NULL) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Chl a Status by subbasins")

# Plot the status (by bhi regions)
ggplot(chla_bhi_status, aes(region, score, fill = bhi_id)) +
  geom_col(position = position_dodge(), color = "grey", alpha = 0.7, show.legend = FALSE) + 
  coord_flip() +
  labs(x = NULL, y = NULL) +
  theme_bw() +
  theme(axis.text.y = element_text(size = 7)) +
      ggtitle("Chl a Status by bhi regions")

```

#### 3.2.4 Calculate Trend 

**METHOD 1**
```{r trend calculation}
## Calculate basin trend
chla_subbasin_trend1 <- chla_subbasin_status %>%
  group_by(subbasin) %>%
  do(tail(. , n = regr_length)) %>%  # calculate trend only if there is at least X years of data (min_regr_length) in the last Y years of time serie (regr_length)
  do({if(sum(!is.na(.$status)) >= min_regr_length)
    data.frame(trend_score = 
                 max(-1, min(1, coef(lm(status ~ year, .))['year'] * future_year)))
    else data.frame(trend_score = NA)}) %>%
  ungroup() 

## Assign basin trend to BHI regions
chla_bhi_trend1 <- left_join(basin_lookup, chla_subbasin_trend1, by = "subbasin") %>%
  mutate(score = round(trend_score, 2),
         dimension = "trend",
         region = paste(subbasin, rgn_nam, sep = ", ")) %>%
  dplyr::select(bhi_id, dimension, score, region, subbasin)

```

**METHOD 2 (Ellie)**
```{r trend calculation}
## Calculate basin trend
trendyrs <- min_year:(min_year + regr_length)

chla_lm_estim <- chla_rgns_shp %>% 
  filter(year %in% trendyrs) %>% 
  group_by(subbasin) %>% 
  mutate(
    trendcalc_nyrs = n_distinct(year),
    num_obs = n()
  ) %>% 
  ## how much data is enough data to calculate short-term trends?
  do(trend_mdl = lm(chla_ug_l ~ year, data = .)) %>%
  mutate(
    projected = predict(trend_mdl, data.frame(year = max(trendyrs) + future_year)),
    current_estimated = predict(trend_mdl, data.frame(year = max(trendyrs))),
    trend_score = (projected-current_estimated)/current_estimated
  )

# filter(trendcalc_nyrs >= 6|(trendcalc_nyrs >= 4 & num_obs > 8)) %>% 

chla_subbasin_trend2 <- chla_lm_estim %>% 
  ungroup() %>% 
  select(-trend_mdl) %>% 
  group_by(subbasin) %>% 
  summarize(trend = mean(trend_score, na.rm = TRUE) %>% round(3)) %>%
  ## constrain trend values between one and negative one
  mutate(trend = ifelse(-1 <= trend & trend <= 1, trend, trend*abs(1/trend)))

## Assign basin trend to BHI regions

chla_bhi_trend2 <- left_join(basin_lookup, chla_subbasin_trend2, by = "subbasin") %>%
  mutate(score = round(trend, 2),
         dimension = "trend",
         indicator = "chla") %>%
  dplyr::select(Subbasin = subbasin, BHI_ID = bhi_id, dimension, score, indicator)

```

#### 3.2.5 Plot Status and Trend

**Plot basin status**
Basin status is initially a value between 0 - 1.  Calculated for each year between 2000 and 2020.  
```{r plot basin status, results = "show", echo = TRUE, fig.width = 9.5}
ggplot(chla_subbasin_status) + 
  geom_point((aes(year, status))) +
  facet_wrap(~subbasin) +
  theme(axis.text.x = element_text(colour="grey20", size=8, angle=90, 
                                   hjust=.5, vjust=.5, face = "plain"))

```

**Plot BHI region status and trend values**

Status values can range from 0-100 -- this is the status for the *most recent* year. In most cases this is 2019. No status or trend for 5 or 6 - these are The Sound, which had no data. 
```{r bhi status and trend plot, results = "show", echo = TRUE, fig.width = 9.5}
# Method 1
ggplot(rbind(chla_bhi_status, chla_bhi_trend1)) + 
  geom_point(aes(bhi_id, score),size=2)+
  facet_wrap(~dimension, scales="free_y")+
  xlab("BHI region")

# Method 2
ggplot(rbind(chla_bhi_status, chla_bhi_trend2)) + 
  geom_point(aes(bhi_id, score),size=2)+
  facet_wrap(~dimension, scales="free_y")+
  xlab("BHI region")
```

<br>

## 4. Visualizing Data Layers

### 4.1 Map

**Secchi Status Maps**
```{r secchi status map, results = "show", echo = TRUE, fig.width = 9.5}
mapcols <- c("indianred", "coral", "goldenrod1", "khaki", "lightblue", "steelblue")

mapdf_secchi <- bind_rows(
  secchi_bhi_status %>% 
    select(-region),
  
  secchi_bhi_trend2
    )
  
mapsf_secchi <- left_join(bhi_rgns_simple, mapdf_secchi, by = c("Subbasin", "BHI_ID"))

basemap <- ggplot2::ggplot() + 
  geom_sf(
    data = rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
      sf::st_crop(xmin = 0, xmax = 40, ymin = 53, ymax = 67),
    fill = "ivory", color = "lightsteelblue",
    size = 0.1, alpha = 0.8
  ) +
  geom_sf(data = bhi_rgns_simple, fill = NA, size = 0.15, color = "lightsteelblue") +
  scale_x_continuous(limit = c(4, 32)) +
  scale_y_continuous(limit = c(53.5, 66)) +
  theme(panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3"))

status_secchi_map <- basemap + 
  geom_sf(data = filter(mapsf_secchi, indicator == "score"), aes(fill = score), size = 0.1, alpha = 0.85) +
  facet_wrap(~ indicator) +
  scale_fill_gradientn(colors = mapcols, limits = c(0, 1), na.value = "gainsboro") +
  theme(
    legend.background = element_rect(color = "grey"),
    legend.position = c(0.15, 0.75)
  ) +
  labs(fill = "Score")
```

**Chl a Status Maps**
```{r chla status map, results = "show", echo = TRUE, fig.width = 9.5}
mapcols <- c("indianred", "coral", "goldenrod1", "khaki", "lightblue", "steelblue")

mapdf_chla <- bind_rows(
  chla_bhi_status %>% 
    select(-region),
  
  chla_bhi_trend2
    )
  
mapsf_chla <- left_join(bhi_rgns_simple, mapdf_chla, by = c("Subbasin", "BHI_ID"))

basemap <- ggplot2::ggplot() + 
  geom_sf(
    data = rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
      sf::st_crop(xmin = 0, xmax = 40, ymin = 53, ymax = 67),
    fill = "ivory", color = "lightsteelblue",
    size = 0.1, alpha = 0.8
  ) +
  geom_sf(data = bhi_rgns_simple, fill = NA, size = 0.15, color = "lightsteelblue") +
  scale_x_continuous(limit = c(4, 32)) +
  scale_y_continuous(limit = c(53.5, 66)) +
  theme(panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3"))

status_chla_map <- basemap + 
  geom_sf(data = filter(mapsf_chla, indicator == "score"), aes(fill = score), size = 0.1, alpha = 0.85) +
  facet_wrap(~ indicator) +
  scale_fill_gradientn(colors = mapcols, limits = c(0, 1), na.value = "gainsboro") +
  theme(
    legend.background = element_rect(color = "grey"),
    legend.position = c(0.15, 0.75)
  ) +
  labs(fill = "Score")
```


**Secchi and Chl a Status Maps**
```{r eutrophication status map, results = "show", echo = TRUE, fig.width = 9.5}
mapcols <- c("indianred", "coral", "goldenrod1", "khaki", "lightblue", "steelblue")

mapdf <- bind_rows(
  secchi_bhi_status %>% 
    select(-region),
  
  secchi_bhi_trend2,
  
  chla_bhi_status %>% 
    select(-region),
  
  chla_bhi_trend2
    )
  
mapsf <- left_join(bhi_rgns_simple, mapdf, by = c("Subbasin", "BHI_ID"))

basemap <- ggplot2::ggplot() + 
  geom_sf(
    data = rnaturalearth::ne_countries(scale = "medium", returnclass = "sf") %>%
      sf::st_crop(xmin = 0, xmax = 40, ymin = 53, ymax = 67),
    fill = "ivory", color = "lightsteelblue",
    size = 0.1, alpha = 0.8
  ) +
  geom_sf(data = bhi_rgns_simple, fill = NA, size = 0.15, color = "lightsteelblue") +
  scale_x_continuous(limit = c(4, 32)) +
  scale_y_continuous(limit = c(53.5, 66)) +
  theme(panel.background = element_rect(fill = "#F8FBFC", color = "#E2EEF3"))

statusmap <- basemap + 
  geom_sf(data = filter(mapsf, indicator == "score"), aes(fill = score), size = 0.1, alpha = 0.85) +
  facet_wrap(~ indicator) +
  scale_fill_gradientn(colors = mapcols, limits = c(0, 1), na.value = "gainsboro") +
  theme(
    legend.background = element_rect(color = "grey"),
    legend.position = c(0.15, 0.75)
  ) +
  labs(fill = "Score")
```
<br>

**Trend Maps**
```{r trend plots, results = "show", echo = TRUE, fig.width = 9.5}
trendsdf <- left_join(
  cw_con %>% 
    select(-rgn_nam) %>% 
    filter(dimension == "trend") %>% 
    tidyr::pivot_wider(names_from = indicator, values_from = score),
  cw_con_w_penalty %>% 
    filter(dimension == "trend") %>% 
    select(-proportion_monitored, -Subbasin),
  by = c("BHI_ID", "dimension")
)
trendsdf <- trendsdf %>% 
  tidyr::pivot_longer(
    cols = c("pcb", "pfos", "dioxin", "score"), 
    names_to = "indicator",
    values_to = "score"
  ) %>% 
  left_join(
    read_csv(here::here("supplement", "lookup_tabs", "rgns_complete.csv")) %>% 
      select(Subbasin = subbasin, subbasin_order, BHI_ID = region_id, subbasin_order),
    by = c("Subbasin", "BHI_ID")
  ) %>% 
  mutate(
    score_na = ifelse(is.na(score), 1, score),
    indicator = ifelse(indicator == "score", "average_trend", indicator)
  ) %>% 
  arrange(desc(subbasin_order))

trendsdf$Subbasin <- factor(
  trendsdf$Subbasin,
  levels = unique(trendsdf$Subbasin)
)

trendplots <- ggplot(trendsdf, aes(Subbasin, score_na, fill = score)) +
  geom_bar(stat = "identity", position = position_dodge(), show.legend = FALSE) +
  geom_hline(yintercept = 0, color = "grey") +
  scale_fill_gradientn(colors = rev(mapcols), limits = c(-1, 1), na.value = "gainsboro") +
  facet_wrap(~ indicator, nrow = 1) +
  coord_flip() +
  labs(x = NULL, y = NULL) +
  guides() +
  theme_bw()
```


```{r SOME MAAP, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5}
library(leaflet)
source(here::here("R", "spatial.R"))
regions_shape()

## join datalayers with simplified spatial data for mapping
plotshp <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% 
  sf::st_as_sf() %>% 
  dplyr::select(rgn_nam, rgn_key, Subbasin, HELCOM_ID, region_id = BHI_ID, Area_km2) %>% 
  left_join(
    DATALAYERS,
    by = "region_id"
  )
  
pal <- leaflet::colorNumeric("RdYlBu", log10(seq(1, 5, 0.01)), "#fcfcfd", reverse = TRUE)

## create map
leaflet(data = plotshp) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(18, 59, zoom = 5) %>% 
  addMapPane("popup", zIndex = 450) %>% 
  
  addPolygons(
    stroke = TRUE, opacity = 0.3, weight = 1, fillOpacity = 0.95,
    fillColor = ~palProd(DATALAYER),
    group = "GROUPNAME"
  ) %>% 
  
  ## layers controls, popup layer, and formatting
  addLayersControl(
    baseGroups = c(
      BASEGROUPS
    ),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addPolygons(
    popup = paste(
      "<h5><strong>", "Region:", "</strong>",
      plotshp$Name, "</h5>",
      "<h5><strong>", "BHI Region ID:", "</strong>",
      plotshp$region_id, "</h5>"
    ),
    fillOpacity = 0,
    stroke = FALSE,
    options = pathOptions(pane = "popup")
  )
```

<br>

## 5. Considerations for `BHI3.0`

<br>

## 6. References

```{r References, child = refs_path, results = "asis", echo = FALSE}
```

