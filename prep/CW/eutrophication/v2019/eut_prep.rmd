---
title: "Clean Water (CW) - Eutrophication (EUT) Subgoal Data Preparation"
output:
  html_document:
    toc: true
    toc_depth: 3
    code_folding: hide
---

<br>

```{r preamble prep including spatial functions and files, message = FALSE, warning = FALSE, include = FALSE}
loc <- here::here("prep", "CW", "eutrophication")

source(here::here("R", "setup.R"))
knitr::opts_chunk$set(message = FALSE, warning = FALSE, results = "hide", fig.width = 9.5)

bkgd_path <- here::here("supplement", "goal_summaries", "EUT.Rmd")
data_path <- here::here("data", "CW", "eutrophication", version_year, "eut_data.rmd")
refs_path <- file.path(loc, "eut_references.Rmd")

source(here::here("R", "spatial.R"))
regions_shape()
buffer_sf <- st_read(
  file.path(dirname(dir_B), "Shapefiles", "BHI_shapefile_25km_buffer"), 
  "BHI_shapefile_25km_buffer"
)
bhi_rgns_simple <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% sf::st_as_sf()
```

## 1. Background

```{r Background, child = bkgd_path, results = "asis", echo = FALSE}
```

<br/>

## 2. Data

This prep document is used to generate and explore the following data layers:

- `cw_eut_status_bhi2019.csv` 
- `cw_eut_trend_bhi2019.csv` 

These are saved to the `layers/v2019` folder. Saved to `data/GOAL/v2019/intermediate` are intermediate datasets: `secchi_merged_rawdata.csv`, `ox_merged_rawdata.csv` and `DATASETINTEMED3.csv`. All these are derived from or informed by the raw datasets from ICES, SMHI and Baltic Nest database.

<br>

<!-- ## 2. Data --- header in the child  document -->
```{r Data, child = data_path, results = "asis", echo = FALSE}
```

<br/>

## 3. Prep: Wrangling & Derivations, Checks/Evaluation, Gapfilling

```{r load datasets, echo = FALSE, include = FALSE}
combined_secchi_rawdata <- read_csv(file.path(dirname(data_path), "intermediate", "secchi_merged_rawdata.csv"))
combined_ox_rawdata <- read_csv(file.path(dirname(data_path), "intermediate", "ox_merged_rawdata.csv"))
```

### 3.1 Secchi Indicator

#### 3.1.1 Match BHI regions

```{r assign BHI regions to Secchi data, echo = TRUE, message = FALSE, warning = FALSE}
# before assigning bhi basins to secchi data, run this function first:
regions_shape(sp_dir = file.path(dirname(dir_B), "Shapefiles"))
 
# assign bhi basins to secchi data 
secchi_rgns_shp <- join_rgns_info(
  combined_secchi_rawdata, helcomID_col = "helcom_id", country_col = "country", 
                           latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
                           rgn_shps_loc = file.path(dirname(dir_B), "Shapefile"), buffer_shp = NULL) %>% 
  # select summer months (June-September) and Years >= 2000  
  filter(month == "06" | month == "07" | month == "08" | month == "09") %>% 
  filter(year >=2000) %>% 
  rename(country = rgn_nam,
         ctry_key = rgn_key,
         subbasin = Subbasin,
         helcom_id = HELCOM_ID,
         bhi_id = BHI_ID,
         ices_area = ICES_area)

##secchi_rgns_shp <- join_rgns_info(
  ##secchi, helcomID_col = "helcom_id", country_col = "country", 
    ##                       latlon_vars = c("^lat", "^lon"), return_spatial = FALSE, 
      ##                     regions_shape(sp_dir = file.path(dirname(dir_B), "Shapefiles")), buffer_shp = NULL)

```

**Spatial Visualization of Secchi data**
```{r}
# Plot by bhi regions
ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m), size = 0.3, alpha = 0.4) +
  facet_grid(cols = vars(country), rows = vars(bhi_id))

ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~bhi_id, scales ="free_y")

ggplot(secchi_rgns_shp) + 
  geom_point(aes(month, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~bhi_id, scales ="free_y")

# Plot by subbasins
ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m), size = 0.3, alpha = 0.4) +
  facet_grid(cols = vars(subbasin), rows = vars(country))

ggplot(secchi_rgns_shp) + 
  geom_point(aes(year, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~subbasin, scales ="free_y")

ggplot(secchi_rgns_shp) + 
  geom_point(aes(month, secchi_m, colour = supplier), size = 0.3, alpha = 0.4) +
  facet_wrap(~subbasin, scales ="free_y")

```

<br/>

#### 3.1.2 Mean secchi Calculation

**Calculate mean monthly value for each summer month (subbasin)** 
basin monthly mean = mean of all samples within month and subbasin
```{r calculate monthly mean secchi}

sub_mean_months <- secchi_rgns_shp %>% 
  dplyr::select(year, month, subbasin, secchi_m)%>%
  group_by(year, month, subbasin) %>%
  summarise(mean_secchi = round(mean(secchi_m, na.rm=TRUE), 1)) %>%
  ungroup()

## Plot mean monthly value by subbasin
ggplot(sub_mean_months) + 
  geom_point(aes(year, mean_secchi, colour = factor(month))) +
  geom_line(aes(year, mean_secchi, colour = factor (month))) +
  facet_wrap (~subbasin) +
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Monthly Secchi")

## There might be some outlier to check (TO-DO)
```


**Calculate summer mean secchi (subbasin)**
basin summer mean = mean of basin monthly mean values
```{r calculate mean summer secchi}

sub_mean_months_summer <- sub_mean_months %>% 
  dplyr::select(year, subbasin, mean_secchi) %>%
  group_by(year, subbasin) %>%
  summarise(mean_secchi = round(mean(mean_secchi,na.rm=TRUE),1)) %>%
  filter(!is.na(subbasin)) %>% 
  ungroup()  #in mean calculation all some months to have NA, ignore for that years calculation

# Plot summer mean secchi
ggplot(sub_mean_months_summer) + 
  geom_point(aes(year, mean_secchi)) +
  geom_line(aes(year, mean_secchi)) +
  facet_wrap(~subbasin)+
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Summer Secchi")

## Only few outliers to check (TO-DO)
```

**Calculate mean monthly value for each summer month (bhi basins)** 
basin monthly mean = mean of all samples within month and bhi basins
```{r calculate monthly mean secchi}

bhi_mean_months <- secchi_rgns_shp %>% 
  dplyr::select(year, month, bhi_id, secchi_m)%>%
  group_by(year, month, bhi_id) %>%
  summarise(mean_secchi = round(mean(secchi_m, na.rm=TRUE), 1)) %>%
  ungroup()

## Plot mean monthly value by bhi basin
ggplot(bhi_mean_months) + 
  geom_point(aes(year, mean_secchi, colour = factor(month)), size = 1.2, alpha = 0.4) +
  geom_line(aes(year, mean_secchi, colour = factor(month)), alpha = 0.3) +
  facet_wrap (~bhi_id) +
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Monthly Secchi")

## There might be some outlier to check (TO-DO)
```

**Calculate summer mean secchi (bhi basins)**
basin summer mean = mean of basin monthly mean values
```{r calculate mean summer secchi}

bhi_mean_months_summer <- bhi_mean_months %>% 
  dplyr::select(year, bhi_id, mean_secchi) %>%
  group_by(year, bhi_id) %>%
  summarise(mean_secchi = round(mean(mean_secchi,na.rm=TRUE),1)) %>%
  ungroup()  #in mean calculation all some months to have NA, ignore for that years calculation

# Plot summer mean secchi
ggplot(bhi_mean_months_summer) + 
  geom_point(aes(year, mean_secchi)) +
  geom_line(aes(year, mean_secchi)) +
  facet_wrap(~bhi_id)+
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Summer Secchi")

## There might be some outlier to check (TO-DO)
```
<br/>

**Plot summer secchi with target values indicated**
Horizontal lines are HELCOM target values 
```{r summer secchi with target }

target <- left_join(sub_mean_months_summer, target_secchi, by = "subbasin")
# head(secchi_target)

ggplot(secchi_target) + geom_point(aes(year,mean_secchi))+
  geom_line(aes(year,target_secchi))+
  facet_wrap(~basin_name)+
  scale_y_continuous(limits = c(0,10)) +
  ggtitle("Mean Summer Secchi against Targe values")

```



## 4. Visualizing Data Layers

### 4.1 Map

```{r SOME MAAP, results = "show", message = FALSE, echo = TRUE, fig.width = 9.5}
library(leaflet)
source(here::here("R", "spatial.R"))
regions_shape()

## join datalayers with simplified spatial data for mapping
plotshp <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% 
  sf::st_as_sf() %>% 
  dplyr::select(rgn_nam, rgn_key, Subbasin, HELCOM_ID, region_id = BHI_ID, Area_km2) %>% 
  left_join(
    DATALAYERS,
    by = "region_id"
  )
  
pal <- leaflet::colorNumeric("RdYlBu", log10(seq(1, 5, 0.01)), "#fcfcfd", reverse = TRUE)

## create map
leaflet(data = plotshp) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(18, 59, zoom = 5) %>% 
  addMapPane("popup", zIndex = 450) %>% 
  
  addPolygons(
    stroke = TRUE, opacity = 0.3, weight = 1, fillOpacity = 0.95,
    fillColor = ~palProd(DATALAYER),
    group = "GROUPNAME"
  ) %>% 
  
  ## layers controls, popup layer, and formatting
  addLayersControl(
    baseGroups = c(
      BASEGROUPS
    ),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addPolygons(
    popup = paste(
      "<h5><strong>", "Region:", "</strong>",
      plotshp$Name, "</h5>",
      "<h5><strong>", "BHI Region ID:", "</strong>",
      plotshp$region_id, "</h5>"
    ),
    fillOpacity = 0,
    stroke = FALSE,
    options = pathOptions(pane = "popup")
  )
```

<br>

## 5. Considerations for `BHI3.0`

<br>

## 6. References

```{r References, child = refs_path, results = "asis", echo = FALSE}
```

