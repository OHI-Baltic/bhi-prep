---
title: "Contaminants - Clean Water Subgoal data prep"
output:
  github_document:
    toc: true
    toc_depth: 3
params: 
    datasource: csv
---

```{r Preamble}
loc <- here::here("prep", "CW", "contaminants")

source(here::here("R", "setup.R"))

bkgd_path <- here::here("supplement", "goal_summaries", "CON.Rmd")
data_path <- here::here("data", "CW", "contaminants", version_year, "con_data.rmd")
refs_path <- file.path(loc, "con_references.Rmd")
```

## 1. Background

```{r Background, child = bkgd_path, results = "asis", echo = FALSE}
```

<br/>

## 2. Data

```{r Data, child = data_path, results = "asis", echo = FALSE}
```

<br/>

## 3. Prep: Wrangling & Derivations, Checks/Evaluation, Gapfilling

```{r load datasets created from con_data.rmd steps, echo = TRUE, results = "hide"}
source(here::here("R", "spatial.R"))
```


### 3.1 PCB Indicator
#### 3.1.1 Match BHI Regions and Subbasins

**Use Lat/Long to Match BHI Regions**
```{r assign BHI regions to PCB data, echo = TRUE}
## use 'join_rgns_info' helper function defined in R/spatial.R
pcb_bio_sf <- join_rgns_info(
  read_csv(file.path(dirname(data_path), "intermediate", "pcb_biota_cleaned.csv")), 
  latlon_vars = c("latitude", "longitude"),
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
  return_spatial = TRUE
) 
pcb_sed_sf <- join_rgns_info(
  read_csv(file.path(dirname(data_path), "intermediate", "pcb_sediment_cleaned.csv")), 
  latlon_vars = c("latitude", "longitude"),
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
  return_spatial = TRUE
) 
pcb_bio <- tibble::as_tibble(pcb_bio_sf)
pcb_sed <- tibble::as_tibble(pcb_sed_sf)
```
<br>

#### 3.1.2 Filter PCBs to ICES6 Set and Join Station Impact

```{r filter data to include only six ICES congeners}
pcb_bio_ices6 <- c("CB28", "CB52", "CB101", "CB138", "CB153", "CB180")

```
<br>




#### 3.1.3 Evaluate flagged data, Station Impact, & sampling patterns

**Spatial distributions of PCB sampling Locations**

```{r}

```

<br>

**Quantification limits, Flags Codes**

- **<** = less than  

- **>** = greather than  

- **D** = reported value is less than the detection limit (detect_lim)  

- **Q** = reported value is less than the limit of quantification (quant_lim)  

- **~** separates multiple flags  

No information is given for what **<** implies when is it is used alone (e.g. is it related to the detection limit?)

**Values for detect_lim and quant_lim**: Remember these are in the original units (not standardized to ug_kg or to wet weight)

<br>

**Station Impact Codes**

Some sites have had the site type recorded in the ICES station dictionary ([see ICES vocabulary reference for codes](https://vocab.ices.dk/?ref=177). It is important to know which sites are catagorized as:  

1. **RH** = WFD R(HZ) - Representative of general conditions in terms of hazardous substances  
2. **B** = WFD B - Baseline/Reference station  
3. **Any of the codes containing "I"** (IH, IH-A, IH-C, IH-D, IH-E, IH-F, IH-H, IH-I, IH-M, IH-O, IH-P, IH-S, IH-W, IP, IP-B, IP-N, IP-T) which refers to a specific type of impact at the site.  

It appears that only Swedish sites have this information entered. Most are RH (19), while B accounts for 4 and RP 1. RP = WFD R(PHY) Representative of general conditions for nutrients/organic matter. Given only Swedish sites have this information recorded, it seems difficult to use this information to include or exclude sites.  

From the station dictionary definitions:

- All_Biota_Data: Data type (DTYPE) CF - all parameters - contaminants and biological effects of contaminants including disease in biota
- Contaminant_parameters_in_biota: Data type (DTYPE) CF - Contaminant parameter groups

<br>

#### 3.1.4 Status and trend options and calculation

**Summary of Analysis**

- Compare calculating the status by BHI region or Basin
- Take mean ICES conc. by date and location (our unique observations) 
- Take mean of all unique observations for past 10 years in either BHI region or basin. If done by basin, give basin score to all regions within basin.
- Compare by-basin and by-BHI region results for status and for trend
- Assess number of data points contributing


**Notes on Status Calculation**

- Use data including qflag-adjusted (this could lower values for trend)
- Use 5 year mean ICES6 concentration
- Scale all observations relative to the human health threshold? **Why Scale?** If values are all below the threshold would not want an increase trend in observed values to suggest that the future status will be worse?? 
- **Need to have mixed-effects to account for different stations?**


Calculate the sum of the ICES6 congeners values for each date and location. For observations averaged, also calculate mean, min, and max number of congeners in each of the observations, and also numbers of observations for each date and location.

```{r sum ICES6 PCBs by date and location}

```
<br>

#### 3.1.5 Gapfilling
#### 3.1.6 Methods discussion

**Status formula, ICES6 PCBs Biota**
$X_{\mbox{ICES6}} = \frac{1}{\mbox{mean_ICES6_region/reference_point} \times \mbox{penalty_factor}}$

$\mbox{reference_point} = 75ug/kg \times \mbox{health_threshold}$

Scale between 0 and 1.  If value is below 75, $\mbox{score} = 1$


**Only herring (not other species) used as biota because most equally spatially spaced across the  baltic sea, others mostly in south**


**Trend Considerations**

1. Work on mixed effect model for trends?  
2. Need to think about the interpretation of the data treatment. (a) If use raw observations, then normalize (zscore data), then fit trend, if get increase or decrease but all values are below the threshold, does it make sense to apply a change in the trend to the status?  Would we really think the future status will be lower?  (b) If take all raw observations, calculate "status" as done for the mean value, then fit trend, is this more true to the idea that variation below the human health threshold should not affect the trajectory of the future status?  
3. Need to think if simple linear regression is okay, or if need to account for site?


**`BHI1.0` discussion with Anna Sobek **

1. Indicator choice: We agreed that ICES6 is the best option  
2. Decision about use of qflagg-adjusted data: use qflagged data with the adjustement of (congener conc/2)  
3. Decision about spatial scale of the data: decide best approach is to calculate for each basin  
4. Trend decision: best approach is first convert individual observations to a "status" relative to the human health threshold, then fit linear model by basin for 10 year period. (**TREND CHECK:** Does the trend value need to be rescaled to between -1 and 1? Does not exceed now but need to consider if method broadly works?)  


---

<br>

### 3.2 PFOS Indicator
#### 3.2.1 Match BHI Regions

**Use Lat/Long to Match BHI Regions**
```{r assign BHI regions to PFOS data, echo = TRUE}
## use 'join_rgns_info' helper function defined in spatial.R
pfos_bio_sf <- join_rgns_info(
  read_csv(file.path(dirname(data_path), "intermediate", "pfos_biota_cleaned.csv")), 
  latlon_vars = c("latitude", "longitude"),
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
  return_spatial = TRUE
) 
pfos_bio <- tibble::as_tibble(pfos_bio_sf)
```


#### 3.2.2 Evaluate flagged data & sampling patterns
#### 3.2.3 Status and trend options and calculation
#### 3.2.4 Gapfilling
#### 3.2.5 Methods discussion

---

<br>

### 3.3 Dioxin Indicator
#### 3.3.1 Match BHI Regions and Join with Dioxin-like PCBs

**Use Lat/Long to Match BHI Regions**

```{r assign BHI regions to PCB data, echo = TRUE}
## use 'join_rgns_info' helper function defined in spatial.R
dioxin_bio_sf <- join_rgns_info(
  read_csv(file.path(dirname(data_path), "intermediate", "dioxin_biota_cleaned.csv")), 
  latlon_vars = c("latitude", "longitude"),
  rgn_shps_loc = file.path(dirname(dir_B), "Shapefiles"),
  return_spatial = TRUE
)
dioxin_bio <- tibble::as_tibble(dioxin_bio_sf)
```
<br>

**Assess if Dioxins and dioxin-like PCBs share `sub_sample_ref`**
Were dioxins and PCBs measured from the same samples such that a total TEQ value per sample can be calculated?

**Use TEF conversion factor to convert to TEQ**
Dioxins and dioxin-like PCBs still separate objects here.

```{r convert to TEQ}

```

**Filter PCB to keep only dioxin-like PCBs and convert units**

```{r convert dioxin like PCBs ug to pg per gram}

```

<br>

#### 3.3.2 Evaluate flagged data & sampling patterns

**Adjust Qflagged values**
Use $LOD/2$ approach to adjust values. Because we do not have the LOD in all cases, use: $adjustedValue = value / 2$

**Filter to keep only years where exists quality data**

<br>

#### 3.3.3 Indicator options and calculation

**Calculate the mean TEQ value by basin using just years 2009-2013 (?)**
<br>

**Total TEQ (pg/g) Dioxin**

Calculate the sum of the mean dioxin and the mean dioxin-like PCB TEQ value for each date and location. For observations averaged, also calculate mean, min, and max number of congeners in each of the observations, and also numbers of observations for each date and location.

Horizontal line is the EU human health threshold (6.5 TEQ pg/g ww) (equivalent to suggested HELCOM level of 0.0065 TEQ ug/kg ww)

<br>


#### 3.3.4 Gapfilling
#### 3.3.5 Methods discussion

**Dioxin status value**

$X_{TEQstatus} = \frac{1}{\mbox{dioxin + } \mbox{dioxin-like pcb teq value / teq threshold }}$


<br/>

## 4. Visualizing Data Layers


### 4.1 Timeseries Plots

```{r }

```

<br>

### 4.2 Map of Contaminants Datasets

```{r}

```

<br/>

---

<br>

## 5. Considerations for `BHI3.0`

---

<br>

## 6. References

```{r References, child = refs_path, results = "asis", echo = FALSE}
```

<br>
