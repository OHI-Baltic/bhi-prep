---
title: "Wild-Caught Fisheries - Food Provision Subgoal data prep"
output:
  html_document:
    toc: true
    toc_depth: 4
---

```{r preamble prep}
loc <- file.path(here::here(), "prep", "FIS")

source(file.path(here::here(), "R", "setup.R"))
source(file.path(here::here(), "R", "prep.R"))
knitr::opts_chunk$set(message = FALSE, warning = FALSE, results = "hide", fig.width=9.5)

bkgd_path <- file.path(here::here(), "supplement", "goal_summaries", "FIS.Rmd")
data_path <- file.path(here::here(), "data", "FIS", version_year, "fis_np_data.rmd")
refs_path <- file.path(loc, "fis_references.Rmd")

dir_layer <- file.path(here::here(), "layers")
```

## 1. Background

```{r background, child = bkgd_path, results = "asis", echo = FALSE}
```

<br/>

<!-- ## 2. Data --- header in the child  document -->
```{r data, child = data_path, results = "asis", echo = FALSE}
```

<br/>

## 3. Prep: Wrangling & Derivations, Checks/Evaluation, Gapfilling

### 3.1 Reorganizing/wrangling

This section prepares data layers for FIS and NP at the same time, separating the fish stocks for each:

- FIS stocks: cod_22-24, cod_25-32, her_28.1, her_20-24, her_25-29,32, her_30-31
- NP stocks: spr_22-32

<br>

#### 3.1.1 Load datasets

```{r load raw datasets, message = FALSE, warning = FALSE}
## root location of the raw data
dir_rawdata <- file.path(dir_B, "Goals", "FP", "FIS") # list.files(dir_rawdata)

## Fisheries data from ICES
## note if csvs are saved w/ semicolons, to read columns...

# source(file.path(here::here(), "R", "semicolon_to_comma.R"))
# lapply(
#   list("cod_SDs22_24", "cod_SDs24_32",
#        "herring_SD_28.1", "herring_SDs20_24",
#        "herring_SDs25_29_32", "herring_SDs30_31"),
#   function(x){
#      fp <- file.path(dir_rawdata, x, paste0(x, "_reformat.csv"))
#      semicolon_to_comma(fp, remove_na_cols = TRUE, overwrite = TRUE)
#   }
# )
# semicolon_to_comma(file.path(dir_B, "Goals", "NP", "sprat_SDs22_32", "sprat_SDs22_32_reformat.csv"), TRUE, TRUE)


## cod data
cod1raw <- read_csv(file.path(dir_rawdata, "cod_SDs22_24", "cod_SDs22_24_reformat.csv"))
cod2raw <- read_csv(file.path(dir_rawdata, "cod_SDs24_32", "cod_SDs24_32_reformat.csv"))

## herring data
herring1raw <- read_csv(file.path(dir_rawdata, "herring_SD_28.1", "herring_SD_28.1_reformat.csv"))
herring2raw <- read_csv(file.path(dir_rawdata, "herring_SDs20_24", "herring_SDs20_24_reformat.csv"))
herring3raw <- read_csv(file.path(dir_rawdata, "herring_SDs25_29_32", "herring_SDs25_29_32_reformat.csv"))
herring4raw <- read_csv(file.path(dir_rawdata, "herring_SDs30_31", "herring_SDs30_31_reformat.csv"))

## sprat data
sprat1raw <- read_csv(file.path(dir_B, "Goals", "NP", "sprat_SDs22_32", "sprat_SDs22_32_reformat.csv"))

## make MSY values table
## these values are obtained from ICES reports, see data/FIS/fis_np_data.rmd for more details
msy_data <- t(data.frame(
  c("cod", "22-24", "cod_SDs22_24", 21876, 0.26),
  c("cod", "24-32", "cod_SDs24_32", 108035, 0.3),
  c("herring", "28.1", "herring_SD_28.1", 60000, 0.32),
  c("herring", "20-24", "herring_SDs20_24", 150000, 0.31),
  c("herring", "25-29,32", "herring_SDs25_29_32", 600000, 0.22),
  c("herring", "30-31", "herring_SDs30_31", 140998, 0.15),
  c("sprat", "22-32", "sprat_SDs22_32", 570000, 0.26)
))
colnames(msy_data) <- c("species", "SDs", "stockname", "BMSY", "FMSY")
rownames(msy_data) <- NULL
msy_data <- as_tibble(msy_data)
```

<br>

#### 3.1.2 Merge datasets and calculate F/FMSY and B/BMSY ratios

```{r merge dataset and calculate ffmsy bbmsy ratios}
combined_rawdata <- rbind(
  ## cod
  cod1raw %>% 
    dplyr::select(
      year, ssb, 
      fis_mort = fishing_mortality_age3_5, 
      landings = landings_tonnes
    ) %>%
    mutate(stockname = "cod_SDs22_24"),
  cod2raw %>% 
    dplyr::select(
      year, ssb, 
      fis_mort = fishing_mortality_age4_6, 
      landings = landings_tonnes
    ) %>% 
    mutate(stockname = "cod_SDs24_32"),
  ## herring
  herring1raw %>% 
    dplyr::select(
      year, ssb = ssb_tonnes, 
      fis_mort = `F`, 
      landings = catches_tonnes
    ) %>% 
    mutate(stockname = "herring_SD_28.1"),
  herring2raw %>% 
    dplyr::select(
      year, ssb = ssb_tonnes, 
      fis_mort = F_age3_6, 
      landings = catches_tonnes
    ) %>% 
    mutate(stockname = "herring_SDs20_24"),
  herring3raw %>% 
    dplyr::select(
      year, ssb = ssb_tonnes, 
      fis_mort = F_age3_6, 
      landings = catches_tonnes
    ) %>% 
    mutate(stockname = "herring_SDs25_29_32"),
  herring4raw %>% 
    dplyr::select(
      year, ssb = ssb, 
      fis_mort = F_age3_7, 
      landings = catches_tonnes
    ) %>% 
    mutate(stockname = "herring_SDs30_31"),
  ## sprat
  sprat1raw %>% 
    dplyr::select(
      year, ssb = ssb_tonnes, 
      fis_mort = F_age3_5, 
      landings = catches_tonnes
    ) %>% 
    mutate(stockname = "sprat_SDs22_32")) %>% 
  ## join with msy data
  filter(!is.na(year)) %>% 
  left_join(msy_data, by = c("stockname")) %>% 
  mutate(bbmsy = ssb/as.numeric(BMSY), ffmsy = fis_mort/as.numeric(FMSY)) %>% 
  arrange(species, stockname, year)
```

<br>

#### 3.1.3 Convert from ICES Fisheries regions to Baltic Regions

[Map of ICES regions.](ICES regions map https://www.ices.dk/marine-data/Documents/Maps/ICES-Ecoregions-hybrid-statistical-areas.png)
The map below shows the overlap between ICES subdivisions and the BHI regions:

```{r how the ICES and BHI regions overlap, results = "show"}
source(file.path(here::here(), "R", "spatial.R"))
regions_shape() # loads spatial features objects

## ICES shapefile has crs EPSG:3035
## https://spatialreference.org/ref/epsg/etrs89-etrs-laea/
## transform to match BHI crs of EPSG:4326, and simplify

ices_transform <- rmapshaper::ms_simplify(input = ICES_rgns_shp) %>% 
  sf::st_as_sf() %>% 
  sf::st_transform(crs = 4326)

bhi_rgns_simple <- rmapshaper::ms_simplify(input = BHI_rgns_shp) %>% 
  sf::st_as_sf() # also simplify BHI shp for plotting

ggplot2::ggplot() + 
  geom_sf(data = ices_transform, aes(fill = ICES_area), color = NA) +
  scale_fill_manual(values = colorRampPalette(RColorBrewer::brewer.pal(9, "Pastel1"))(14)) +
  labs(fill = "ICES Subdivisions", x = NULL, y = NULL) +
  geom_sf(data = bhi_rgns_simple, fill = NA, color = "grey70") +
  geom_sf_text(data = bhi_rgns_simple, aes(label = BHI_ID))
```


```{r converting ICES fisheries regions to Baltic regions}
## based on 'prep/FIS/raw/DataOrganization.R' by Melanie Frazier March 16 2016, in bhi-1.0-archive
## ICES regions map https://www.ices.dk/marine-data/Documents/Maps/ICES-Ecoregions-hybrid-statistical-areas.png

## table for matching ICES to BHI regions
regions <- read_csv(
  file.path(here::here(), "supplement", "lookup_tabs", "ices_to_bhi_lookup.csv"), 
  col_types = cols()) %>% 
  dplyr::select(-ices_id) %>% 
  mutate(ices_numeric = ifelse(ices_numeric == 3, 21, ices_numeric)) # 3a.21 overlaps BHI rgn 1 & 2

## areas of BHI regions
bhi_ices_areas <- BHI_rgns_shp %>% 
  dplyr::select(region_id = BHI_ID, Area_km2) %>% 
  left_join(regions, by = "region_id") 
st_geometry(bhi_ices_areas) <- NULL


## convert ICES stock assessments to BHI regions
combined_w_rgns <- combined_rawdata %>% 
  
  ## expand ices subdivisions categories to one row per subdiv
  rowwise() %>% 
  mutate(
    ## check unique(combined_rawdata$SDs) to make sure this will work
    sd_from = as.numeric(str_split(SDs, "-|,")[[1]][1]),
    sd_to = as.numeric(str_split(SDs, "-|,")[[1]][2]),
    sd_extra = as.numeric(str_split(SDs, "-|,")[[1]][3])
  ) %>% 
  mutate(
    sd_to = ifelse(is.na(sd_to), sd_from, sd_to),
    sd_extra = ifelse(is.na(sd_extra), sd_from, sd_extra),
    incl28.2 = sd_from <= 28 & sd_to >= 28,
    incl28.1 = sd_from <= 28 & sd_to >= 28 & species != "herring"
  ) %>% 
  ## ICES regions 28.1 for Riga and 28.2 elsewhere but no 28
  mutate(SDs = list(
    unique(
      c(sd_from:sd_to, sd_extra)[c(sd_from:sd_to, sd_extra)!=28] %>% 
        c(ifelse(incl28.2, 28.2, sd_from)) %>% 
        c(ifelse(incl28.1, 28.1, sd_from))
    )
  )) %>% 
  tidyr::unnest(ices_subdiv = SDs) %>% 
  dplyr::select(-sd_from, -sd_to, -sd_extra, -incl28.1, -incl28.2) %>% 
  
  ## add BHI regions info using ices_to_bhi_lookup
  left_join(regions, by = c("ices_subdiv" = "ices_numeric")) %>%
  
  ## join spatial/area information
  left_join(bhi_ices_areas, by = c("region_id", "ices_subdiv" = "ices_numeric")) %>% 
  filter(ices_subdiv != 20) %>% # filter because no BHI region assigned to SD 20 and will cause NA means...
  group_by(stockname, year) %>% 
  mutate(
    ## without better information, assuming landings are uniform across stock assessment area, 
    ## then landings within BHI rgn are proportional to rgn area fraction of total stock area
    landings_rate = landings/sum(Area_km2), # per unit area
    rgn_landings = landings*(Area_km2/sum(Area_km2))
  ) %>% 
  
  ## save intermediate dataset
  rename(stock = stockname, area_BHIrgn_km2 = Area_km2) %>% 
  filter(year < assess_year) # current yr fish. mort. data won't be complete

## ICES subdivs 20 and 21 are North Sea and left out of BHI1.0, but herring in 3a.21...
# combined_w_rgns <- combined_w_rgns %>% filter(!ices_subdiv %in% c(20, 21))

## full merged dataset with MSY and raw data, as well as calculated ratios
## this will be used for the shiny app among other things!
write_csv(combined_w_rgns, file.path(loc, version_year, "intermediate", "fis_full_merged_dataset.csv"))
```

<br>

#### 3.1.4 Wrangle and save layers for FIS and NP Goals

The F/FMSY, B/BMSY, and landings data are the ICES stock assessment area values, expanded to have all years rows per BHI region within the stock assessment area, and row-bound to include all stocks in one table.

```{r fis_ffmsy_bbmsy and fis_landings datasets, out.width = "850px"}

## full dataset in long format with calculated ratios:
long_format_msy_metrics <- combined_w_rgns %>% 
  dplyr::select(region_id, stock, species, year, bbmsy, ffmsy) %>% 
  tidyr::gather(key = metric, value = value, -year, -stock, -species, -region_id)

msy_metrics_plot <- ggplot(filter(long_format_msy_metrics, year >= 1970))  +
  geom_abline(slope = 0, intercept = 1, color = "grey40") +
  geom_line(aes(x = year, y = value, color = stock), size = 0.5) +
  scale_color_brewer(palette = "Paired") +
  ylab("value \n")+
  facet_grid(vars(species), vars(metric)) + 
  theme(legend.position = "none")

## all landings data:
landings_all <- combined_w_rgns %>% 
  dplyr::select(-ssb, -fis_mort, -BMSY, -FMSY, -area_BHIrgn_km2) %>% 
  tidyr::gather(key = "metric", value = "value", -year, -stock, -species, -region_id, -ices_subdiv)

landings_plot <- ggplot(filter(landings_all, year >= 1970, metric == "landings")) +
  geom_line( aes(x = year, y = value, color = stock), size = 0.5) +
  scale_color_brewer(palette = "Paired") +
  ylab(NULL) +
  facet_grid(vars(species), vars(metric)) # landings_plot

# ggplot(filter(landings_all, metric == "rgn_landings")) +
#   geom_point(aes(x = year, y = value, color = stock), size = 2, alpha = 0.1) +
#   geom_line(
#     data = summarize(filter(landings_all, metric == "rgn_landings"), mn = mean(value)),
#     aes(x = year, y = mn, color = stock)) +
#   scale_color_brewer(palette = "Paired") +
#   ylab(NULL) +
#   facet_grid(vars(stock))
```

```{r create and save FIS and NP layers}
## same preparation of data for fis and np, just different stocks used:
## cod and herring are used in the FIS goal
## sprat are used for the NP goal
goal_stocks <- c("FIS", "NP")
for(g in goal_stocks){
  
  if(g == "FIS"){
    dat <- long_format_msy_metrics %>% 
      filter(!str_detect(stock, "spr"))
    landings <- landings_all %>% 
      filter(!str_detect(stock, "spr"))
  } else {
    dat <- long_format_msy_metrics %>% 
      filter(str_detect(stock, "spr"))
    landings <- landings_all %>% 
      filter(str_detect(stock, "spr"))
  }
  
  ## filter to save by metric: bbmsy, ffmsy, landings
  dat %>% 
    filter(metric == "bbmsy") %>% 
    dplyr::select(-metric, -species) %>% 
    write_csv(
      file.path(dir_layer, sprintf(
        "%s_bbmsy_bhi%s.csv", 
        str_to_lower(g), 
        assess_year
      ))
    )
  dat %>% 
    filter(metric == "ffmsy") %>% 
    dplyr::select(-metric, -species) %>% 
    write_csv(
      file.path(dir_layer, sprintf(
        "%s_ffmsy_bhi%s.csv", 
        str_to_lower(g), 
        assess_year
      ))
    )
  landings <- landings %>%
    filter(metric  == "rgn_landings") %>% 
    # filter(metric  == "landings") %>% # BHI 1.0 APPROACH
    rename(landings = value) %>% 
    dplyr::select(-metric, -species) %>% 
    write_csv(
      file.path(dir_layer, sprintf(
        "%s_landings_bhi%s.csv", 
        str_to_lower(g), 
        assess_year 
      ))
    )
}
```


### 3.2 Evaluate data & sampling patterns

#### 3.2.1 Comparing with previous BHI Assessment

```{r compare to data used in last assessment}
## load layers
fis_bbmsy <- read_csv(
  file.path(dir_layer, sprintf("fis_bbmsy_bhi%s.csv", assess_year))) %>% 
  rename(bbmsy = value)
fis_ffmsy <- read_csv(
  file.path(dir_layer, sprintf("fis_ffmsy_bhi%s.csv", assess_year))) %>% 
  rename(ffmsy = value)
fis_landings <- read_csv(
  file.path(dir_layer, sprintf("fis_landings_bhi%s.csv", assess_year)))

## previous assessment layers
prev_fis_bbmsy <- read_csv(
  file.path(dirname(dir_assess), "bhi-1.0-archive", "baltic2015", "layers",
            sprintf("fis_bbmsy_bhi%s.csv", 2015))) %>% 
  rename(prev_bbmsy = score, region_id = rgn_id)

prev_fis_ffmsy <- read_csv(
  file.path(dirname(dir_assess), "bhi-1.0-archive", "baltic2015", "layers",
            sprintf("fis_ffmsy_bhi%s.csv", 2015))) %>% 
  rename(prev_ffmsy = score, region_id = rgn_id)

prev_fis_landings <- read_csv(
  file.path(dirname(dir_assess), "bhi-1.0-archive", "baltic2015", "layers",
            sprintf("fis_landings_bhi%s.csv", 2015))) %>% 
  rename(prev_landings = landings, region_id = rgn_id)

## join and plot to identify differences
## ICES assessment areas for each stock change sometimes between ICES and BHI Assessments...
matchtab <- data.frame(
  from = c("cod_SDs22_24", "cod_SDs24_32", "herring_SD_28.1", "herring_SDs20_24", "herring_SDs25_29_32", "herring_SDs30_31"),
  to = c("cod_2224", "cod_2532", "her_riga", "her_3a22", "her_2532", "her_30")
)
matchtab$from <- as.character(matchtab$from)
matchtab$to <- as.character(matchtab$to)

## mapping between/matching previous CES stock assess. areas and most recent
stockareas_match <- function(tab, jointab, matchtab){
  for(i in 1:nrow(matchtab)){
    tab <- tab %>% 
      mutate(stock = str_replace(stock, pattern = matchtab[i, "from"], replacement = matchtab[i, "to"]))
  }
  revisedtab <- tab %>% 
    left_join(jointab, by = c("stock", "year", "region_id")) %>% 
    ## create logical column highlighting where stock assessment area changes occured
    mutate(changed_assess_area = ifelse(stock %in% c("cod_2532", "her_3a22", "her_30"), TRUE, FALSE)) %>% 
    dplyr::select(-region_id) %>% 
    distinct()
  return(revisedtab)
}
compare_bbmsy <- stockareas_match(fis_bbmsy, prev_fis_bbmsy, matchtab)
compare_ffmsy <- stockareas_match(fis_ffmsy, prev_fis_ffmsy, matchtab)


## plot to investigate effects of these changes...
compare_bbmsy_plot <- ggplot(compare_bbmsy) +
  geom_point(
    aes(x = prev_bbmsy, y = bbmsy, color = changed_assess_area, shape = stock), 
    size = 2, alpha = 0.6
  ) + 
  labs(
    shape = "ICES Stocks, \n previous ICES categories", 
    color = "ICES Stock Areas Changed \n between current and previous assessments",
    x = "B/BMSY from Previous Assessment", 
    y = "B/BMSY from Current Assessment"
  )
compare_ffmsy_plot <- ggplot(compare_ffmsy) +
  geom_point(
    aes(x = prev_ffmsy, y = ffmsy, color = changed_assess_area, shape = stock), 
    size = 2, alpha = 0.6
  ) + 
  labs(
    x = "F/FMSY from Previous Assessment", 
    y = "F/FMSY from Current Assessment"
  ) + 
  theme(legend.position = "none")
gridExtra::grid.arrange(compare_ffmsy_plot, compare_bbmsy_plot, nrow = 1, widths = c(0.7, 1))
```


### 3.3 Status and trend options and calculation

Calculating status and trend consists of the following steps:
- calculate F-scores and B-scores
- take mean of F and B scores, with data grouped by region_id, stock, year
- derive weights from landings data (proportions of catch made up of different stocks in each region)
- apply a penalty because of bad cod condition in the eastern baltic
- calculate status as a geometric mean weighted by proportion of catch in each region

The formulas for calculating F and B scores are based on [this paper](https://doi.org/10.1371/journal.pone.0098995).


#### 3.3.1 Eastern Baltic cod condition penalty factor

```{r derive eastern baltic cod penalty factor}
## following method from in Casini et al. https://doi.org/10.1098/rsos.160416:
## individual body condition (Fulton's K) estimated as K = W/L3 × 100 
## W = the total weight (g) of the fish
## L = total length (cm) of the fish
## condition averaged per 10cm length-class for each SD, year, country
## lengths < 10 cm and ≥60 cm excluded-- not enough data
## focused on quarter 4 as it corresponds to the main feeding season

surveyBITS_cod <- read_csv(file.path(dir_rawdata, "SMALK_2019-10-22 16_34_01", "SMALK_2019-10-22 16_34_01.csv"))

q4_fultonsK <- surveyBITS_cod %>%
  mutate(length_cm = LngtClass/10) %>% 
  dplyr::select(year = Year, ices_subdiv = Area, country = Country, length_cm, wgt_gram = IndWgt) %>% 
  mutate(
    fultonsK = wgt_gram/(length_cm^3)*100,
    length_group = floor(length_cm/10)
  ) %>% 
  ## Casini et al excluded lengths < 10cm and ≥60cm-- not enough data:
  filter(length_group %in% 1:5) %>%
  filter(!is.na(fultonsK), fultonsK < 2) %>% 
  group_by(ices_subdiv, year, length_group) %>% 
  summarize(avg_cond = mean(fultonsK)) %>% 
  mutate(
    above_one = ifelse(avg_cond > 1, TRUE, FALSE), 
    above_pt9 = ifelse(avg_cond > 0.9, TRUE, FALSE)
  )

ggplot(data = q4_fultonsK) +
  geom_point(aes(x = year, y = avg_cond, color = above_pt9), size = 2, alpha = 0.6) +
  geom_line(aes(x = year, y = avg_cond)) +
  facet_grid(vars(length_group), vars(ices_subdiv)) +
  labs(x = NULL, y = "Condition (Fulton's K)\n", color = "Fulton's K > 0.9")

q4K_wTrends <- q4_fultonsK %>% 
  group_by(ices_subdiv, length_group) %>%
  do(
    yr_coeff = lm(avg_cond ~ year, data = .)$coefficients["year"] %>% unlist(),
    yr_int = lm(avg_cond ~ year, data = .)$coefficients["(Intercept)"] %>% unlist()
  ) %>% 
  unnest(yr_coeff, yr_int) %>% 
  right_join(q4_fultonsK, by = c("ices_subdiv", "length_group")) %>% 
  group_by(year) %>% 
  mutate(mean_yr_condition = mean(avg_cond)) %>% 
  ungroup() %>% 
  ## BHI1.0 prep gives formula penalty=condition/mean, but from the indicated data,
  ## penalty=condition*mean more closely matches the value in functions.R of 0.872 for yr2014
  ## BHI2.0 will use:
  mutate(penalty_factor = mean_yr_condition/max(mean_yr_condition))

q4K_wTrends$length_group <- as.factor(q4K_wTrends$length_group)
# mean(q4K_wTrends$avg_cond)
  
ggplot(q4K_wTrends, aes(x = year, y = avg_cond)) +
  geom_point(size = 4, alpha = 0.5, aes(color = ices_subdiv, shape = length_group)) +
  geom_line(aes(x = year, y = mean_yr_condition)) +
  labs(x = NULL, y = "Condition (Fulton's K)\n", color = "ICES Subdivision", shape = "Length Group")

cod_penalty <- dplyr::select(q4K_wTrends, year, penalty_factor) %>% distinct()
# plot(cod_penalty$year, cod_penalty$penalty_factor)
```


#### 3.3.2 Calculating Status and Trend

```{r calculate scores and trend to evaluate goal model and data}
## bind data layers
metric_scores <- left_join(
  fis_bbmsy, 
  fis_ffmsy,  
  by = c("region_id", "stock", "year"))

## B-SCORES
## calculate B-scores

## note: these parameters can be changed!
## view Bscores plot to evaluate/test different parameter values...
lowerB <- 1
upperB1 <- 2
upperB2 <- 4

B_scores <- metric_scores %>%
  mutate(
    score_type = "B_score",
    
    score = ifelse(
      bbmsy < lowerB, (1/lowerB)*bbmsy, # (rise/run)*x+intercept
      ifelse(
        lowerB <= bbmsy & bbmsy < upperB1, 1, 
        ifelse(
          bbmsy >= upperB1, 
          # y-y0=m(x-x0):(upperB1,1) and (upperB2,0) so m = (1-0)/(upperB1-upperB2)
          # (1/(upperB1-upperB2))*bbmsy + (upperB2/(upperB1-upperB2)) = 
          # (1/(upperB1-upperB2))*(bbmsy + upperB2)
          (bbmsy - upperB2)/(upperB1-upperB2), NA
        )
      )
    )
  ) %>% 
  mutate(
    score = ifelse(
      score <= 0.1, 0.1, 
      ifelse(score > 1, 1, score)
    )
  )
ggplot(data = B_scores, aes(bbmsy, score, color = bbmsy)) + geom_line() + 
  labs(title = "B-scores vs. B/BMSY values") + ylab(NULL) + xlab(NULL) +
  theme(legend.position = "none")


## F-SCORES
## calculate F-scores

## note: these parameters can be adjusted, as well as B-score parameters above 
## view Bscores and Fscores plots to evaluate/test different parameter values...
lowerF <- 0.7
upperF1 <- 1
upperF2 <- 1.3

## make it a function so can do full plot to explore parameters...
calcFscores <- function(input_data, bbmsy_col = "bbmsy", ffmsy_col = "ffmsy", 
                        lowerB = 0.8, lowerF = 0.8, upperF1 = 1.2, upperF2 = 2.5){
  
  ## from (0, 1), (lowerB, upperF2) -> (y-y1) = m(x-x1), m = (upperF2 - 1)/lowerB
  m = (upperF2-1)/lowerB
  
  # install.packages("pracma")
  norm1 = pracma::cross(
    c(lowerB, upperF1, 1) - c(0, 1, 0),
    c(lowerB, upperF2, 0) - c(0, 1, 0)
  )
  norm2 = pracma::cross(
    c(lowerB, 0, (upperF2-lowerF-1)/(upperF2-1)) - c(lowerB, lowerF, 1),
    c(0, 1-(upperF2-lowerF), 1) - c(lowerB, lowerF, 1)
  )
  
  ## PIECEWISE FORMULA...
  result <- input_data %>%
    mutate(
      score_type = "F_score",
      
      score = ifelse(
        ## when bbmsy < lowerB :
        bbmsy < lowerB,
        
        ## will be space near zero where scores start going back down from 1:
        ## on y-axis moving down towards zero if upperF2-lowF < 1
        ## on x-axis moving left towards zero if upperF2-upperF1 > 1
        ## as a result, when max non-zero score F is very high, it's likely even if F=0 score won't be 1
        ifelse(
          ffmsy > m*bbmsy + 1, 0,
          ifelse(
            m*bbmsy + 1 >= ffmsy & ffmsy > m*bbmsy + (1-(upperF2-upperF1)),
            ## n1x + n2y + n3z - (n1x0 + n2y0 + n3z0) = 0, ref: http://mathworld.wolfram.com/Plane.html
            (norm1[2] - norm1[1]*bbmsy - norm1[2]*ffmsy)/norm1[3],
            ifelse(
               m*bbmsy + (1-(upperF2-upperF1)) >= ffmsy & ffmsy > m*bbmsy + (1-(upperF2-lowerF)), 1,
               ((norm2[1]*lowerB + norm2[2]*lowerF + norm2[3]) - (norm2[1]*bbmsy + norm2[2]*ffmsy))/norm2[3]
            )
          )
        ),
        ## when bbmsy >= lowerB :
        ifelse(
           ffmsy > upperF1,
           (upperF2-ffmsy)/(upperF2-upperF1),
           ifelse(
             upperF1 >= ffmsy & ffmsy > lowerF, 
             1,
             ffmsy/(upperF2-1) + (upperF2-lowerF-1)/(upperF2-1)
           )
        )
      )
    ) %>% 
    ## change scores less than 0.1 to be 0.1, greater than 1 to be 1
    mutate(
      score = ifelse(
        score <= 0.1, 0.1,
        ifelse(score > 1, 1, score)
      )
    )
  return(result)
}

ffmsy_bbmsy_score <- calcFscores(
  input_data = expand.grid(
    ffmsy = seq(0, 3, length.out = 100), 
    bbmsy = seq(0, 3, length.out = 100)
  )
)
ggplot(data = ffmsy_bbmsy_score) +
  geom_tile(aes(bbmsy, ffmsy, fill = score)) +
  xlab("B/BMSY") + ylab("F/FMSY") + labs(fill = "F-Score\n")

F_scores <- calcFscores(metric_scores)

## average B-scores and F-scores to get overall score
## these averages will be weighted by stock landings and have cod condition penalty applied
scores <- rbind(B_scores, F_scores) %>%
  group_by(region_id, stock, year) %>%
  summarize(score = mean(score, na.rm = TRUE)) %>%  # hist(scores$score)
  left_join(
    spread(rbind(B_scores, F_scores), key = "score_type", value = "score"),
    by = c("year", "stock", "region_id")
  )

ggplot(scores, aes(x = year)) + 
  geom_ribbon(aes(ymin = F_score, ymax = B_score, fill = stock), alpha = 0.4) + 
  geom_line(aes(y = score, color = stock)) +
  facet_wrap(vars(region_id)) + 
  labs(color = "Stock", fill = "Stock")


## WEIGHTS
## calculate weights with landing data
## we use the average catch for each stock/region across all years to obtain weights

weights <- landings_all %>%
  filter(metric == "rgn_landings") %>% # ALTERNATE METHOD TO GET WEIGHTS FROM LANDINGS
  # filter(metric == "all_landings") %>% # BHI1.0 METHOD FOR LANDINGS -> WEIGHTS
  filter(year > max(year) - 10) %>% 
  dplyr::select(-ices_subdiv, landings = value, -metric) %>% 
  group_by(region_id, stock) %>% # each region/stock will have same avg catch across years
  mutate(avgCatch = mean(landings)) %>% # timeseries mean, considering last 10 years
  group_by(region_id, year) %>%
  mutate(totCatch = sum(avgCatch)) %>% # total (ie all stock) catch on average (across years)
  ungroup() %>%
  mutate(propCatch = avgCatch/totCatch) # proportion of catch each stock accounts for
## total proportion of landings for each region/year will sum to one
# chk <- weights_orig %>%
#   group_by(region_id, year) %>%
#   summarise(sumProps = sum(propCatch))
# unique(chk$sumProps)


## STATUS
## geometric mean weighted by proportion of catch in each region
status_with_penalty <- weights %>% 
  left_join(scores, by = c("region_id", "year", "stock")) %>%
  filter(!is.na(score)) %>% # remove missing data
  dplyr::select(region_id, year, stock, propCatch, score) %>% 
  
  ## apply penalty because bad cod condition in eastern baltic
  mutate(
    score = ifelse(
      str_detect(stock, "cod") & str_detect(stock, "32"),
      score*filter(cod_penalty, year == assess_year-1)$penalty_factor, score
    )
  )
status <- status_with_penalty %>% 
  group_by(region_id, year) %>%
  summarize(status_prop = prod(score^propCatch), status_avg = mean(score)) %>%
  ungroup()
```


### 3.4 Gapfilling

**This data processing for FIS and NP goals does not include any gapfilling or interpolation.**


### 3.5 Methods discussion

<br>

#### 3.5.1 Adjustment of Cod scores Based on Body Weight

Data source: [Casini M et al. 2016](http://dx.doi.org/10.1098/rsos.160416)
Data available: 1977 - 2014
Penalty factor (according to `bhi-1.0-archive/baltic2015/prep/FIS/fis_np_prep.Rmd`): cod_condition / mean_cod_condition

**[Paper](http://dx.doi.org/10.1098/rsos.160416) used for cod condition penalty factor only includes data through 2014.** Will need to recalculate penalty factor including most recent data, in future assessments, based on their methods. Additionally its **needs to be recorded in more detail transformations from [raw dataset](https://datadryad.org/stash/dataset/doi:10.5061/dryad.875fb) to condition_cod.csv to penalty factor.**


## 4. Visualizing Data Layers

Below are some maps visualizing a few of the intermediate datasets.  
Spatially, data inputs are the same value per year per stock, across the BHI regions in which the stock exists.  
BHI status and trend scores differ spatially across regions as they are combinations of multiple stocks status weighted by landings proportions.


### 4.1 Proportions of Total Catch over time

Of all the fisheries landings that occurred in a given area and year, what proportion is made up by each stock?

Note: different stocks are assessed in different groupings of ICES areas/subdivisions and thus do not always neatly overlap. 
What is called totalCatch below is the sum of cumulative catches of overlapping assessments -- these data are not spatially explicit! 

Mapping the ICES divisions to BHI regions involves an assumption of approx. spatially uniformity in catch (or that catch is equally split across the nested BHI regions...?)...
An approximated total catch is calculated below based on this assumption, for data presentation/exploration purposes.


```{r catch proportions plots}
## proportions of stocks by BHI region and year rather than as timeseries averages
yearly_rgn_props <- landings_all %>%
  filter(metric %in% c("landings_rate", "rgn_landings"), !str_detect(stock, "spr")) %>%
  spread(key = "metric", value = "value") %>% 
  group_by(region_id, year) %>% 
  mutate(
    rgn_yr_totCatch = sum(rgn_landings),
    landings_rateCumulative = sum(landings_rate)
  ) %>% 
  ungroup() %>%
  mutate(rgn_yr_propCatch = rgn_landings/rgn_yr_totCatch) %>% 
  filter(year >= max(landings_all$year) -10)

ggplot(filter(yearly_rgn_props, region_id %in% c(1, 3, 11, 14, 27, 37))) + # only 6 distinct zones created by assessment overlap
  geom_area(aes(x = year, y = rgn_yr_propCatch, fill = stock),  position = "stack", alpha =  0.8) + 
  scale_fill_brewer(palette = "Set3") +
  facet_wrap(~region_id, nrow = 2) + 
  ylab("proportion of stock to total catch per BHI region \n") + xlab(NULL)
```

<br>

### 4.2 Regional Proportions of Total Catch

```{r map values by bhi and ICES regions, results = "show"}
## wrangle mapping data
map_raw_data <- yearly_rgn_props %>% 
  filter(year == max(yearly_rgn_props$year)) %>%
  dplyr::select(-year, -species, -landings_rate, -rgn_landings) %>% 
  spread(key = "stock", value = "rgn_yr_propCatch")

## combine with spatial info for mapping
bhi_rgns_shp <- bhi_rgns_simple %>% 
  mutate(Name = paste(Subbasin, rgn_nam, sep = ", ")) %>% 
  left_join(map_raw_data, by = c("BHI_ID" = "region_id"))

## create color palettes
pal <- colorNumeric(
  palette = c(
    colorRampPalette(colors = c("#fffed8", "#c8e9b4"))(10),  
    colorRampPalette(colors = c("#c8e9b4", "#40b6c4"))(50),
    colorRampPalette(colors = c("#40b6c4", "#225ea8"))(15)
  ),
  na.color = "#fcfcfd",
  domain = seq(0.02, 0.98, 0.001)
)
pal_catch_rate <- colorNumeric(
    palette = colorRampPalette(colors = c("grey80", "grey40"))(40),
    na.color = "#fcfcfd",
    domain = c(0.5, 2)
)
pal_catch <- colorNumeric(
  palette = c(
      colorRampPalette(colors = c("grey100", "grey75"))(15),
      colorRampPalette(colors = c("grey75", "grey50"))(15),
      colorRampPalette(colors = c("grey50", "grey25"))(40)
    ),
    na.color = "#fcfcfd",
    domain = seq(0, 35E3, 1000)
)

## make map
props_catch_map <- leaflet::leaflet(data = bhi_rgns_shp) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(18, 59, zoom = 5)

groups <- c(
  "Cod SDs 22-24", "Cod SDs 24-32", 
  "Herring SDs 28.1 (Riga)", "Herring SDs 20-24", 
  "Herring SDs 25-29, 32","Herring SDs 30-31"
)

## add layers for all fisheries
for(i in 1:6){
  vars <- sym(c(
    "cod_SDs22_24", "cod_SDs24_32", 
    "herring_SD_28.1", "herring_SDs20_24", 
    "herring_SDs25_29_32", "herring_SDs30_31"
  )[i])
  props_catch_map <- props_catch_map %>% 
    addPolygons(
      stroke = TRUE, opacity = 0.3, weight = 1, fillOpacity = 0.8,
      fillColor = ~pal(bhi_rgns_shp[[vars]]), group = groups[i]
    ) %>% 
    addPolygons(
    popup = paste(
      "<h5><strong>", "Proportion of Total Catch:", "</strong>",
      round(bhi_rgns_shp[[vars]], 3), "</h5>", sep = " "
    ),
    fillOpacity = 0,
    stroke = FALSE,
    group =  groups[i]
  )
}
## add total catches layer and more formatting
props_catch_map %>%
  ## Catch Rate
  addPolygons(
    stroke = TRUE, opacity = 0.3, weight = 1, fillOpacity = 0.9,
    fillColor = ~pal_catch_rate(bhi_rgns_shp$landings_rateCumulative), group = "Region Estim. (tonnes/km2) Catch Rate"
  ) %>% 
  addPolygons(
    popup = paste(
      "<h5><strong>", bhi_rgns_shp$Name, "</strong>", "</h5>",
      "<h5><strong>", "ICES subdivision ", bhi_rgns_shp$ices_subdiv, "</h5>",
      "<h5><strong>", "Region Estim. (tonnes/km2) Catch Rate: ", "</strong>",
      format(round(bhi_rgns_shp$landings_rateCumulative, 3), big.mark = ","), "</h5>", sep = " "
    ),
    fillOpacity = 0,
    stroke = FALSE,
    group = "Region Estim. (tonnes/km2) Catch Rate"
  ) %>%
  ## total Catch
  addPolygons(
    stroke = TRUE, opacity = 0.3, weight = 1, fillOpacity = 0.9,
    fillColor = ~pal_catch(bhi_rgns_shp$rgn_yr_totCatch), group = "Region Estim. (tonnes) Catch"
  ) %>% 
  addPolygons(
    popup = paste(
      "<h5><strong>", bhi_rgns_shp$Name, "</strong>", "</h5>",
      "<h5><strong>", "ICES subdivision ", bhi_rgns_shp$ices_subdiv, "</h5>",
      "<h5><strong>", "Region Estim. (tonnes) Catch: ", "</strong>",
      format(round(bhi_rgns_shp$rgn_yr_totCatch), big.mark = ","), "</h5>", sep = " "
    ),
    fillOpacity = 0,
    stroke = FALSE,
    group = "Region Estim. (tonnes) Catch"
  ) %>%
  
  ## layer controls and legend
  addLayersControl(
    baseGroups = c(
      "Cod SDs 22-24", "Cod SDs 24-32",
      "Herring SDs 28.1 (Riga)", "Herring SDs 20-24", "Herring SDs 25-29, 32", "Herring SDs 30-31",
      "Region Estim. (tonnes/km2) Catch Rate", "Region Estim. (tonnes) Catch"
    ),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend("bottomright", pal, seq(0.02, 0.98, 0.001))
```

<br>

### 4.3 Timeseries plots of F/FMSY, B/BMSY, and Landings

```{r timeseries plots}
## msy_metrics_plot and landings_plot created in 'wrangle and save layers for FIS and NP goals' section above
gridExtra::grid.arrange(msy_metrics_plot, landings_plot, nrow = 1, widths = c(1.1, 1))
```

<br>

### 4.4 FIS Goal Status Map

```{r goal status map, results = "show"}
## combine with spatial info for mapping
bhi_rgns_shp <- bhi_rgns_shp %>% 
  dplyr::select(rgn_nam, rgn_key, Subbasin, HELCOM_ID, BHI_ID, Area_km2, Name) %>% 
  left_join(filter(status, year == max(scores$year)), by = c("BHI_ID" = "region_id"))
pal <- colorNumeric(
  palette = "RdYlBu", na.color = "#fcfcfd",
  domain = seq(0.4, 1, 0.005))

leaflet::leaflet(data = bhi_rgns_shp) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(18, 59, zoom = 5) %>% 
  addPolygons(
    stroke = TRUE, opacity = 0.3, weight = 1, fillOpacity = 0.7,
    fillColor = ~pal(status_prop)
  ) %>% 
  addPolygons(
    popup = paste(
      "<h5><strong>", "Region:", "</strong>",
      bhi_rgns_shp$Name, "</h5>",
      "<h5><strong>", "Status:", "</strong>",
      round(bhi_rgns_shp$status_prop, 2), "</h5>", sep = " "
    ),
    fillOpacity = 0,
    stroke = FALSE
  ) %>% 
  addPolygons(
    stroke = TRUE, opacity = 0.3, weight = 1, fillOpacity = 0.7,
    fillColor = ~pal(status_avg)
  ) %>% 
  addPolygons(
    popup = paste(
      "<h5><strong>", "Region:", "</strong>",
      bhi_rgns_shp$Name, "</h5>",
      "<h5><strong>", "Status:", "</strong>",
      round(bhi_rgns_shp$status_avg, 2), "</h5>", sep = " "
    ),
    fillOpacity = 0,
    stroke = FALSE
  ) %>% 
  ## layer controls and legend
  addLayersControl(
    baseGroups = c("Status weighted avg by catches", "Status weighted equally"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend("bottomright", pal, seq(0.4, 1, 0.005))
```

<br>

```{r References, child = refs_path, results = "asis", echo = FALSE}
```
