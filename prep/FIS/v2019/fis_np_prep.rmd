---
title: "Wild-Caught Fisheries - Food Provision Subgoal data prep"
output:
  github_document:
    toc: true
    toc_depth: 3
params: 
    datasource: csv
---

```{r Preamble}
loc <- file.path(here::here(), "prep", "FIS")

source(file.path(here::here(), "R", "setup.R"))
source(file.path(here::here(), "R", "prep.R"))
knitr::opts_chunk$set(message = FALSE, warning = FALSE, results = "hide")

bkgd_path <- file.path(here::here(), "supplement", "goal_summaries", "FIS.Rmd")
data_path <- file.path(here::here(), "data", "FIS", version_year, "fis_np_data.rmd")
refs_path <- file.path(loc, "fis_references.Rmd")
```

## 1. Background

```{r Background, child = bkgd_path, results = "asis", echo = FALSE}
```

<br/>

## 2. Data

```{r Data, child = data_path, results = "asis", echo = FALSE}
```

<br/>

## 3. Prep: Wrangling & Derivations, Checks/Evaluation, Gapfilling

This section prepares data layers for FIS and NP at the same time, separating the fish stocks for each:

- FIS stocks: cod_2224, cod_2532, her_3a22, her_2532, her_riga, her_30
- NP  stocks: spr_2232

```{r raw datasets, message = FALSE, warning = FALSE}
## root location of the raw data
dir_rawdata <- file.path(dir_B, "Goals", "FP", "FIS") # list.files(dir_rawdata)

## Fisheries data from ICES
## note if csvs are saved w/ semicolons, additional step may be needed to read columns...
# source(file.path(here::here(), "R", "semicolon_to_comma.R"))
# lapply(
#   list("cod_SDs22_24", "cod_SDs24_32",
#        "herring_SD_28.1", "herring_SDs20_24",
#        "herring_SDs25_29_32", "herring_SDs30_31"),
#   function(x){
#      fp <- file.path(dir_rawdata, x, paste0(x, "_reformat.csv"))
#      semicolon_to_comma(fp, remove_na_cols = TRUE, overwrite = TRUE)
#   }
# )
# semicolon_to_comma(file.path(dir_B, "Goals", "NP", "sprat_SDs22_32", "sprat_SDs22_32_reformat.csv"), TRUE, TRUE)

## cod data
cod1raw <- read_csv(file.path(dir_rawdata, "cod_SDs22_24", "cod_SDs22_24_reformat.csv"))
cod2raw <- read_csv(file.path(dir_rawdata, "cod_SDs24_32", "cod_SDs24_32_reformat.csv"))

## herring data
herring1raw <- read_csv(file.path(dir_rawdata, "herring_SD_28.1", "herring_SD_28.1_reformat.csv"))
herring2raw <- read_csv(file.path(dir_rawdata, "herring_SDs20_24", "herring_SDs20_24_reformat.csv"))
herring3raw <- read_csv(file.path(dir_rawdata, "herring_SDs25_29_32", "herring_SDs25_29_32_reformat.csv"))
herring4raw <- read_csv(file.path(dir_rawdata, "herring_SDs30_31", "herring_SDs30_31_reformat.csv"))

## sprat data
sprat1raw <- read_csv(file.path(dir_B, "Goals", "NP", "sprat_SDs22_32", "sprat_SDs22_32_reformat.csv"))

## make MSY values table
## these values are obtained from ICES reports, see data/FIS/fis_np_data.rmd
msy_data <- t(data.frame(
  c("cod", "22-24", "cod_SDs22_24", 21876, 0.26),
  c("cod", "24-32", "cod_SDs24_32", 108035, 0.3),
  c("herring", "28.1", "herring_SD_28.1", 60000, 0.32),
  c("herring", "20-24", "herring_SDs20_24", 150000, 0.31),
  c("herring", " 25-29,32", "herring_SDs25_29_32", 600000, 0.22),
  c("herring", "30-31", "herring_SDs30_31", 140998, 0.15),
  c("sprat", "22-32", "sprat_SDs22_32", 570000, 0.26)
))
colnames(msy_data) <- c("species", "SDs", "stockname", "BMSY", "FMSY")
rownames(msy_data) <- NULL
msy_data <- as_tibble(msy_data)

```

```{r calculate ffmsy and bbmsy ratios}
combined_rawdata <- rbind(
  cod1raw %>% 
    select(year, ssb, fis_mort = fishing_mortality_age3_5) %>%
    mutate(stockname = "cod_SDs22_24"),
  cod2raw %>% 
    select(year, ssb, fis_mort = fishing_mortality_age4_6) %>% 
    mutate(stockname = "cod_SDs24_32"),
  herring1raw %>% 
    select(year, ssb = ssb_tonnes, fis_mort = `F`) %>% 
    mutate(stockname = "herring_SD_28.1"),
  herring2raw %>% 
    select(year, ssb = ssb_tonnes, fis_mort = F_age3_6) %>% 
    mutate(stockname = "herring_SDs20_24"),
  herring3raw %>% 
    select(year, ssb = ssb_tonnes, fis_mort = F_age3_6) %>% 
    mutate(stockname = "herring_SDs25_29_32"),
  herring4raw %>% 
    select(year, ssb = ssb, fis_mort = F_age3_7) %>% 
    mutate(stockname = "herring_SDs30_31"),
  sprat1raw %>% 
    select(year, ssb = ssb_tonnes, fis_mort = F_age3_5) %>% 
    mutate(stockname = "sprat_SDs22_32")) %>% 
  
  filter(!is.na(year)) %>% 
  left_join(msy_data, by = c("stockname")) %>% 
  mutate(bbmsy = ssb/as.numeric(BMSY), ffmsy = fis_mort/as.numeric(FMSY)) %>% 
  arrange(species, stockname, year)
```


```{r converting ICES fisheries regions to Baltic regions}
## based on 'prep/FIS/raw/DataOrganization.R' in bhi-1.0-archive, by Melanie Frazier March 16 2016

regions <- read_csv(
  file.path(here::here(), "supplement", "lookup_tabs", "ices_to_bhi_lookup.csv"), 
  col_types = cols()) %>% 
  select(-ices_id)

combined_w_rgns <- combined_rawdata %>% 
  
  ## expand ices subdivisions categories to one row per subdiv
  rowwise() %>% 
  mutate(
    ## check unique(combined_rawdata$SDs) to make sure this will work
    sd_from = as.numeric(str_split(SDs, "-|,")[[1]][1]),
    sd_to = as.numeric(str_split(SDs, "-|,")[[1]][2]),
    sd_extra = as.numeric(str_split(SDs, "-|,")[[1]][3])
  ) %>% 
  mutate(
    sd_to = ifelse(is.na(sd_to), sd_from, sd_to),
    sd_extra = ifelse(is.na(sd_extra), sd_from, sd_extra)
  ) %>% 
  mutate(SDs = list(unique(c(sd_from:sd_to, sd_extra)))) %>% 
  tidyr::unnest(ices_subdiv = SDs) %>% 
  select(-sd_from, -sd_to, -sd_extra) %>% 
  
  ## add bhi regions info using ices_to_bhi_lookup
  left_join(
    regions, by = c("ices_subdiv" = "ices_numeric")
  ) %>% 
  arrange(species, stockname, region_id, year, ices_subdiv)
## full merged dataset with MSY and raw data, as well as calculated ratios
# write_csv(combined_w_rgns, file.path(loc, "intermediate", "full_merged_dataset.csv"))

wide_format_metrics <- combined_w_rgns %>% 
  select(region_id, stock = stockname, year, bbmsy, ffmsy) %>% 
  tidyr::gather(key = metric, value = value, -year, -stock, -region_id)
## full dataset in long format with calculated ratios, 
# write_csv(wide_format_metrics, file.path(loc, "intermediate", "fis_ffmsy_bbmsy.csv"))
```



### 3.1 Cod 
#### 3.1.1 Reorganizing/wrangling

```{r calculate scores & trend to evaluate goal model and data}

```

#### 3.1.2 Evaluate flagged data & sampling patterns
#### 3.1.3 Status and trend options and calculation
#### 3.1.4 Gapfilling
#### 3.1.5 Methods discussion
```{r calculate}

```


### 3.2 Herring
#### 3.2.1 Reorganizing/wrangling
#### 3.2.2 Evaluate flagged data & sampling patterns
#### 3.2.3 Status and trend options and calculation
#### 3.2.4 Gapfilling
#### 3.2.5 Methods discussion

### 3.3 Sprat
#### 3.3.1 Reorganizing/wrangling
#### 3.3.2 Evaluate flagged data & sampling patterns
#### 3.3.3 Status and trend options and calculation
#### 3.3.4 Gapfilling
#### 3.3.5 Methods discussion
<br/>

## 4. Visualizing Data Layers

<br/>

## 5. References

```{r References, child = refs_path, results = "asis", echo = FALSE}
```
